import { e as createComponent, r as renderTemplate, l as renderScript, m as maybeRenderHead, k as renderComponent } from '../chunks/astro/server_B9J4CstS.mjs';
import { $ as $$AuthGuard } from '../chunks/AuthGuard_C1CbjEAT.mjs';
/* empty css                                 */
export { renderers } from '../renderers.mjs';

var __freeze = Object.freeze;
var __defProp = Object.defineProperty;
var __template = (cooked, raw) => __freeze(__defProp(cooked, "raw", { value: __freeze(raw || cooked.slice()) }));
var _a;
const $$Index = createComponent(async ($$result, $$props, $$slots) => {
  return renderTemplate(_a || (_a = __template(["", ' <meta charset="utf-8"> <link rel="icon" type="image/svg+xml" href="/favicon.svg"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Sistema de Gesti\xF3n de Canchas - AngloAmerican</title> <!-- Chart.js para gr\xE1ficos de perfil --> ', "   <!-- SheetJS library para procesar archivos Excel/CSV --> ", " ", '<div class="header" data-astro-cid-j7pv25f6> <!-- Logos de empresas (comentado temporalmente) --> <!--\n      <div class="logos-container">\n        <img title="Besalco" width="280" height="60" src="/Besalco.png" alt="Besalco" class="company-logo">\n        <img title="Linkapsis" width="280" height="60" src="/Linkapsis.png" alt="Linkapsis" class="company-logo">\n        <img title="AngloAmerican" width="280" height="60" src="/AngloAmerican.png" alt="AngloAmerican" class="company-logo">\n        <img title="LlayLlay" width="80" height="80" src="/LlayLlay.png" alt="LlayLlay" class="company-logo">\n      </div>\n      --> <canvas id="particles-canvas" data-astro-cid-j7pv25f6></canvas> <h1 data-astro-cid-j7pv25f6>Gesti\xF3n de Canchas AngloAmerican - Las T\xF3rtolas</h1> </div> <div class="container" data-astro-cid-j7pv25f6> <div id="mensaje-container" data-astro-cid-j7pv25f6></div> <!-- Pantalla Principal --> <div id="main-screen" data-astro-cid-j7pv25f6> <!-- Header de usuario logueado --> <div class="empresa-header" id="user-header" data-astro-cid-j7pv25f6> <div class="empresa-info" data-astro-cid-j7pv25f6> <span class="empresa-nombre" id="user-name" data-astro-cid-j7pv25f6>Cargando usuario...</span> <span class="empresa-rol" id="user-role" data-astro-cid-j7pv25f6>Verificando permisos...</span> </div> <div class="header-buttons" data-astro-cid-j7pv25f6> <div id="user-company" class="empresa-actual" data-astro-cid-j7pv25f6> <img id="user-company-logo" src="" alt="Logo Empresa" style="display: none;" data-astro-cid-j7pv25f6> </div> <button id="btn-abrir-modal-crear" type="button" class="header-btn header-btn-create" style="display: none;" data-astro-cid-j7pv25f6>\u{1F3D7}\uFE0F Crear Cancha</button> <a id="btn-admin-usuarios" href="/admin/usuarios" class="header-btn header-btn-admin" style="display: none;" data-astro-cid-j7pv25f6>\u{1F465} Gesti\xF3n Usuarios</a> <!-- === BOTONES ESPECIALES PARA LINKAPSIS === --> <!-- \n              Estos botones solo se muestran cuando el usuario logueado es de Linkapsis.\n              Permiten funcionalidades especiales de carga de datos:\n              - Subir Revanchas: Modal para cargar informaci\xF3n de revanchas\n              - Subir Canchas: Modal para cargar informaci\xF3n masiva de canchas\n            --> <button id="btn-subir-revanchas" type="button" class="header-btn header-btn-linkapsis" style="display: none;" data-astro-cid-j7pv25f6>\u{1F4E4} Subir Revanchas</button> <button id="btn-subir-canchas" type="button" class="header-btn header-btn-linkapsis" style="display: none;" data-astro-cid-j7pv25f6>\u{1F4C1} Subir Canchas</button> <button id="btn-logout" type="button" class="header-btn header-btn-logout" data-astro-cid-j7pv25f6>Cerrar Sesi\xF3n</button> </div> </div> <!-- Controles y Filtros --> <div class="controls" data-astro-cid-j7pv25f6> <!-- Filtros --> <!-- Filtros --> <div class="filtros-container" data-astro-cid-j7pv25f6> <h3 data-astro-cid-j7pv25f6>Filtros</h3> <!-- Layout principal con controles a la izquierda y stats a la derecha --> <div class="filtros-main-layout" data-astro-cid-j7pv25f6> <!-- Controles de filtros --> <div class="filtros-controls" data-astro-cid-j7pv25f6> <div class="filtros-row" data-astro-cid-j7pv25f6> <div class="filtro-group" data-astro-cid-j7pv25f6> <label data-astro-cid-j7pv25f6>Vista:</label> <div class="toggle-container" data-astro-cid-j7pv25f6> <div class="toggle-slider" data-astro-cid-j7pv25f6></div> <button id="btn-vista-acciones" class="toggle-btn active" data-astro-cid-j7pv25f6>Mis Acciones</button> <button id="btn-vista-historico" class="toggle-btn" data-astro-cid-j7pv25f6>Ver Hist\xF3rico</button> </div> </div> <div class="filtro-group" data-astro-cid-j7pv25f6> <label for="filtro-fecha" data-astro-cid-j7pv25f6>Filtro de Fecha:</label> <select id="filtro-fecha" data-astro-cid-j7pv25f6> <option value="all" data-astro-cid-j7pv25f6>Todas las fechas</option> <option value="today" data-astro-cid-j7pv25f6>Hoy</option> <option value="week" data-astro-cid-j7pv25f6>\xDAltima semana</option> <option value="month" data-astro-cid-j7pv25f6>\xDAltimo mes</option> <option value="custom" data-astro-cid-j7pv25f6>Rango personalizado</option> </select> </div> <div id="rango-fechas" class="filtro-group rango-fechas hidden" data-astro-cid-j7pv25f6> <label data-astro-cid-j7pv25f6>Desde:</label> <input type="date" id="fecha-desde" data-astro-cid-j7pv25f6> <label data-astro-cid-j7pv25f6>Hasta:</label> <input type="date" id="fecha-hasta" data-astro-cid-j7pv25f6> <button id="btn-aplicar-rango" type="button" data-astro-cid-j7pv25f6>Aplicar</button> </div> </div> </div> <!-- Dashboard de Estad\xEDsticas en sidebar --> <div class="stats-sidebar" data-astro-cid-j7pv25f6> <div class="stat-card stat-primary" data-astro-cid-j7pv25f6> <div class="stat-icon" data-astro-cid-j7pv25f6>\u2699\uFE0F</div> <div class="stat-number" id="stat-acciones" data-astro-cid-j7pv25f6>-</div> <div class="stat-label" data-astro-cid-j7pv25f6>Acciones Disponibles</div> </div> <div class="stat-card stat-info" data-astro-cid-j7pv25f6> <div class="stat-icon" data-astro-cid-j7pv25f6>\u{1F4CB}</div> <div class="stat-number" id="stat-total" data-astro-cid-j7pv25f6>-</div> <div class="stat-label" data-astro-cid-j7pv25f6>Total de Canchas</div> </div> </div> </div> </div> </div> <!-- Tabla de canchas --> <div class="table-container" data-astro-cid-j7pv25f6> <table data-astro-cid-j7pv25f6> <thead data-astro-cid-j7pv25f6> <tr data-astro-cid-j7pv25f6> <th style="width: 50px;" data-astro-cid-j7pv25f6> <input type="checkbox" id="select-all-checkbox" title="Seleccionar todas" data-astro-cid-j7pv25f6> </th> <th data-astro-cid-j7pv25f6>Nombre de Cancha</th> <th data-astro-cid-j7pv25f6>Estado Actual</th> <th data-astro-cid-j7pv25f6>Empresa Actual</th> <th data-astro-cid-j7pv25f6>Fecha Creaci\xF3n</th> <th data-astro-cid-j7pv25f6>Mapa</th> <th data-astro-cid-j7pv25f6>Acciones</th> </tr> </thead> <tbody id="canchas-tbody" data-astro-cid-j7pv25f6> <!-- Las canchas se cargar\xE1n din\xE1micamente --> </tbody> </table> <!-- Controles de paginaci\xF3n --> <div class="pagination-container" data-astro-cid-j7pv25f6> <div class="pagination-info" data-astro-cid-j7pv25f6>\nMostrando <span id="pagination-start" data-astro-cid-j7pv25f6>0</span> - <span id="pagination-end" data-astro-cid-j7pv25f6>0</span> de <span id="pagination-total" data-astro-cid-j7pv25f6>0</span> canchas\n</div> <div class="pagination-controls" data-astro-cid-j7pv25f6> <button id="btn-primera-pagina" class="pagination-btn" title="Primera p\xE1gina" data-astro-cid-j7pv25f6>&laquo;</button> <button id="btn-pagina-anterior" class="pagination-btn" title="P\xE1gina anterior" data-astro-cid-j7pv25f6>&lsaquo;</button> <span class="pagination-current" data-astro-cid-j7pv25f6>\nP\xE1gina <span id="pagina-actual" data-astro-cid-j7pv25f6>1</span> de <span id="total-paginas" data-astro-cid-j7pv25f6>1</span> </span> <button id="btn-pagina-siguiente" class="pagination-btn" title="P\xE1gina siguiente" data-astro-cid-j7pv25f6>&rsaquo;</button> <button id="btn-ultima-pagina" class="pagination-btn" title="\xDAltima p\xE1gina" data-astro-cid-j7pv25f6>&raquo;</button> </div> </div> </div> </div> <!-- === BOT\xD3N FLOTANTE DE ACCIONES MASIVAS === --> <div id="bulk-actions-bar" class="bulk-actions-bar hidden" data-astro-cid-j7pv25f6> <div class="bulk-actions-content" data-astro-cid-j7pv25f6> <span id="selected-count" class="selected-count" data-astro-cid-j7pv25f6>0 canchas seleccionadas</span> <div class="bulk-actions-buttons" data-astro-cid-j7pv25f6> <button id="btn-bulk-timeline" class="btn-bulk-action btn-bulk-timeline" title="Ver timeline de canchas seleccionadas" data-astro-cid-j7pv25f6>\n\u{1F4CA} Ver Timeline\n</button> <button id="btn-bulk-delete" class="btn-bulk-action btn-bulk-delete hidden" title="Borrar canchas seleccionadas" data-astro-cid-j7pv25f6>\n\u{1F5D1}\uFE0F Borrar Seleccionadas\n</button> <!-- Espacio para futuros botones de acciones masivas --> </div> <button id="btn-clear-selection" class="btn-clear-selection" title="Limpiar selecci\xF3n" data-astro-cid-j7pv25f6>\n\u2716 Limpiar\n</button> </div> </div> <!-- === DASHBOARD DE ESTADOS === --> <div class="dashboard-estados-section" data-astro-cid-j7pv25f6> <div class="dashboard-estados-header" data-astro-cid-j7pv25f6> <h3 class="dashboard-estados-title" data-astro-cid-j7pv25f6>\u{1F4CA} Estados de Canchas</h3> </div> <div class="dashboard-estados" data-astro-cid-j7pv25f6> <div class="estado-widget" data-estado="creada" data-astro-cid-j7pv25f6> <div class="widget-circle widget-creada" data-astro-cid-j7pv25f6> <span class="widget-number" id="count-creada" data-astro-cid-j7pv25f6>0</span> </div> <div class="widget-label" data-astro-cid-j7pv25f6>Creada</div> </div> <div class="estado-widget" data-estado="en-espera" data-astro-cid-j7pv25f6> <div class="widget-circle widget-en-espera" data-astro-cid-j7pv25f6> <span class="widget-number" id="count-en-espera" data-astro-cid-j7pv25f6>0</span> </div> <div class="widget-label" data-astro-cid-j7pv25f6>En Espera</div> </div> <div class="estado-widget" data-estado="en-proceso" data-astro-cid-j7pv25f6> <div class="widget-circle widget-en-proceso" data-astro-cid-j7pv25f6> <span class="widget-number" id="count-en-proceso" data-astro-cid-j7pv25f6>0</span> </div> <div class="widget-label" data-astro-cid-j7pv25f6>En Proceso</div> </div> <div class="estado-widget" data-estado="validada" data-astro-cid-j7pv25f6> <div class="widget-circle widget-validada" data-astro-cid-j7pv25f6> <span class="widget-number" id="count-validada" data-astro-cid-j7pv25f6>0</span> </div> <div class="widget-label" data-astro-cid-j7pv25f6>Validada</div> </div> <div class="estado-widget" data-estado="rechazada-en-espera" data-astro-cid-j7pv25f6> <div class="widget-circle widget-rechazada-en-espera" data-astro-cid-j7pv25f6> <span class="widget-number" id="count-rechazada-en-espera" data-astro-cid-j7pv25f6>0</span> </div> <div class="widget-label" data-astro-cid-j7pv25f6>Rechazada, en Espera</div> </div> <div class="estado-widget" data-estado="cerrada" data-astro-cid-j7pv25f6> <div class="widget-circle widget-cerrada" data-astro-cid-j7pv25f6> <span class="widget-number" id="count-cerrada" data-astro-cid-j7pv25f6>0</span> </div> <div class="widget-label" data-astro-cid-j7pv25f6>Cerrada</div> </div> </div> </div> <!-- === MAPA DASHBOARD === --> <div class="dashboard-map-section" data-astro-cid-j7pv25f6> <div class="dashboard-map-header" data-astro-cid-j7pv25f6> <div class="map-header-left" data-astro-cid-j7pv25f6> <h3 class="dashboard-map-title" data-astro-cid-j7pv25f6>\u{1F5FA}\uFE0F Vista de Mapa</h3> <p class="dashboard-map-subtitle" id="map-subtitle" data-astro-cid-j7pv25f6>\nMostrando todas las canchas\n</p> </div> <div class="map-header-controls" data-astro-cid-j7pv25f6> <!-- Filtro de Muros --> <div class="map-filter-group" data-astro-cid-j7pv25f6> <label for="map-muro-filter" class="filter-label" data-astro-cid-j7pv25f6>Muro:</label> <select id="map-muro-filter" class="map-filter-select" data-astro-cid-j7pv25f6> <option value="" data-astro-cid-j7pv25f6>Todos</option> <option value="Principal" data-astro-cid-j7pv25f6>Principal</option> <option value="Este" data-astro-cid-j7pv25f6>Este</option> <option value="Oeste" data-astro-cid-j7pv25f6>Oeste</option> </select> </div> <!-- Toggle Revanchas --> <div class="map-toggle-group" data-astro-cid-j7pv25f6> <label class="toggle-switch" data-astro-cid-j7pv25f6> <input type="checkbox" id="toggle-revanchas" data-astro-cid-j7pv25f6> <span class="toggle-slider-round" data-astro-cid-j7pv25f6></span> </label> <span class="toggle-label" data-astro-cid-j7pv25f6>Revanchas</span> </div> </div> </div> <div class="dashboard-map-container" id="dashboard-map-container" data-astro-cid-j7pv25f6> <div class="dashboard-map-loading" data-astro-cid-j7pv25f6>Cargando mapa...</div> </div> </div> <!-- Modal para validaci\xF3n de Linkapsis (Espesores) --> <div id="validacion-linkapsis-modal" class="modal" data-astro-cid-j7pv25f6> <div class="modal-content" data-astro-cid-j7pv25f6> <div class="modal-header" data-astro-cid-j7pv25f6> <h3 class="modal-title" data-astro-cid-j7pv25f6>Validaci\xF3n de Espesores - Linkapsis</h3> <button class="close-btn" data-astro-cid-j7pv25f6>\xD7</button> </div> <!-- Historial de observaciones anteriores --> <div id="historial-linkapsis" class="historial-observaciones" data-astro-cid-j7pv25f6> <h4 data-astro-cid-j7pv25f6>Observaciones del Proceso:</h4> <div class="historial-content" data-astro-cid-j7pv25f6> <p data-astro-cid-j7pv25f6>Cargando historial...</p> </div> </div> <form id="form-validacion-linkapsis" data-astro-cid-j7pv25f6> <div class="form-group" data-astro-cid-j7pv25f6> <label for="linkapsis-observaciones" data-astro-cid-j7pv25f6>Observaciones:</label> <textarea id="linkapsis-observaciones" placeholder="Ingresa observaciones sobre la validaci\xF3n..." required data-astro-cid-j7pv25f6></textarea> </div> <div class="form-group" data-astro-cid-j7pv25f6> <label for="linkapsis-espesor" data-astro-cid-j7pv25f6>Medici\xF3n de Espesor (metros):</label> <input type="number" id="linkapsis-espesor" placeholder="Ej: 0.03" min="0" step="0.001" required data-astro-cid-j7pv25f6> <small data-astro-cid-j7pv25f6>Ingresa la medici\xF3n en metros (ej: 0.03)</small> </div> <!-- Tipo de Trabajo --> <div class="form-group" data-astro-cid-j7pv25f6> <label data-astro-cid-j7pv25f6>Tipo de Trabajo:</label> <div class="checkbox-group" data-astro-cid-j7pv25f6> <label class="checkbox-item" data-astro-cid-j7pv25f6> <input type="checkbox" id="trabajo-corte" name="tipo-trabajo" value="corte" data-astro-cid-j7pv25f6> <span data-astro-cid-j7pv25f6>Corte</span> </label> <label class="checkbox-item" data-astro-cid-j7pv25f6> <input type="checkbox" id="trabajo-relleno" name="tipo-trabajo" value="relleno" data-astro-cid-j7pv25f6> <span data-astro-cid-j7pv25f6>Relleno</span> </label> </div> </div> <!-- Coordenadas de Puntos --> <div class="form-group" data-astro-cid-j7pv25f6> <label data-astro-cid-j7pv25f6>Coordenadas de Puntos:</label> <div class="coordenadas-grid" data-astro-cid-j7pv25f6> <!-- Punto 1 --> <div class="punto-section" data-astro-cid-j7pv25f6> <h5 data-astro-cid-j7pv25f6>Punto 1</h5> <div class="coordenadas-row" data-astro-cid-j7pv25f6> <div class="coord-field" data-astro-cid-j7pv25f6> <label for="p1-norte" data-astro-cid-j7pv25f6>Norte:</label> <input type="number" id="p1-norte" placeholder="Norte P1" step="0.001" data-astro-cid-j7pv25f6> </div> <div class="coord-field" data-astro-cid-j7pv25f6> <label for="p1-este" data-astro-cid-j7pv25f6>Este:</label> <input type="number" id="p1-este" placeholder="Este P1" step="0.001" data-astro-cid-j7pv25f6> </div> <div class="coord-field" data-astro-cid-j7pv25f6> <label for="p1-cota" data-astro-cid-j7pv25f6>Cota:</label> <input type="number" id="p1-cota" placeholder="Cota P1" step="0.001" data-astro-cid-j7pv25f6> </div> </div> </div> <!-- Punto 2 --> <div class="punto-section" data-astro-cid-j7pv25f6> <h5 data-astro-cid-j7pv25f6>Punto 2</h5> <div class="coordenadas-row" data-astro-cid-j7pv25f6> <div class="coord-field" data-astro-cid-j7pv25f6> <label for="p2-norte" data-astro-cid-j7pv25f6>Norte:</label> <input type="number" id="p2-norte" placeholder="Norte P2" step="0.001" data-astro-cid-j7pv25f6> </div> <div class="coord-field" data-astro-cid-j7pv25f6> <label for="p2-este" data-astro-cid-j7pv25f6>Este:</label> <input type="number" id="p2-este" placeholder="Este P2" step="0.001" data-astro-cid-j7pv25f6> </div> <div class="coord-field" data-astro-cid-j7pv25f6> <label for="p2-cota" data-astro-cid-j7pv25f6>Cota:</label> <input type="number" id="p2-cota" placeholder="Cota P2" step="0.001" data-astro-cid-j7pv25f6> </div> </div> </div> <!-- Punto 3 --> <div class="punto-section" data-astro-cid-j7pv25f6> <h5 data-astro-cid-j7pv25f6>Punto 3</h5> <div class="coordenadas-row" data-astro-cid-j7pv25f6> <div class="coord-field" data-astro-cid-j7pv25f6> <label for="p3-norte" data-astro-cid-j7pv25f6>Norte:</label> <input type="number" id="p3-norte" placeholder="Norte P3" step="0.001" data-astro-cid-j7pv25f6> </div> <div class="coord-field" data-astro-cid-j7pv25f6> <label for="p3-este" data-astro-cid-j7pv25f6>Este:</label> <input type="number" id="p3-este" placeholder="Este P3" step="0.001" data-astro-cid-j7pv25f6> </div> <div class="coord-field" data-astro-cid-j7pv25f6> <label for="p3-cota" data-astro-cid-j7pv25f6>Cota:</label> <input type="number" id="p3-cota" placeholder="Cota P3" step="0.001" data-astro-cid-j7pv25f6> </div> </div> </div> <!-- Punto 4 --> <div class="punto-section" data-astro-cid-j7pv25f6> <h5 data-astro-cid-j7pv25f6>Punto 4</h5> <div class="coordenadas-row" data-astro-cid-j7pv25f6> <div class="coord-field" data-astro-cid-j7pv25f6> <label for="p4-norte" data-astro-cid-j7pv25f6>Norte:</label> <input type="number" id="p4-norte" placeholder="Norte P4" step="0.001" data-astro-cid-j7pv25f6> </div> <div class="coord-field" data-astro-cid-j7pv25f6> <label for="p4-este" data-astro-cid-j7pv25f6>Este:</label> <input type="number" id="p4-este" placeholder="Este P4" step="0.001" data-astro-cid-j7pv25f6> </div> <div class="coord-field" data-astro-cid-j7pv25f6> <label for="p4-cota" data-astro-cid-j7pv25f6>Cota:</label> <input type="number" id="p4-cota" placeholder="Cota P4" step="0.001" data-astro-cid-j7pv25f6> </div> </div> </div> </div> </div> <div class="form-actions" data-astro-cid-j7pv25f6> <button type="button" class="btn-cancel" data-astro-cid-j7pv25f6>Cancelar</button> <button type="submit" class="btn-validar" data-astro-cid-j7pv25f6>Validar Espesores</button> <button type="button" class="btn-rechazar" data-astro-cid-j7pv25f6>Rechazar</button> </div> </form> </div> </div> <!-- Modal para validaci\xF3n de LlayLlay (Densidad) --> <!-- Modal de RECEPCI\xD3N de trabajo para Besalco --> <div id="recepcion-besalco-modal" class="modal" data-astro-cid-j7pv25f6> <div class="modal-content" data-astro-cid-j7pv25f6> <div class="modal-header" data-astro-cid-j7pv25f6> <h3 class="modal-title" data-astro-cid-j7pv25f6>\u{1F4CB} Recepci\xF3n de Trabajo - Besalco</h3> <button class="close-btn" data-astro-cid-j7pv25f6>\xD7</button> </div> <!-- Historial de observaciones (solo lectura) --> <div id="historial-recepcion-besalco" class="historial-observaciones" data-astro-cid-j7pv25f6> <h4 data-astro-cid-j7pv25f6>Observaciones del Proceso:</h4> <div class="historial-content" data-astro-cid-j7pv25f6> <p data-astro-cid-j7pv25f6>Cargando historial...</p> </div> </div> <div style="padding: 1rem; background: #e8f4f8; border-left: 4px solid #3498db; border-radius: 4px; margin: 1rem 0;" data-astro-cid-j7pv25f6> <p style="margin: 0; color: #2c3e50;" data-astro-cid-j7pv25f6> <strong data-astro-cid-j7pv25f6>Modo Recepci\xF3n:</strong> Revise el trabajo anterior y presione\n              "Comenzar Trabajo" para iniciar la validaci\xF3n.\n</p> </div> <div class="form-actions" style="justify-content: center;" data-astro-cid-j7pv25f6> <button type="button" class="btn-cancel" data-astro-cid-j7pv25f6>Cancelar</button> <button type="button" class="btn-comenzar" id="btn-comenzar-besalco" data-astro-cid-j7pv25f6>\u{1F680} Comenzar Trabajo</button> </div> </div> </div> <!-- Modal de RECEPCI\xD3N de trabajo para Linkapsis --> <div id="recepcion-linkapsis-modal" class="modal" data-astro-cid-j7pv25f6> <div class="modal-content" data-astro-cid-j7pv25f6> <div class="modal-header" data-astro-cid-j7pv25f6> <h3 class="modal-title" data-astro-cid-j7pv25f6>\u{1F4CB} Recepci\xF3n de Trabajo - Linkapsis</h3> <button class="close-btn" data-astro-cid-j7pv25f6>\xD7</button> </div> <!-- Historial de observaciones (solo lectura) --> <div id="historial-recepcion-linkapsis" class="historial-observaciones" data-astro-cid-j7pv25f6> <h4 data-astro-cid-j7pv25f6>Observaciones del Proceso:</h4> <div class="historial-content" data-astro-cid-j7pv25f6> <p data-astro-cid-j7pv25f6>Cargando historial...</p> </div> </div> <div style="padding: 1rem; background: #e8f4f8; border-left: 4px solid #3498db; border-radius: 4px; margin: 1rem 0;" data-astro-cid-j7pv25f6> <p style="margin: 0; color: #2c3e50;" data-astro-cid-j7pv25f6> <strong data-astro-cid-j7pv25f6>Modo Recepci\xF3n:</strong> Revise el trabajo anterior y presione\n              "Comenzar Trabajo" para iniciar la validaci\xF3n de espesores.\n</p> </div> <div class="form-actions" style="justify-content: center;" data-astro-cid-j7pv25f6> <button type="button" class="btn-cancel" data-astro-cid-j7pv25f6>Cancelar</button> <button type="button" class="btn-comenzar" id="btn-comenzar-linkapsis" data-astro-cid-j7pv25f6>\u{1F680} Comenzar Trabajo</button> </div> </div> </div> <!-- ========================================== --> <!-- MODALES ESPECIALES PARA LINKAPSIS          --> <!-- ========================================== --> <!-- \n        Estos modales est\xE1n preparados para funcionalidades especiales de Linkapsis:\n        1. Modal Subir Revanchas: Para cargar informaci\xF3n de revanchas\n        2. Modal Subir Canchas: Para carga masiva de canchas\n        \n        ESTADO ACTUAL: Estructura base creada, lista para desarrollo\n        TODO: Implementar formularios y l\xF3gica de procesamiento de datos\n      --> <!-- Modal para Subir Revanchas (Linkapsis) --> <div id="modal-subir-revanchas" class="modal" data-astro-cid-j7pv25f6> <div class="modal-content modal-large" data-astro-cid-j7pv25f6> <div class="modal-header" data-astro-cid-j7pv25f6> <h3 class="modal-title" data-astro-cid-j7pv25f6>\u{1F4E4} Subir Revanchas - Linkapsis</h3> <button class="close-btn" data-astro-cid-j7pv25f6>\xD7</button> </div> <div class="modal-body" data-astro-cid-j7pv25f6> <!-- Selector de Tipo de Muro --> <div class="form-group" data-astro-cid-j7pv25f6> <label for="tipo-muro-revanchas" data-astro-cid-j7pv25f6> <strong data-astro-cid-j7pv25f6>Tipo de Muro:</strong> </label> <select id="tipo-muro-revanchas" class="form-select" data-astro-cid-j7pv25f6> <option value="" data-astro-cid-j7pv25f6>Seleccione un muro...</option> <option value="principal" data-astro-cid-j7pv25f6>Muro Principal</option> <option value="oeste" data-astro-cid-j7pv25f6>Muro Oeste</option> <option value="este" data-astro-cid-j7pv25f6>Muro Este</option> </select> <small style="color: #64748b; display: block; margin-top: 0.5rem;" data-astro-cid-j7pv25f6>\nSeleccione el tipo de muro antes de cargar el archivo\n</small> </div> <!-- Selector de Archivo --> <div class="form-group" data-astro-cid-j7pv25f6> <label for="file-revanchas" data-astro-cid-j7pv25f6> <strong data-astro-cid-j7pv25f6>Archivo de Revanchas:</strong> </label> <input type="file" id="file-revanchas" accept=".csv,.xlsx,.xls" disabled style="padding: 0.75rem; border: 2px dashed #cbd5e1; border-radius: 8px; background: #f8fafc; cursor: pointer;" data-astro-cid-j7pv25f6> <small style="color: #64748b; display: block; margin-top: 0.5rem;" data-astro-cid-j7pv25f6>\nFormatos soportados: CSV, XLSX, XLS\n</small> </div> <!-- Mensajes de Error/Info --> <div id="mensaje-revanchas" style="display:none; padding: 1rem; border-radius: 8px; margin: 1rem 0;" data-astro-cid-j7pv25f6></div> <!-- \xC1rea de Preview --> <div id="preview-revanchas" style="display:none; margin-top: 1.5rem;" data-astro-cid-j7pv25f6> <h4 style="color: #1e293b; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;" data-astro-cid-j7pv25f6> <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-astro-cid-j7pv25f6> <path d="M9 11l3 3L22 4" data-astro-cid-j7pv25f6></path> <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11" data-astro-cid-j7pv25f6></path> </svg>\nVista Previa de Datos\n</h4> <div id="info-archivo-revanchas" style="background: #f0f9ff; border-left: 4px solid #3b82f6; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;" data-astro-cid-j7pv25f6></div> <div id="tabla-revanchas" style="overflow-x: auto; max-height: 500px; border: 1px solid #e2e8f0; border-radius: 8px;" data-astro-cid-j7pv25f6></div> </div> </div> <div class="form-actions" data-astro-cid-j7pv25f6> <button type="button" class="btn-cancel" data-astro-cid-j7pv25f6>Cancelar</button> <button type="button" id="btn-procesar-revanchas" class="btn-primary" disabled style="opacity: 0.5;" data-astro-cid-j7pv25f6>\nProcesar Datos\n</button> </div> </div> </div> <!-- Modal para Subir Canchas (Linkapsis) --> <div id="modal-subir-canchas" class="modal" data-astro-cid-j7pv25f6> <div class="modal-content modal-large" data-astro-cid-j7pv25f6> <div class="modal-header" data-astro-cid-j7pv25f6> <h3 class="modal-title" data-astro-cid-j7pv25f6>\u{1F4C1} Subir Canchas - Linkapsis</h3> <button class="close-btn" data-astro-cid-j7pv25f6>\xD7</button> </div> <div class="modal-body" data-astro-cid-j7pv25f6> <form id="form-subir-canchas" data-astro-cid-j7pv25f6> <!-- Fila 1: Muro y Sector --> <div class="form-row" data-astro-cid-j7pv25f6> <div class="form-group" data-astro-cid-j7pv25f6> <label for="muro-cancha" data-astro-cid-j7pv25f6> <strong data-astro-cid-j7pv25f6>Muro *</strong> </label> <select id="muro-cancha" required data-astro-cid-j7pv25f6> <option value="" data-astro-cid-j7pv25f6>Seleccione...</option> <option value="Principal" data-astro-cid-j7pv25f6>Principal</option> <option value="Este" data-astro-cid-j7pv25f6>Este</option> <option value="Oeste" data-astro-cid-j7pv25f6>Oeste</option> </select> </div> <div class="form-group" data-astro-cid-j7pv25f6> <label for="sector-cancha" data-astro-cid-j7pv25f6> <strong data-astro-cid-j7pv25f6>Sector *</strong> </label> <select id="sector-cancha" disabled required data-astro-cid-j7pv25f6> <option value="" data-astro-cid-j7pv25f6>Seleccione muro primero...</option> </select> </div> </div> <!-- Fila 2: Relleno y Fecha --> <div class="form-row" data-astro-cid-j7pv25f6> <div class="form-group" data-astro-cid-j7pv25f6> <label for="relleno-cancha" data-astro-cid-j7pv25f6> <strong data-astro-cid-j7pv25f6>Relleno *</strong> </label> <input type="text" id="relleno-cancha" placeholder="Ingrese nombre del relleno" required data-astro-cid-j7pv25f6> </div> <div class="form-group" data-astro-cid-j7pv25f6> <label for="fecha-cancha" data-astro-cid-j7pv25f6> <strong data-astro-cid-j7pv25f6>Fecha *</strong> </label> <input type="date" id="fecha-cancha" required data-astro-cid-j7pv25f6> </div> </div> <!-- Fila 3: Foto --> <div class="form-group" data-astro-cid-j7pv25f6> <label for="foto-cancha" data-astro-cid-j7pv25f6> <strong data-astro-cid-j7pv25f6>Foto</strong> </label> <input type="file" id="foto-cancha" accept="image/*" data-astro-cid-j7pv25f6> <small style="color: #64748b;" data-astro-cid-j7pv25f6>Formatos: JPG, PNG (m\xE1x. 5MB)</small> <div id="preview-foto-cancha" style="display:none; margin-top: 1rem;" data-astro-cid-j7pv25f6> <img id="img-preview-cancha" style="max-width: 200px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" alt="Preview" data-astro-cid-j7pv25f6> </div> </div> <!-- Fila 4: Archivo --> <div class="form-group" data-astro-cid-j7pv25f6> <label for="archivo-cancha" data-astro-cid-j7pv25f6> <strong data-astro-cid-j7pv25f6>Archivo *</strong> </label> <input type="file" id="archivo-cancha" accept=".csv,.xlsx,.asc" required data-astro-cid-j7pv25f6> <small style="color: #64748b;" data-astro-cid-j7pv25f6>Formatos: CSV, XLSX, ASC</small> </div> <!-- Fila 5: Responsable y M\xE9todo --> <div class="form-row" data-astro-cid-j7pv25f6> <div class="form-group" data-astro-cid-j7pv25f6> <label for="responsable-cancha" data-astro-cid-j7pv25f6> <strong data-astro-cid-j7pv25f6>Responsable *</strong> </label> <select id="responsable-cancha" required data-astro-cid-j7pv25f6> <option value="" data-astro-cid-j7pv25f6>Cargando...</option> </select> </div> <div class="form-group" data-astro-cid-j7pv25f6> <label for="metodo-cancha" data-astro-cid-j7pv25f6> <strong data-astro-cid-j7pv25f6>M\xE9todo *</strong> </label> <select id="metodo-cancha" required data-astro-cid-j7pv25f6> <option value="" data-astro-cid-j7pv25f6>Seleccione...</option> <option value="Movimiento de Tierra" data-astro-cid-j7pv25f6>Movimiento de Tierra</option> <option value="Hidraulico" data-astro-cid-j7pv25f6>Hidr\xE1ulico</option> </select> </div> </div> <!-- Fila 6: N\xB0 Capas --> <div class="form-group" data-astro-cid-j7pv25f6> <label for="capas-cancha" data-astro-cid-j7pv25f6> <strong data-astro-cid-j7pv25f6>N\xB0 Capas *</strong> </label> <select id="capas-cancha" required data-astro-cid-j7pv25f6> <option value="" data-astro-cid-j7pv25f6>Seleccione...</option> <option value="1" data-astro-cid-j7pv25f6>1</option> <option value="2" data-astro-cid-j7pv25f6>2</option> <option value="3" data-astro-cid-j7pv25f6>3</option> <option value="4" data-astro-cid-j7pv25f6>4</option> </select> </div> </form> </div> <div class="form-actions" data-astro-cid-j7pv25f6> <button type="button" class="btn-cancel" data-astro-cid-j7pv25f6>Cancelar</button> <button type="submit" class="btn-primary" form="form-subir-canchas" data-astro-cid-j7pv25f6>\nGuardar Cancha\n</button> </div> </div> </div> <!-- Modal de RECEPCI\xD3N de trabajo para LlayLlay --> <div id="recepcion-llayllay-modal" class="modal" data-astro-cid-j7pv25f6> <div class="modal-content" data-astro-cid-j7pv25f6> <div class="modal-header" data-astro-cid-j7pv25f6> <h3 class="modal-title" data-astro-cid-j7pv25f6>\u{1F4CB} Recepci\xF3n de Trabajo - LlayLlay</h3> <button class="close-btn" data-astro-cid-j7pv25f6>\xD7</button> </div> <!-- Historial de observaciones (solo lectura) --> <div id="historial-recepcion-llayllay" class="historial-observaciones" data-astro-cid-j7pv25f6> <h4 data-astro-cid-j7pv25f6>Observaciones del Proceso:</h4> <div class="historial-content" data-astro-cid-j7pv25f6> <p data-astro-cid-j7pv25f6>Cargando historial...</p> </div> </div> <div style="padding: 1rem; background: #e8f4f8; border-left: 4px solid #3498db; border-radius: 4px; margin: 1rem 0;" data-astro-cid-j7pv25f6> <p style="margin: 0; color: #2c3e50;" data-astro-cid-j7pv25f6> <strong data-astro-cid-j7pv25f6>Modo Recepci\xF3n:</strong> Revise el trabajo anterior y presione\n              "Comenzar Trabajo" para iniciar la validaci\xF3n de densidad.\n</p> </div> <div class="form-actions" style="justify-content: center;" data-astro-cid-j7pv25f6> <button type="button" class="btn-cancel" data-astro-cid-j7pv25f6>Cancelar</button> <button type="button" class="btn-comenzar" id="btn-comenzar-llayllay" data-astro-cid-j7pv25f6>\u{1F680} Comenzar Trabajo</button> </div> </div> </div> <!-- Modal de VALIDACI\xD3N de trabajo para LlayLlay --> <div id="validacion-llayllay-modal" class="modal" data-astro-cid-j7pv25f6> <div class="modal-content" data-astro-cid-j7pv25f6> <div class="modal-header" data-astro-cid-j7pv25f6> <h3 class="modal-title" data-astro-cid-j7pv25f6>Validaci\xF3n de Densidad - LlayLlay</h3> <button class="close-btn" data-astro-cid-j7pv25f6>\xD7</button> </div> <!-- Historial de observaciones anteriores --> <div id="historial-llayllay" class="historial-observaciones" data-astro-cid-j7pv25f6> <h4 data-astro-cid-j7pv25f6>Observaciones del Proceso:</h4> <div class="historial-content" data-astro-cid-j7pv25f6> <p data-astro-cid-j7pv25f6>Cargando historial...</p> </div> </div> <form id="form-validacion-llayllay" data-astro-cid-j7pv25f6> <div class="form-group" data-astro-cid-j7pv25f6> <label for="llayllay-observaciones" data-astro-cid-j7pv25f6>Observaciones:</label> <textarea id="llayllay-observaciones" placeholder="Ingresa observaciones sobre la validaci\xF3n..." required data-astro-cid-j7pv25f6></textarea> </div> <div class="form-group" data-astro-cid-j7pv25f6> <label for="llayllay-densidad" data-astro-cid-j7pv25f6>Densidad (g/cm\xB3):</label> <input type="number" id="llayllay-densidad" placeholder="ej: 2.35" min="0" step="0.01" required data-astro-cid-j7pv25f6> </div> <div class="form-actions" data-astro-cid-j7pv25f6> <button type="button" class="btn-cancel" data-astro-cid-j7pv25f6>Cancelar</button> <button type="submit" class="btn-validar" data-astro-cid-j7pv25f6>Validar Densidad</button> <button type="button" class="btn-rechazar" data-astro-cid-j7pv25f6>Rechazar</button> </div> </form> </div> </div> <!-- Modal para validaci\xF3n/rechazo de Besalco --> <div id="validacion-besalco-modal" class="modal" data-astro-cid-j7pv25f6> <div class="modal-content" data-astro-cid-j7pv25f6> <div class="modal-header" data-astro-cid-j7pv25f6> <h3 class="modal-title" data-astro-cid-j7pv25f6>Validaci\xF3n de Trabajo - Besalco</h3> <button class="close-btn" data-astro-cid-j7pv25f6>\xD7</button> </div> <!-- Historial de observaciones anteriores --> <div id="historial-besalco" class="historial-observaciones" data-astro-cid-j7pv25f6> <h4 data-astro-cid-j7pv25f6>Observaciones del Proceso:</h4> <div class="historial-content" data-astro-cid-j7pv25f6> <p data-astro-cid-j7pv25f6>Cargando historial...</p> </div> </div> <form id="form-validacion-besalco" data-astro-cid-j7pv25f6> <div class="form-group" data-astro-cid-j7pv25f6> <label for="besalco-observaciones" data-astro-cid-j7pv25f6>Observaciones del Trabajo:</label> <textarea id="besalco-observaciones" placeholder="Describe el trabajo realizado o motivo del rechazo..." required data-astro-cid-j7pv25f6></textarea> </div> <div class="form-actions" data-astro-cid-j7pv25f6> <button type="button" class="btn-cancel" data-astro-cid-j7pv25f6>Cancelar</button> <button type="submit" class="btn-finalizar" data-astro-cid-j7pv25f6>Finalizar Trabajo</button> <button type="button" class="btn-rechazar" data-astro-cid-j7pv25f6>Rechazar Trabajo</button> </div> </form> </div> </div> <!-- Modal para cerrar cancha (AngloAmerican) --> <div id="cerrar-cancha-modal" class="modal" data-astro-cid-j7pv25f6> <div class="modal-content" data-astro-cid-j7pv25f6> <div class="modal-header" data-astro-cid-j7pv25f6> <h3 class="modal-title" data-astro-cid-j7pv25f6>Cerrar Cancha - AngloAmerican</h3> <button class="close-btn" data-astro-cid-j7pv25f6>\xD7</button> </div> <!-- Historial completo de observaciones --> <div id="historial-cierre" class="historial-observaciones" data-astro-cid-j7pv25f6> <h4 data-astro-cid-j7pv25f6>Historial Completo del Proceso:</h4> <div class="historial-content" data-astro-cid-j7pv25f6> <p data-astro-cid-j7pv25f6>Cargando historial completo...</p> </div> </div> <div class="form-actions" style="justify-content: center; gap: 1rem; padding-top: 1rem;" data-astro-cid-j7pv25f6> <button type="button" class="btn-cancel" data-astro-cid-j7pv25f6>Cancelar</button> <button type="button" class="btn-finalizar" id="confirmar-cierre" data-astro-cid-j7pv25f6>Cerrar Cancha Definitivamente</button> </div> </div> </div> <!-- Modal para borrar cancha (AngloAmerican) --> <div id="borrar-cancha-modal" class="modal" data-astro-cid-j7pv25f6> <div class="modal-content" data-astro-cid-j7pv25f6> <div class="modal-header" data-astro-cid-j7pv25f6> <h3 class="modal-title" style="color: #e74c3c;" data-astro-cid-j7pv25f6>\n\u26A0\uFE0F Borrar Cancha Definitivamente\n</h3> <button class="close-btn" data-astro-cid-j7pv25f6>\xD7</button> </div> <div style="padding: 1rem; background: #fef5e7; border: 2px solid #f39c12; border-radius: 8px; margin: 1rem 0;" data-astro-cid-j7pv25f6> <h4 style="color: #d68910; margin: 0 0 0.5rem 0;" data-astro-cid-j7pv25f6>\n\u26A0\uFE0F ADVERTENCIA\n</h4> <p style="margin: 0; color: #8e6e01;" data-astro-cid-j7pv25f6>\nEsta acci\xF3n <strong data-astro-cid-j7pv25f6>NO SE PUEDE DESHACER</strong>. Se eliminar\xE1 la\n              cancha y todas sus validaciones asociadas de forma permanente.\n</p> </div> <div id="historial-borrado" class="historial-observaciones" data-astro-cid-j7pv25f6> <h4 data-astro-cid-j7pv25f6>Historial que se Eliminar\xE1:</h4> <div class="historial-content" data-astro-cid-j7pv25f6> <p data-astro-cid-j7pv25f6>Cargando historial...</p> </div> </div> <div class="form-group" data-astro-cid-j7pv25f6> <label for="confirmacion-borrado" style="color: #e74c3c; font-weight: 700;" data-astro-cid-j7pv25f6>\nPara confirmar, escribe exactamente: <code style="background: #f8f9fa; padding: 0.25rem;" data-astro-cid-j7pv25f6>borrar-cancha</code> </label> <input type="text" id="confirmacion-borrado" placeholder="Escribe \'borrar-cancha\' para confirmar" style="border: 2px solid #e74c3c;" data-astro-cid-j7pv25f6> </div> <div class="form-actions" style="justify-content: center; gap: 1rem; padding-top: 1rem;" data-astro-cid-j7pv25f6> <button type="button" class="btn-cancel" data-astro-cid-j7pv25f6>Cancelar</button> <button type="button" class="btn-danger" id="confirmar-borrado" disabled data-astro-cid-j7pv25f6>BORRAR CANCHA DEFINITIVAMENTE</button> </div> </div> </div> <!-- Modal para Timeline de Canchas --> <div id="timeline-modal" class="modal" data-astro-cid-j7pv25f6> <div class="modal-content modal-timeline" data-astro-cid-j7pv25f6> <div class="modal-header" data-astro-cid-j7pv25f6> <div data-astro-cid-j7pv25f6> <h3 class="modal-title" data-astro-cid-j7pv25f6> <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-astro-cid-j7pv25f6> <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" data-astro-cid-j7pv25f6></polyline> </svg>\nTimeline de Transiciones\n</h3> <p style="margin: 0.5rem 0 0 0; font-size: 0.95rem; color: rgba(255,255,255,0.85); font-weight: 400;" data-astro-cid-j7pv25f6>\nVisualizaci\xF3n cronol\xF3gica de eventos de las canchas\n                seleccionadas\n</p> </div> <button class="close-btn" id="timeline-close-btn" data-astro-cid-j7pv25f6>\xD7</button> </div> <div class="timeline-container" data-astro-cid-j7pv25f6> <div id="timeline-legend" class="timeline-legend" data-astro-cid-j7pv25f6></div> <div id="timeline-canvas-wrapper" class="timeline-canvas-wrapper" data-astro-cid-j7pv25f6> <canvas id="timeline-canvas" data-astro-cid-j7pv25f6></canvas> <div id="timeline-axis" class="timeline-axis" data-astro-cid-j7pv25f6></div> <div id="timeline-events" class="timeline-events" data-astro-cid-j7pv25f6></div> </div> </div> </div> </div> </div> <script type="module">\n      // ========== ANIMACI\xD3N DE PART\xCDCULAS EN HEADER ==========\n      function initParticles() {\n        const canvas = document.getElementById("particles-canvas");\n        if (!canvas) return;\n\n        const ctx = canvas.getContext("2d");\n        const header = canvas.parentElement;\n\n        let width, height;\n\n        // Ajustar tama\xF1o del canvas\n        function resizeCanvas() {\n          width = header.offsetWidth;\n          height = header.offsetHeight;\n          canvas.width = width;\n          canvas.height = height;\n        }\n\n        resizeCanvas();\n\n        // Configuraci\xF3n de part\xEDculas\n        let particles = [];\n        const particleDensity = 9000; // Menor n\xFAmero = m\xE1s part\xEDculas\n\n        // Mouse interaction\n        let mouse = { x: null, y: null, radius: 150 };\n\n        header.addEventListener("mousemove", (event) => {\n          const rect = header.getBoundingClientRect();\n          mouse.x = event.clientX - rect.left;\n          mouse.y = event.clientY - rect.top;\n        });\n\n        header.addEventListener("mouseleave", () => {\n          mouse.x = null;\n          mouse.y = null;\n        });\n\n        class Particle {\n          constructor() {\n            this.x = Math.random() * width;\n            this.y = Math.random() * height;\n            this.size = Math.random() * 2 + 1.5; // Tama\xF1o variado\n            this.speedX = (Math.random() * 1.5 - 0.75) * 0.5; // Velocidad lenta y elegante\n            this.speedY = (Math.random() * 1.5 - 0.75) * 0.5;\n            this.density = Math.random() * 30 + 1;\n          }\n\n          update() {\n            // Movimiento normal\n            this.x += this.speedX;\n            this.y += this.speedY;\n\n            // Rebote en bordes\n            if (this.x > width || this.x < 0) this.speedX = -this.speedX;\n            if (this.y > height || this.y < 0) this.speedY = -this.speedY;\n\n            // Interacci\xF3n con mouse\n            if (mouse.x != null) {\n              let dx = mouse.x - this.x;\n              let dy = mouse.y - this.y;\n              let distance = Math.sqrt(dx * dx + dy * dy);\n\n              if (distance < mouse.radius) {\n                const forceDirectionX = dx / distance;\n                const forceDirectionY = dy / distance;\n                const maxDistance = mouse.radius;\n                const force = (maxDistance - distance) / maxDistance;\n                const directionX = forceDirectionX * force * this.density;\n                const directionY = forceDirectionY * force * this.density;\n\n                // Efecto de repulsi\xF3n suave\n                this.x -= directionX * 0.05;\n                this.y -= directionY * 0.05;\n              }\n            }\n          }\n\n          draw() {\n            ctx.beginPath();\n            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);\n            ctx.fillStyle = "rgba(255, 255, 255, 0.7)"; // Part\xEDculas claras\n            ctx.fill();\n          }\n        }\n\n        function init() {\n          particles = [];\n          let numberOfParticles = (width * height) / particleDensity;\n          // Asegurar un m\xEDnimo de part\xEDculas\n          if (numberOfParticles < 50) numberOfParticles = 50;\n          if (numberOfParticles > 150) numberOfParticles = 150; // L\xEDmite superior\n\n          for (let i = 0; i < numberOfParticles; i++) {\n            particles.push(new Particle());\n          }\n        }\n\n        init();\n\n        window.addEventListener("resize", () => {\n          resizeCanvas();\n          init();\n        });\n\n        // Animar\n        function animate() {\n          ctx.clearRect(0, 0, width, height);\n\n          particles.forEach((particle) => {\n            particle.update();\n            particle.draw();\n          });\n\n          connect();\n\n          requestAnimationFrame(animate);\n        }\n\n        function connect() {\n          const maxDistance = 130; // Distancia de conexi\xF3n\n          for (let a = 0; a < particles.length; a++) {\n            for (let b = a; b < particles.length; b++) {\n              let dx = particles[a].x - particles[b].x;\n              let dy = particles[a].y - particles[b].y;\n              let distance = Math.sqrt(dx * dx + dy * dy);\n\n              if (distance < maxDistance) {\n                let opacityValue = 1 - distance / maxDistance;\n                ctx.strokeStyle =\n                  "rgba(255, 255, 255," + opacityValue * 0.35 + ")";\n                ctx.lineWidth = 0.8;\n                ctx.beginPath();\n                ctx.moveTo(particles[a].x, particles[a].y);\n                ctx.lineTo(particles[b].x, particles[b].y);\n                ctx.stroke();\n              }\n            }\n          }\n        }\n\n        animate();\n      }\n\n      // Inicializar part\xEDculas cuando cargue el DOM\n      initParticles();\n      // ========== FIN ANIMACI\xD3N DE PART\xCDCULAS ==========\n\n      // Variables globales\n      let usuarioLogueado = null;\n      let empresaLogueada = null;\n      let cargando = false;\n      let vistaActual = "acciones"; // \'acciones\' o \'historico\'\n      let filtroFecha = "all";\n      let todasLasCanchas = [];\n      let canchasFiltradas = [];\n\n      // Variables de paginaci\xF3n\n      let paginaActual = 1;\n      const filasPorPagina = 15;\n      let filtroEstadoActivo = null; // Estado seleccionado desde los c\xEDrculos\n\n      // Elementos del DOM\n      const mainScreen = document.getElementById("main-screen");\n      const userHeader = document.getElementById("user-header");\n      const userName = document.getElementById("user-name");\n      const userRole = document.getElementById("user-role");\n      const userCompany = document.getElementById("user-company");\n      const btnAdminUsuarios = document.getElementById("btn-admin-usuarios");\n      const btnLogout = document.getElementById("btn-logout");\n      const formCrearCancha = document.getElementById("form-crear-cancha");\n      const btnCrearCancha = document.getElementById("btn-crear-cancha");\n      const btnAbrirModalCrear = document.getElementById(\n        "btn-abrir-modal-crear",\n      );\n      const canchasTBody = document.getElementById("canchas-tbody");\n      const mensajeContainer = document.getElementById("mensaje-container");\n      // Elementos del dashboard de estad\xEDsticas (reemplaza contador-resultados)\n\n      // Elementos de filtros\n      const btnVistaAcciones = document.getElementById("btn-vista-acciones");\n      const btnVistaHistorico = document.getElementById("btn-vista-historico");\n      const filtroFechaSelect = document.getElementById("filtro-fecha");\n      const rangoFechas = document.getElementById("rango-fechas");\n      const fechaDesde = document.getElementById("fecha-desde");\n      const fechaHasta = document.getElementById("fecha-hasta");\n      const btnAplicarRango = document.getElementById("btn-aplicar-rango");\n\n      // Cargar datos iniciales\n      async function inicializar() {\n        try {\n          configurarEventListeners();\n\n          // Esperar a que el AuthGuard termine de verificar\n          window.addEventListener("userAuthenticated", (event) => {\n            cargarUsuarioAutenticado(event.detail);\n          });\n\n          // Verificar si ya hay usuario autenticado\n          verificarUsuarioExistente();\n        } catch (error) {\n          console.error("Error al inicializar:", error);\n          mostrarMensaje("Error al cargar datos iniciales", "error");\n        }\n      }\n\n      // Verificar si hay usuario autenticado en localStorage\n      function verificarUsuarioExistente() {\n        try {\n          const sessionData = localStorage.getItem("userSession");\n          if (sessionData) {\n            const session = JSON.parse(sessionData);\n            const expiresAt = new Date(session.expiresAt);\n\n            if (expiresAt > new Date()) {\n              cargarUsuarioAutenticado(session.usuario);\n            } else {\n              // Sesi\xF3n expirada, redirigir al login\n              window.location.href = "/login";\n            }\n          } else {\n            // No hay sesi\xF3n, redirigir al login\n            window.location.href = "/login";\n          }\n        } catch (error) {\n          console.error("Error verificando usuario:", error);\n          window.location.href = "/login";\n        }\n      }\n\n      // Configurar todos los event listeners\n      function configurarEventListeners() {\n        // Logout\n        btnLogout.addEventListener("click", cerrarSesion);\n\n        // Filtros\n        btnVistaAcciones.addEventListener("click", () =>\n          cambiarVista("acciones"),\n        );\n        btnVistaHistorico.addEventListener("click", () =>\n          cambiarVista("historico"),\n        );\n        filtroFechaSelect.addEventListener("change", manejarCambioFiltroFecha);\n        btnAplicarRango.addEventListener("click", aplicarRangoFechas);\n\n        // Modal\n        configurarModalEventListeners();\n\n        // === EVENT LISTENERS PARA BOTONES ESPECIALES DE LINKAPSIS ===\n        configurarBotonesLinkapsis();\n\n        // Crear cancha (si aplica)\n        if (btnCrearCancha) {\n          console.log("Registrando event listener para btnCrearCancha");\n          btnCrearCancha.addEventListener("click", crearCancha);\n        } else {\n          console.log("No se encontr\xF3 btnCrearCancha");\n        }\n\n        // Bot\xF3n para abrir modal de crear cancha con pol\xEDgono\n        if (btnAbrirModalCrear) {\n          console.log("Registrando event listener para btnAbrirModalCrear");\n          btnAbrirModalCrear.addEventListener("click", abrirModalCrearCancha);\n        } else {\n          console.log("No se encontr\xF3 btnAbrirModalCrear");\n        }\n\n        // Configurar selectores din\xE1micos de Muro y Sector\n        configurarSelectoresMuroSector();\n\n        // Configurar botones de paginaci\xF3n\n        configurarPaginacion();\n\n        // Configurar controles del mapa\n        configurarControlesMapa();\n\n        // Inicializar slider de filtros\n        setTimeout(updateSliderPosition, 100);\n        window.addEventListener("resize", updateSliderPosition);\n      }\n\n      // Configurar controles del header del mapa\n      function configurarControlesMapa() {\n        const mapMuroFilter = document.getElementById("map-muro-filter");\n        const toggleRevanchas = document.getElementById("toggle-revanchas");\n        const mapSubtitle = document.getElementById("map-subtitle");\n\n        // Filtro de muros del mapa\n        if (mapMuroFilter) {\n          mapMuroFilter.addEventListener("change", (e) => {\n            const muroSeleccionado = e.target.value;\n            console.log("\u{1F5FA}\uFE0F Filtro de muro cambiado:", muroSeleccionado);\n\n            // Actualizar subt\xEDtulo\n            if (mapSubtitle) {\n              if (muroSeleccionado) {\n                mapSubtitle.textContent = `Mostrando canchas del Muro ${muroSeleccionado}`;\n              } else {\n                mapSubtitle.textContent = "Mostrando todas las canchas";\n              }\n            }\n\n            // Recargar el iframe del mapa con el filtro aplicado\n            recargarMapaConFiltro(muroSeleccionado);\n          });\n        }\n\n        // Toggle de Revanchas\n        if (toggleRevanchas) {\n          toggleRevanchas.addEventListener("change", async (e) => {\n            const activado = e.target.checked;\n            console.log("\u{1F4CA} Revanchas toggle:", activado ? "ON" : "OFF");\n            \n            const mapContainer = document.getElementById("dashboard-map-container");\n            const iframe = mapContainer?.querySelector("iframe");\n            \n            if (!iframe || !iframe.contentWindow) {\n              console.log("\u26A0\uFE0F Iframe del mapa no disponible");\n              return;\n            }\n\n            if (activado) {\n              try {\n                console.log("\u{1F504} Cargando revanchas georreferenciadas...");\n                \n                // Obtener filtro de muro actual\n                const muroFiltro = mapMuroFilter?.value || \'\';\n                \n                // Construir URL con filtros\n                let apiUrl = \'/api/revanchas/georreferenciadas?soloUltimas=true&formato=geojson\';\n                if (muroFiltro) {\n                  apiUrl += `&muro=${muroFiltro}`;\n                }\n                \n                // Cargar datos de revanchas georreferenciadas\n                const response = await fetch(apiUrl);\n                if (!response.ok) {\n                  throw new Error(`Error ${response.status}: ${response.statusText}`);\n                }\n                \n                const geojsonData = await response.json();\n                console.log(`\u2705 ${geojsonData.features.length} revanchas georreferenciadas cargadas`);\n                \n                // Enviar datos al iframe del mapa\n                iframe.contentWindow.postMessage({\n                  type: \'mostrar-revanchas\',\n                  data: geojsonData\n                }, \'*\');\n                \n                console.log("\u{1F4E4} Datos de revanchas enviados al mapa");\n              } catch (error) {\n                console.error("\u274C Error al cargar revanchas:", error);\n                alert("Error al cargar revanchas georreferenciadas");\n                // Desmarcar el toggle en caso de error\n                e.target.checked = false;\n              }\n            } else {\n              // Ocultar capa de revanchas\n              iframe.contentWindow.postMessage({\n                type: \'ocultar-revanchas\'\n              }, \'*\');\n              console.log("\u{1F4E4} Comando de ocultar revanchas enviado al mapa");\n            }\n          });\n        }\n      }\n\n      // Recargar el mapa con el filtro de muro aplicado\n      function recargarMapaConFiltro(muro) {\n        const mapContainer = document.getElementById("dashboard-map-container");\n        if (!mapContainer) return;\n\n        // Mostrar indicador de carga\n        mapContainer.innerHTML =\n          \'<div class="dashboard-map-loading">Cargando mapa...</div>\';\n\n        // Construir URL del mapa con filtro\n        let mapUrl = "/mapbox-window?dashboardMode=true";\n\n        // Obtener IDs de todas las canchas filtradas\n        const canchaIds = canchasFiltradas.map((c) => c.id).join(",");\n        if (canchaIds) {\n          mapUrl += `&canchaIds=${canchaIds}`;\n        }\n\n        // Agregar filtro de muro si est\xE1 seleccionado\n        if (muro) {\n          // Convertir nombre completo a c\xF3digo (Principal -> MP, Este -> ME, Oeste -> MO)\n          const muroCodigo =\n            muro === "Principal"\n              ? "MP"\n              : muro === "Este"\n                ? "ME"\n                : muro === "Oeste"\n                  ? "MO"\n                  : muro;\n          mapUrl += `&muro=${muroCodigo}`;\n        }\n\n        console.log("\u{1F310} Recargando mapa con URL:", mapUrl);\n\n        // Crear nuevo iframe\n        setTimeout(() => {\n          const iframe = document.createElement("iframe");\n          iframe.src = mapUrl;\n          iframe.style.width = "100%";\n          iframe.style.height = "100%";\n          iframe.style.border = "none";\n\n          mapContainer.innerHTML = "";\n          mapContainer.appendChild(iframe);\n        }, 300);\n      }\n\n      // Configurar event listeners de paginaci\xF3n\n      function configurarPaginacion() {\n        document\n          .getElementById("btn-primera-pagina")\n          .addEventListener("click", () => {\n            paginaActual = 1;\n            renderizarPaginaCanchas();\n          });\n\n        document\n          .getElementById("btn-pagina-anterior")\n          .addEventListener("click", () => {\n            if (paginaActual > 1) {\n              paginaActual--;\n              renderizarPaginaCanchas();\n            }\n          });\n\n        document\n          .getElementById("btn-pagina-siguiente")\n          .addEventListener("click", () => {\n            const totalPaginas = Math.ceil(\n              canchasFiltradas.length / filasPorPagina,\n            );\n            if (paginaActual < totalPaginas) {\n              paginaActual++;\n              renderizarPaginaCanchas();\n            }\n          });\n\n        document\n          .getElementById("btn-ultima-pagina")\n          .addEventListener("click", () => {\n            const totalPaginas = Math.ceil(\n              canchasFiltradas.length / filasPorPagina,\n            );\n            paginaActual = totalPaginas || 1;\n            renderizarPaginaCanchas();\n          });\n\n        // Configurar event listeners para widgets de estado (doble click)\n        const estadoWidgets = document.querySelectorAll(".estado-widget");\n        estadoWidgets.forEach((widget) => {\n          widget.addEventListener("dblclick", () => {\n            const estadoData = widget.getAttribute("data-estado");\n            const estadoMap = {\n              creada: "Creada",\n              "en-espera": "En Espera",\n              "en-proceso": "En Proceso",\n              validada: "Validada",\n              "rechazada-en-espera": "Rechazada, en Espera",\n              cerrada: "Cerrada",\n            };\n            const estadoNombre = estadoMap[estadoData];\n            if (estadoNombre) {\n              filtrarPorEstadoWidget(estadoNombre);\n            }\n          });\n        });\n      }\n\n      // Configurar selectores din\xE1micos de Muro y Sector\n      function configurarSelectoresMuroSector() {\n        const selectMuro = document.getElementById("muro-select");\n        const selectSector = document.getElementById("sector-select");\n\n        if (!selectMuro || !selectSector) return;\n\n        selectMuro.addEventListener("change", function () {\n          const muroSeleccionado = this.value;\n\n          // Limpiar opciones del sector\n          selectSector.innerHTML = "";\n\n          if (!muroSeleccionado) {\n            selectSector.disabled = true;\n            selectSector.innerHTML =\n              \'<option value="">Primero selecciona un muro</option>\';\n            return;\n          }\n\n          selectSector.disabled = false;\n          selectSector.innerHTML =\n            \'<option value="">Selecciona un sector</option>\';\n\n          // Agregar opciones seg\xFAn el muro seleccionado\n          if (muroSeleccionado === "MP") {\n            // MP: S1 hasta S7\n            for (let i = 1; i <= 7; i++) {\n              const option = document.createElement("option");\n              option.value = `S${i}`;\n              option.textContent = `S${i}`;\n              selectSector.appendChild(option);\n            }\n          } else if (muroSeleccionado === "ME" || muroSeleccionado === "MO") {\n            // ME y MO: S1 hasta S3\n            for (let i = 1; i <= 3; i++) {\n              const option = document.createElement("option");\n              option.value = `S${i}`;\n              option.textContent = `S${i}`;\n              selectSector.appendChild(option);\n            }\n          }\n        });\n      }\n\n      // Configurar event listeners del modal\n      function configurarModalEventListeners() {\n        // Bot\xF3n de cerrar modal\n        const closeBtn = document.querySelector(".close-btn");\n        if (closeBtn) {\n          closeBtn.addEventListener("click", cerrarTodosLosModales);\n        }\n      }\n\n      // === FUNCI\xD3N TEMPORAL DE DEBUG ===\n      window.debugCancha = function (canchaId) {\n        const cancha = todasLasCanchas.find((c) => c.id == canchaId);\n        if (cancha) {\n          console.log("=== DEBUG CANCHA ===");\n          console.log("Cancha encontrada:", cancha);\n          console.log("Estado actual:", cancha.estado_actual);\n          console.log("Empresa actual:", cancha.empresa_actual);\n          console.log("Validaciones:", cancha.validaciones);\n\n          if (cancha.validaciones) {\n            cancha.validaciones.forEach((v) => {\n              console.log(`- ${v.empresa}: ${v.estado}`);\n            });\n          }\n\n          // Verificar qu\xE9 botones deber\xEDa mostrar\n          const botonesGenerados = generarBotonesAccion(\n            canchaId,\n            cancha.estado_actual,\n            cancha.empresa_actual,\n          );\n          console.log("Botones que deber\xEDa generar:", botonesGenerados);\n\n          return cancha;\n        } else {\n          console.log("Cancha no encontrada con ID:", canchaId);\n          console.log(\n            "Canchas disponibles:",\n            todasLasCanchas.map((c) => ({ id: c.id, nombre: c.nombre })),\n          );\n          return null;\n        }\n      };\n\n      window.debugTodasLasCanchas = function () {\n        console.log("=== TODAS LAS CANCHAS ===");\n        todasLasCanchas.forEach((cancha) => {\n          console.log(\n            `ID: ${cancha.id}, Nombre: ${cancha.nombre}, Estado: ${cancha.estado_actual}, Empresa: ${cancha.empresa_actual}`,\n          );\n        });\n        return todasLasCanchas;\n      };\n\n      // === FUNCIONES DE AUTENTICACI\xD3N ===\n      // Las funciones de autenticaci\xF3n ahora se manejan en login.astro y AuthGuard.astro\n\n      // Cargar informaci\xF3n del usuario autenticado\n      async function cargarUsuarioAutenticado(usuario) {\n        try {\n          console.log("Cargando usuario autenticado:", usuario);\n\n          usuarioLogueado = usuario;\n          empresaLogueada = {\n            id: usuario.empresa_id,\n            nombre: usuario.empresa_nombre,\n          };\n\n          // Actualizar UI del header\n          userName.textContent = usuario.nombre_completo;\n          userRole.textContent = `${usuario.rol_nombre} - ${usuario.empresa_nombre}`;\n\n          // Asignar logo de empresa\n          const companyLogo = document.getElementById("user-company-logo");\n          const logoMap = {\n            AngloAmerican: "/AngloAmerican.png",\n            Besalco: "/Besalco.png",\n            Linkapsis: "/Linkapsis.png",\n            LlayLlay: "/LlayLlay.png",\n          };\n\n          if (companyLogo && logoMap[usuario.empresa_nombre]) {\n            companyLogo.src = logoMap[usuario.empresa_nombre];\n            companyLogo.alt = `Logo ${usuario.empresa_nombre}`;\n            companyLogo.style.display = "block";\n          }\n\n          userCompany.className = `empresa-actual empresa-${usuario.empresa_nombre.toLowerCase().replace(" ", "")}`;\n\n          // Mostrar/ocultar bot\xF3n de crear cancha seg\xFAn la empresa\n          if (usuario.empresa_nombre === "AngloAmerican") {\n            console.log("Mostrando bot\xF3n de crear cancha para AngloAmerican");\n            if (btnAbrirModalCrear)\n              btnAbrirModalCrear.style.display = "inline-flex";\n          } else {\n            console.log(\n              "Ocultando bot\xF3n de crear cancha para:",\n              usuario.empresa_nombre,\n            );\n            if (btnAbrirModalCrear) btnAbrirModalCrear.style.display = "none";\n          }\n\n          // Mostrar enlace de administraci\xF3n si es de AngloAmerican\n          if (usuario.empresa_id === 1) {\n            // AngloAmerican\n            btnAdminUsuarios.style.display = "inline-block";\n          } else {\n            btnAdminUsuarios.style.display = "none";\n          }\n\n          // === MOSTRAR BOTONES ESPECIALES PARA LINKAPSIS ===\n          // Linkapsis tiene empresa_nombre === "Linkapsis" (verificar en base de datos)\n          const btnSubirRevanchas = document.getElementById(\n            "btn-subir-revanchas",\n          );\n          const btnSubirCanchas = document.getElementById("btn-subir-canchas");\n\n          if (usuario.empresa_nombre === "Linkapsis") {\n            console.log("Mostrando botones especiales para Linkapsis");\n            if (btnSubirRevanchas)\n              btnSubirRevanchas.style.display = "inline-flex";\n            if (btnSubirCanchas) btnSubirCanchas.style.display = "inline-flex";\n          } else {\n            if (btnSubirRevanchas) btnSubirRevanchas.style.display = "none";\n            if (btnSubirCanchas) btnSubirCanchas.style.display = "none";\n          }\n\n          // Cargar datos\n          await cargarCanchas();\n\n          // Mensaje de bienvenida eliminado para evitar duplicados\n        } catch (error) {\n          console.error("Error cargando usuario:", error);\n          mostrarMensaje("Error al cargar informaci\xF3n del usuario", "error");\n          window.location.href = "/login";\n        }\n      }\n\n      function getRolEmpresa(nombreEmpresa) {\n        const roles = {\n          AngloAmerican: "Creaci\xF3n y cierre de canchas",\n          Besalco: "Trabajo de maquinaria",\n          Linkapsis: "Validaci\xF3n de espesores",\n          LlayLlay: "Validaci\xF3n de densidad",\n        };\n        return roles[nombreEmpresa] || "Usuario del sistema";\n      }\n\n      // ========================================\n      // FUNCIONES PARA BOTONES LINKAPSIS\n      // ========================================\n      /**\n       * Configurar event listeners para los botones especiales de Linkapsis\n       * - btn-subir-revanchas: Abre modal para cargar informaci\xF3n de revanchas\n       * - btn-subir-canchas: Abre modal para carga masiva de canchas\n       */\n      function configurarBotonesLinkapsis() {\n        const btnSubirRevanchas = document.getElementById(\n          "btn-subir-revanchas",\n        );\n        const btnSubirCanchas = document.getElementById("btn-subir-canchas");\n\n        // Event listener para Subir Revanchas\n        if (btnSubirRevanchas) {\n          btnSubirRevanchas.addEventListener("click", () => {\n            console.log("Abriendo modal de Subir Revanchas");\n            abrirModalSubirRevanchas();\n          });\n        }\n\n        // Event listener para Subir Canchas\n        if (btnSubirCanchas) {\n          btnSubirCanchas.addEventListener("click", () => {\n            console.log("Abriendo modal de Subir Canchas");\n            abrirModalSubirCanchas();\n          });\n        }\n\n        // Configurar cierre de modales\n        configurarCierreModalesLinkapsis();\n      }\n\n      /**\n       * Abrir modal de Subir Revanchas\n       * TODO: Implementar l\xF3gica de carga y procesamiento de revanchas\n       */\n      function abrirModalSubirRevanchas() {\n        const modal = document.getElementById("modal-subir-revanchas");\n        if (modal) {\n          modal.classList.add("show");\n          // TODO: Inicializar formulario, limpiar campos previos\n          // TODO: Configurar validaciones de archivo\n        }\n      }\n\n      /**\n       * Abrir modal de Subir Canchas\n       * TODO: Implementar l\xF3gica de carga masiva de canchas\n       */\n      function abrirModalSubirCanchas() {\n        const modal = document.getElementById("modal-subir-canchas");\n        if (modal) {\n          modal.classList.add("show");\n          // TODO: Inicializar formulario, limpiar campos previos\n          // TODO: Configurar validaciones de archivo y geometr\xEDas\n        }\n      }\n\n      /**\n       * Configurar event listeners para cerrar modales de Linkapsis\n       * Permite cerrar con:\n       * - Bot\xF3n X (close-btn)\n       * - Bot\xF3n Cancelar/Cerrar (btn-cancel)\n       * - Click fuera del modal (backdrop)\n       */\n      function configurarCierreModalesLinkapsis() {\n        const modales = [\n          { id: "modal-subir-revanchas", nombre: "Subir Revanchas" },\n          { id: "modal-subir-canchas", nombre: "Subir Canchas" },\n        ];\n\n        modales.forEach((modalInfo) => {\n          const modal = document.getElementById(modalInfo.id);\n          if (!modal) {\n            console.warn(`Modal ${modalInfo.nombre} no encontrado`);\n            return;\n          }\n\n          const closeBtn = modal.querySelector(".close-btn");\n          const cancelBtn = modal.querySelector(".btn-cancel");\n\n          // Cerrar con bot\xF3n X\n          if (closeBtn) {\n            closeBtn.addEventListener("click", () => {\n              console.log(`Cerrando modal ${modalInfo.nombre} (bot\xF3n X)`);\n              modal.classList.remove("show");\n            });\n          }\n\n          // Cerrar con bot\xF3n Cancelar/Cerrar\n          if (cancelBtn) {\n            cancelBtn.addEventListener("click", () => {\n              console.log(\n                `Cerrando modal ${modalInfo.nombre} (bot\xF3n Cancelar)`,\n              );\n              modal.classList.remove("show");\n            });\n          }\n\n          // Cerrar al hacer click en el backdrop (fuera del modal-content)\n          modal.addEventListener("click", (e) => {\n            if (e.target === modal) {\n              console.log(`Cerrando modal ${modalInfo.nombre} (backdrop)`);\n              modal.classList.remove("show");\n            }\n          });\n        });\n      }\n\n      function cerrarSesion() {\n        usuarioLogueado = null;\n        empresaLogueada = null;\n\n        // Limpiar localStorage\n        localStorage.removeItem("userSession");\n\n        // Redirigir al login\n        window.location.href = "/login";\n        todasLasCanchas = [];\n        canchasFiltradas = [];\n\n        mostrarMensaje("Sesi\xF3n cerrada correctamente", "success");\n      }\n\n      // === FUNCIONES DE CARGA DE DATOS ===\n\n      // === FUNCIONES DE FILTROS ===\n      function cambiarVista(nuevaVista) {\n        console.log("Cambiando vista a:", nuevaVista);\n        vistaActual = nuevaVista;\n\n        // Actualizar botones\n        btnVistaAcciones.classList.toggle("active", nuevaVista === "acciones");\n        btnVistaHistorico.classList.toggle(\n          "active",\n          nuevaVista === "historico",\n        );\n\n        // Aplicar filtros\n        aplicarFiltros();\n\n        // Actualizar slider\n        updateSliderPosition();\n      }\n\n      function updateSliderPosition() {\n        const container = document.querySelector(".toggle-container");\n        const activeBtn = container?.querySelector(".active");\n        const slider = container?.querySelector(".toggle-slider");\n\n        if (activeBtn && slider && container) {\n          // Calcular posici\xF3n relativa al contenedor\n          const containerRect = container.getBoundingClientRect();\n          const btnRect = activeBtn.getBoundingClientRect();\n\n          const left = btnRect.left - containerRect.left;\n          const width = btnRect.width;\n\n          slider.style.transform = `translateX(${left}px)`;\n          slider.style.width = `${width}px`;\n        }\n      }\n\n      function manejarCambioFiltroFecha() {\n        filtroFecha = filtroFechaSelect.value;\n\n        if (filtroFecha === "custom") {\n          rangoFechas.classList.remove("hidden");\n        } else {\n          rangoFechas.classList.add("hidden");\n          aplicarFiltros();\n        }\n      }\n\n      function aplicarRangoFechas() {\n        const desde = fechaDesde.value;\n        const hasta = fechaHasta.value;\n\n        if (!desde || !hasta) {\n          mostrarMensaje("Por favor selecciona ambas fechas", "error");\n          return;\n        }\n\n        aplicarFiltros();\n      }\n\n      function aplicarFiltros() {\n        if (!empresaLogueada || !todasLasCanchas.length) return;\n\n        canchasFiltradas = [...todasLasCanchas];\n        console.log("Aplicando filtros, vista actual:", vistaActual);\n        console.log("Total canchas antes del filtro:", canchasFiltradas.length);\n\n        // Filtro por vista (acciones vs hist\xF3rico)\n        if (vistaActual === "acciones") {\n          canchasFiltradas = filtrarPorAccionesDisponibles(canchasFiltradas);\n          console.log(\n            "Canchas despu\xE9s del filtro de acciones:",\n            canchasFiltradas.length,\n          );\n        }\n\n        // Filtro por fecha\n        canchasFiltradas = filtrarPorFecha(canchasFiltradas);\n\n        // Filtro por estado desde widgets circulares\n        if (filtroEstadoActivo) {\n          canchasFiltradas = canchasFiltradas.filter(\n            (cancha) => cancha.estado_actual === filtroEstadoActivo,\n          );\n          console.log(\n            "Canchas despu\xE9s del filtro de estado:",\n            canchasFiltradas.length,\n          );\n        }\n\n        // Reiniciar a la primera p\xE1gina al aplicar filtros\n        paginaActual = 1;\n\n        // Mostrar resultados\n        mostrarCanchas(canchasFiltradas);\n        actualizarContadorResultados(\n          canchasFiltradas.length,\n          todasLasCanchas.length,\n        );\n      }\n\n      function filtrarPorAccionesDisponibles(canchas) {\n        const empresaId = empresaLogueada.id;\n        const empresaNombre = empresaLogueada.nombre;\n\n        console.log("Filtrando para empresa:", empresaNombre);\n\n        return canchas.filter((cancha) => {\n          const estado = cancha.estado_actual;\n          const empresaActual = cancha.empresa_actual;\n\n          console.log(\n            `Cancha ${cancha.nombre}: estado="${estado}", empresa="${empresaActual}"`,\n          );\n\n          let tieneAccion = false;\n\n          switch (empresaNombre) {\n            case "AngloAmerican":\n              // AngloAmerican puede actuar cuando:\n              // - Cancha creada (enviar a Besalco)\n              // - Cancha validada (cerrar)\n              tieneAccion = estado === "Creada" || estado === "Validada";\n              break;\n\n            case "Besalco":\n              // Besalco puede actuar cuando:\n              // - Est\xE1 en espera (reci\xE9n asignada o rechazada)\n              // - Est\xE1 en proceso (trabajando activamente)\n              tieneAccion =\n                (estado === "En Espera" && empresaActual === "Besalco") ||\n                (estado === "En Proceso" && empresaActual === "Besalco") ||\n                (estado === "Rechazada, en Espera" &&\n                  empresaActual === "Besalco");\n              break;\n\n            case "Linkapsis":\n              // Linkapsis puede actuar cuando est\xE1 en espera o en proceso\n              tieneAccion =\n                (estado === "En Espera" && empresaActual === "Linkapsis") ||\n                (estado === "En Proceso" && empresaActual === "Linkapsis");\n              break;\n\n            case "LlayLlay":\n              // LlayLlay puede actuar cuando est\xE1 en espera o en proceso\n              tieneAccion =\n                (estado === "En Espera" && empresaActual === "LlayLlay") ||\n                (estado === "En Proceso" && empresaActual === "LlayLlay");\n              break;\n\n            default:\n              tieneAccion = false;\n          }\n\n          console.log(`-> Tiene acci\xF3n: ${tieneAccion}`);\n          return tieneAccion;\n        });\n      }\n\n      function filtrarPorFecha(canchas) {\n        if (filtroFecha === "all") return canchas;\n\n        const ahora = new Date();\n        const hoy = new Date(\n          ahora.getFullYear(),\n          ahora.getMonth(),\n          ahora.getDate(),\n        );\n\n        return canchas.filter((cancha) => {\n          const fechaCancha = new Date(cancha.created_at);\n\n          switch (filtroFecha) {\n            case "today":\n              return fechaCancha >= hoy;\n            case "week":\n              const semanaAtras = new Date(\n                hoy.getTime() - 7 * 24 * 60 * 60 * 1000,\n              );\n              return fechaCancha >= semanaAtras;\n            case "month":\n              const mesAtras = new Date(\n                hoy.getTime() - 30 * 24 * 60 * 60 * 1000,\n              );\n              return fechaCancha >= mesAtras;\n            case "custom":\n              if (!fechaDesde.value || !fechaHasta.value) return true;\n              const desde = new Date(fechaDesde.value);\n              const hasta = new Date(fechaHasta.value + "T23:59:59");\n              return fechaCancha >= desde && fechaCancha <= hasta;\n            default:\n              return true;\n          }\n        });\n      }\n\n      // Actualizar dashboard de estados con contadores\n      function actualizarContadorResultados(mostradas, total) {\n        // === ACTUALIZAR WIDGETS ORIGINALES (SIDEBAR) ===\n        // Contar acciones disponibles para la empresa logueada\n        const accionesDisponibles = canchasFiltradas.filter((cancha) => {\n          const estado = cancha.estado_actual;\n          const empresaActual = cancha.empresa_actual;\n\n          if (!empresaLogueada) return false;\n\n          let tieneAccion = false;\n          const empresaNombre = empresaLogueada.nombre;\n\n          switch (empresaNombre) {\n            case "AngloAmerican":\n              // AngloAmerican puede actuar cuando:\n              // - Cancha creada (enviar a Besalco)\n              // - Cancha validada (cerrar)\n              tieneAccion = estado === "Creada" || estado === "Validada";\n              break;\n            case "Besalco":\n              // Besalco puede actuar cuando:\n              // - Est\xE1 en espera (reci\xE9n asignada o rechazada)\n              // - Est\xE1 en proceso (trabajando activamente)\n              tieneAccion =\n                (estado === "En Espera" && empresaActual === "Besalco") ||\n                (estado === "En Proceso" && empresaActual === "Besalco") ||\n                (estado === "Rechazada, en Espera" &&\n                  empresaActual === "Besalco");\n              break;\n            case "Linkapsis":\n              // Linkapsis puede actuar cuando est\xE1 en espera o en proceso\n              tieneAccion =\n                (estado === "En Espera" && empresaActual === "Linkapsis") ||\n                (estado === "En Proceso" && empresaActual === "Linkapsis");\n              break;\n            case "LlayLlay":\n              // LlayLlay puede actuar cuando est\xE1 en espera o en proceso\n              tieneAccion =\n                (estado === "En Espera" && empresaActual === "LlayLlay") ||\n                (estado === "En Proceso" && empresaActual === "LlayLlay");\n              break;\n            default:\n              tieneAccion = false;\n          }\n          return tieneAccion;\n        }).length;\n\n        // Actualizar contadores del sidebar\n        const statAcciones = document.getElementById("stat-acciones");\n        const statTotal = document.getElementById("stat-total");\n\n        if (statAcciones) {\n          animateNumber(\n            statAcciones,\n            parseInt(statAcciones.textContent) || 0,\n            accionesDisponibles,\n          );\n        }\n\n        if (statTotal) {\n          animateNumber(statTotal, parseInt(statTotal.textContent) || 0, total);\n        }\n\n        // === ACTUALIZAR WIDGETS CIRCULARES (DASHBOARD DE ESTADOS) ===\n        // Contar canchas por estado\n        const contadores = {\n          Creada: 0,\n          "En Espera": 0,\n          "En Proceso": 0,\n          Validada: 0,\n          "Rechazada, en Espera": 0,\n          Cerrada: 0,\n        };\n\n        // Contar las canchas filtradas por estado\n        canchasFiltradas.forEach((cancha) => {\n          const estado = cancha.estado_actual;\n          if (contadores.hasOwnProperty(estado)) {\n            contadores[estado]++;\n          }\n        });\n\n        // Actualizar los widgets circulares con animaci\xF3n\n        animateNumber(\n          document.getElementById("count-creada"),\n          parseInt(document.getElementById("count-creada").textContent) || 0,\n          contadores["Creada"],\n        );\n\n        animateNumber(\n          document.getElementById("count-en-espera"),\n          parseInt(document.getElementById("count-en-espera").textContent) || 0,\n          contadores["En Espera"],\n        );\n\n        animateNumber(\n          document.getElementById("count-en-proceso"),\n          parseInt(document.getElementById("count-en-proceso").textContent) ||\n            0,\n          contadores["En Proceso"],\n        );\n\n        animateNumber(\n          document.getElementById("count-validada"),\n          parseInt(document.getElementById("count-validada").textContent) || 0,\n          contadores["Validada"],\n        );\n\n        animateNumber(\n          document.getElementById("count-rechazada-en-espera"),\n          parseInt(\n            document.getElementById("count-rechazada-en-espera").textContent,\n          ) || 0,\n          contadores["Rechazada, en Espera"],\n        );\n\n        animateNumber(\n          document.getElementById("count-cerrada"),\n          parseInt(document.getElementById("count-cerrada").textContent) || 0,\n          contadores["Cerrada"],\n        );\n\n        // Actualizar subt\xEDtulo del mapa\n        actualizarSubtituloMapa(mostradas);\n      }\n\n      // Manejar doble click en widgets de estado para filtrar\n      function filtrarPorEstadoWidget(estadoNombre) {\n        const widgets = document.querySelectorAll(".estado-widget");\n\n        // Si se clickea el mismo estado, desactivar filtro\n        if (filtroEstadoActivo === estadoNombre) {\n          filtroEstadoActivo = null;\n          widgets.forEach((w) => {\n            w.classList.remove("selected");\n            w.classList.remove("dimmed");\n          });\n        } else {\n          // Activar nuevo filtro\n          filtroEstadoActivo = estadoNombre;\n\n          // Actualizar clases de selecci\xF3n y dimmed\n          widgets.forEach((widget) => {\n            const estadoWidget = widget.getAttribute("data-estado");\n            const estadoMap = {\n              creada: "Creada",\n              "en-espera": "En Espera",\n              "en-proceso": "En Proceso",\n              validada: "Validada",\n              "rechazada-en-espera": "Rechazada, en Espera",\n              cerrada: "Cerrada",\n            };\n\n            if (estadoMap[estadoWidget] === estadoNombre) {\n              widget.classList.add("selected");\n              widget.classList.remove("dimmed");\n            } else {\n              widget.classList.remove("selected");\n              widget.classList.add("dimmed");\n            }\n          });\n        }\n\n        // Re-aplicar filtros\n        aplicarFiltros();\n      }\n\n      // Actualizar subt\xEDtulo del mapa seg\xFAn filtros activos\n      function actualizarSubtituloMapa(cantidadCanchas) {\n        const subtitle = document.getElementById("map-subtitle");\n        if (!subtitle) return;\n\n        let texto = "";\n\n        if (vistaActual === "acciones") {\n          texto = `Mostrando ${cantidadCanchas} cancha${cantidadCanchas !== 1 ? "s" : ""} con acciones disponibles`;\n        } else {\n          texto = `Mostrando ${cantidadCanchas} cancha${cantidadCanchas !== 1 ? "s" : ""} del hist\xF3rico`;\n        }\n\n        // Agregar informaci\xF3n del filtro de fecha\n        if (filtroFecha === "today") {\n          texto += " (Hoy)";\n        } else if (filtroFecha === "week") {\n          texto += " (\xDAltima semana)";\n        } else if (filtroFecha === "month") {\n          texto += " (\xDAltimo mes)";\n        } else if (filtroFecha === "custom") {\n          texto += " (Rango personalizado)";\n        }\n\n        subtitle.textContent = texto;\n      }\n\n      // Actualizar mapa dashboard con las canchas filtradas\n      function actualizarMapaDashboard(canchas) {\n        const mapContainer = document.getElementById("dashboard-map-container");\n        if (!mapContainer) return;\n\n        console.log(\n          "\u{1F5FA}\uFE0F Actualizando mapa dashboard con",\n          canchas.length,\n          "canchas",\n        );\n\n        // Extraer IDs de canchas para el mapa\n        const canchaIds = canchas.map((c) => c.id).join(",");\n\n        // Construir URL del iframe con par\xE1metros de filtrado\n        const params = new URLSearchParams();\n        params.set("dashboardMode", "true");\n        params.set("canchaIds", canchaIds);\n\n        const mapUrl = `/mapbox-window?${params.toString()}`;\n\n        // Crear o actualizar iframe\n        let iframe = mapContainer.querySelector("iframe");\n        if (!iframe) {\n          iframe = document.createElement("iframe");\n          iframe.style.width = "100%";\n          iframe.style.height = "100%";\n          iframe.style.border = "none";\n\n          // Limpiar loading y agregar iframe\n          mapContainer.innerHTML = "";\n          mapContainer.appendChild(iframe);\n        }\n\n        // Actualizar src del iframe\n        iframe.src = mapUrl;\n\n        console.log("\u2705 Mapa dashboard actualizado con URL:", mapUrl);\n      }\n\n      // Funci\xF3n para animar n\xFAmeros\n      function animateNumber(element, start, end, suffix = "") {\n        const duration = 800;\n        const startTime = Date.now();\n\n        function update() {\n          const elapsed = Date.now() - startTime;\n          const progress = Math.min(elapsed / duration, 1);\n\n          // Easing function (ease-out)\n          const easedProgress = 1 - Math.pow(1 - progress, 3);\n          const current = Math.round(start + (end - start) * easedProgress);\n\n          element.textContent = current + suffix;\n\n          if (progress < 1) {\n            requestAnimationFrame(update);\n          }\n        }\n\n        update();\n      }\n\n      // === FUNCI\xD3N DE CREACI\xD3N DE CANCHAS ===\n      async function crearCancha() {\n        console.log("Funci\xF3n crearCancha llamada");\n        if (cargando) return;\n\n        const muro = document.getElementById("muro").value.trim();\n        const sector = document.getElementById("sector").value.trim();\n        const nombreDetalle = document\n          .getElementById("nombre-detalle")\n          .value.trim();\n\n        console.log("Datos del formulario:", { muro, sector, nombreDetalle });\n\n        if (!muro || !sector || !nombreDetalle) {\n          alert("Por favor completa todos los campos");\n          return;\n        }\n\n        try {\n          cargando = true;\n          btnCrearCancha.textContent = "Creando...";\n          btnCrearCancha.disabled = true;\n\n          const response = await fetch("/api/canchas", {\n            method: "POST",\n            headers: {\n              "Content-Type": "application/json",\n            },\n            body: JSON.stringify({ muro, sector, nombreDetalle }),\n          });\n\n          if (!response.ok) {\n            const error = await response.json();\n            throw new Error(error.message || "Error al crear cancha");\n          }\n\n          // Limpiar formulario\n          document.getElementById("muro").value = "";\n          document.getElementById("sector").value = "";\n          document.getElementById("nombre-detalle").value = "";\n\n          // Recargar tabla\n          await cargarCanchas();\n\n          mostrarMensaje("Cancha creada exitosamente", "success");\n        } catch (error) {\n          console.error("Error al crear cancha:", error);\n          mostrarMensaje("Error al crear la cancha: " + error.message, "error");\n        } finally {\n          cargando = false;\n          btnCrearCancha.textContent = "Crear Cancha";\n          btnCrearCancha.disabled = false;\n        }\n      }\n\n      // === FUNCI\xD3N DE CARGA DE CANCHAS ===\n      async function cargarCanchas() {\n        try {\n          const response = await fetch("/api/canchas");\n          if (!response.ok) {\n            throw new Error("Error al cargar canchas");\n          }\n\n          todasLasCanchas = await response.json();\n          console.log("\u{1F5C2}\uFE0F Datos de canchas cargados:", todasLasCanchas);\n          if (todasLasCanchas.length > 0) {\n            console.log("\u{1F50D} Primer cancha ejemplo:", todasLasCanchas[0]);\n            console.log(\n              "\u{1F3F7}\uFE0F Campos disponibles:",\n              Object.keys(todasLasCanchas[0]),\n            );\n          }\n          aplicarFiltros();\n        } catch (error) {\n          console.error("Error al cargar canchas:", error);\n          mostrarMensaje("Error al cargar las canchas", "error");\n        }\n      }\n\n      // Mostrar canchas filtradas\n      function mostrarCanchas(canchas) {\n        renderizarCanchas(canchas);\n        actualizarMapaDashboard(canchas);\n      }\n\n      // Renderizar tabla de canchas con paginaci\xF3n\n      function renderizarCanchas(canchas) {\n        canchasFiltradas = canchas;\n        paginaActual = 1; // Resetear a la primera p\xE1gina cuando cambian los datos\n        renderizarPaginaCanchas();\n      }\n\n      // Renderizar p\xE1gina espec\xEDfica de canchas\n      function renderizarPaginaCanchas() {\n        const inicio = (paginaActual - 1) * filasPorPagina;\n        const fin = inicio + filasPorPagina;\n        const canchasPagina = canchasFiltradas.slice(inicio, fin);\n\n        canchasTBody.innerHTML = canchasPagina\n          .map(\n            (cancha) => `\n          <tr data-cancha-id="${cancha.id}" class="cancha-row">\n            <td style="text-align: center;">\n              <input type="checkbox" class="cancha-checkbox" data-cancha-id="${cancha.id}" data-cancha-nombre="${cancha.nombre}">\n            </td>\n            <td><strong>${cancha.nombre.toUpperCase()}</strong></td>\n            <td>\n              <span class="estado estado-${cancha.estado_actual.toLowerCase().replace(/\\s+/g, "-")}">\n                ${cancha.estado_actual}\n              </span>\n            </td>\n            <td>\n              <span class="empresa-actual empresa-${cancha.empresa_actual.toLowerCase().replace(/\\s+/g, "-")}">\n                ${cancha.empresa_actual}\n              </span>\n            </td>\n            <td>${new Date(cancha.created_at).toLocaleDateString("es-ES")}</td>\n            <td>\n              <button class="btn-mapa" data-cancha-id="${cancha.id}" data-cancha-nombre="${cancha.nombre}" type="button" style="background:none; border:none; font-size:1.5rem; cursor:pointer; padding:0.5rem; transition: transform 0.2s;" title="Ver en mapa">\u{1F5FA}\uFE0F</button>\n            </td>\n            <td>\n              <div class="actions" data-cancha-id="${cancha.id}" data-estado="${cancha.estado_actual}" data-empresa="${cancha.empresa_actual}">\n              </div>\n            </td>\n          </tr>\n        `,\n          )\n          .join("");\n\n        // Agregar event listeners para botones del mapa inmediatamente despu\xE9s de renderizar\n        setTimeout(() => {\n          console.log("\u{1F527} Agregando event listeners para botones del mapa...");\n          document.querySelectorAll(".btn-mapa").forEach((btn, index) => {\n            console.log(`\u{1F527} Configurando bot\xF3n ${index}:`, btn.dataset);\n            btn.addEventListener("click", (e) => {\n              const canchaId = e.target.dataset.canchaId;\n              const canchaName = e.target.dataset.canchaNombre;\n              console.log("\u{1F5FA}\uFE0F Bot\xF3n de mapa clickeado:", {\n                canchaId,\n                canchaName,\n              });\n              console.log("\u{1F50D} Datasets disponibles:", e.target.dataset);\n              abrirMapaModal(canchaId, canchaName);\n            });\n          });\n\n          // Agregar listeners de checkboxes\n          attachCheckboxListeners();\n        }, 100); // Peque\xF1o delay para asegurar que el DOM est\xE9 actualizado\n\n        actualizarAcciones();\n        actualizarControlesPaginacion();\n      }\n\n      // Actualizar controles de paginaci\xF3n\n      function actualizarControlesPaginacion() {\n        const totalCanchas = canchasFiltradas.length;\n        const totalPaginas = Math.ceil(totalCanchas / filasPorPagina);\n        const inicio = (paginaActual - 1) * filasPorPagina + 1;\n        const fin = Math.min(inicio + filasPorPagina - 1, totalCanchas);\n\n        document.getElementById("pagination-start").textContent =\n          totalCanchas > 0 ? inicio : 0;\n        document.getElementById("pagination-end").textContent = fin;\n        document.getElementById("pagination-total").textContent = totalCanchas;\n        document.getElementById("pagina-actual").textContent = paginaActual;\n        document.getElementById("total-paginas").textContent =\n          totalPaginas || 1;\n\n        // Habilitar/deshabilitar botones\n        document.getElementById("btn-primera-pagina").disabled =\n          paginaActual === 1;\n        document.getElementById("btn-pagina-anterior").disabled =\n          paginaActual === 1;\n        document.getElementById("btn-pagina-siguiente").disabled =\n          paginaActual >= totalPaginas;\n        document.getElementById("btn-ultima-pagina").disabled =\n          paginaActual >= totalPaginas;\n      }\n\n      // Actualizar botones de acci\xF3n seg\xFAn empresa seleccionada\n      function actualizarAcciones() {\n        console.log("Actualizando acciones para empresa:", empresaLogueada);\n        const actionsDivs = document.querySelectorAll(".actions");\n\n        console.log("Encontrados", actionsDivs.length, "divs de acciones");\n\n        actionsDivs.forEach((div, index) => {\n          const canchaId = div.dataset.canchaId;\n          const estado = div.dataset.estado;\n          const empresaActual = div.dataset.empresa;\n\n          console.log(\n            `Procesando div ${index}: canchaId=${canchaId}, estado=${estado}, empresaActual=${empresaActual}`,\n          );\n\n          const botonesHTML = generarBotonesAccion(\n            canchaId,\n            estado,\n            empresaActual,\n          );\n          console.log(`Botones generados: ${botonesHTML}`);\n          div.innerHTML = botonesHTML;\n        });\n\n        // Agregar event listeners a los botones\n        agregarEventListeners();\n        console.log("Event listeners agregados");\n\n        // Agregar event listeners de doble-click\n        agregarEventListenersDobleClick();\n      }\n\n      // Generar botones seg\xFAn empresa y estado\n      function generarBotonesAccion(canchaId, estado, empresaActual) {\n        console.log(\n          `generarBotonesAccion: canchaId=${canchaId}, estado=${estado}, empresaActual=${empresaActual}`,\n        );\n        console.log("empresaLogueada:", empresaLogueada);\n\n        if (!empresaLogueada) {\n          console.log("No hay empresa logueada");\n          return \'<span style="color:#666;">Selecciona tu empresa</span>\';\n        }\n\n        const botones = [];\n        const empresaId = empresaLogueada.id;\n        console.log("Empresa ID:", empresaId);\n\n        // AngloAmerican\n        if (empresaId === 1) {\n          console.log("Procesando para AngloAmerican");\n          if (estado === "Creada") {\n            console.log("Estado es Creada, agregando bot\xF3n enviar a Besalco");\n            botones.push(\n              `<button class="btn-accion" data-accion="enviar-besalco" data-cancha-id="${canchaId}">\u{1F4E4} Enviar a Besalco</button>`,\n            );\n          } else if (estado === "Validada") {\n            console.log("Estado es Validada, agregando bot\xF3n cerrar cancha");\n            botones.push(\n              `<button class="btn-accion btn-success" data-accion="abrir-modal-cierre" data-cancha-id="${canchaId}">\u{1F512} Cerrar Cancha</button>`,\n            );\n          } else if (\n            estado === "En Proceso" &&\n            empresaActual === "AngloAmerican"\n          ) {\n            console.log(\n              "Estado es En Proceso y empresa actual es AngloAmerican",\n            );\n            // Buscar la cancha para verificar validaciones\n            const cancha = todasLasCanchas.find((c) => c.id == canchaId);\n            if (cancha) {\n              const validaciones = cancha.validaciones || [];\n              console.log("Validaciones encontradas:", validaciones);\n              const hasLinkapsis = validaciones.some(\n                (v) => v.empresa === "Linkapsis" && v.estado === "VALIDADO",\n              );\n              const hasLlayLlay = validaciones.some(\n                (v) => v.empresa === "LlayLlay" && v.estado === "VALIDADO",\n              );\n              const hasBesalco = validaciones.some(\n                (v) => v.empresa === "Besalco" && v.estado === "VALIDADO",\n              );\n\n              console.log("Estado validaciones:", {\n                hasLinkapsis,\n                hasLlayLlay,\n                hasBesalco,\n              });\n\n              if (hasLinkapsis && hasLlayLlay && hasBesalco) {\n                console.log(\n                  "Todas las validaciones completas, agregando bot\xF3n PDF",\n                );\n                botones.push(\n                  `<button class="btn-accion btn-pdf" data-accion="exportar-pdf" data-cancha-id="${canchaId}">\u{1F4C4} PDF</button>`,\n                );\n              }\n            }\n          } else if (estado === "Finalizada" || estado === "Cerrada") {\n            console.log("Estado es Finalizada/Cerrada, agregando bot\xF3n PDF");\n            // Para canchas finalizadas o cerradas, siempre mostrar el bot\xF3n PDF\n            botones.push(\n              `<button class="btn-accion btn-pdf" data-accion="exportar-pdf" data-cancha-id="${canchaId}">\u{1F4C4} PDF</button>`,\n            );\n          }\n        }\n\n        // Besalco\n        else if (empresaId === 2) {\n          if (\n            (estado === "En Espera" || estado === "Rechazada, en Espera") &&\n            empresaActual === "Besalco"\n          ) {\n            // Cancha en espera - Recepcionar para revisar\n            botones.push(\n              `<button class="btn-accion btn-info" data-accion="recepcionar-besalco" data-cancha-id="${canchaId}">\u{1F4CB} Recepcionar Trabajo</button>`,\n            );\n          } else if (estado === "En Proceso" && empresaActual === "Besalco") {\n            // Cancha en proceso - Validar trabajo activo\n            botones.push(\n              `<button class="btn-accion btn-success" data-accion="validar-besalco" data-cancha-id="${canchaId}">\u{1F6E0}\uFE0F Gestionar</button>`,\n            );\n          }\n        }\n\n        // Linkapsis\n        else if (empresaId === 3) {\n          if (estado === "En Espera" && empresaActual === "Linkapsis") {\n            // Cancha en espera - Recepcionar para revisar\n            botones.push(\n              `<button class="btn-accion btn-info" data-accion="recepcionar-linkapsis" data-cancha-id="${canchaId}">\u{1F4CB} Recepcionar Trabajo</button>`,\n            );\n          } else if (estado === "En Proceso" && empresaActual === "Linkapsis") {\n            // Cancha en proceso - Validar espesores\n            botones.push(\n              `<button class="btn-accion btn-success" data-accion="validar-linkapsis" data-cancha-id="${canchaId}">\u{1F4CF} Gestionar</button>`,\n            );\n          }\n        }\n\n        // LlayLlay\n        else if (empresaId === 4) {\n          if (estado === "En Espera" && empresaActual === "LlayLlay") {\n            // Cancha en espera - Recepcionar para revisar\n            botones.push(\n              `<button class="btn-accion btn-info" data-accion="recepcionar-llayllay" data-cancha-id="${canchaId}">\u{1F4CB} Recepcionar Trabajo</button>`,\n            );\n          } else if (estado === "En Proceso" && empresaActual === "LlayLlay") {\n            // Cancha en proceso - Validar densidad\n            botones.push(\n              `<button class="btn-accion btn-success" data-accion="validar-llayllay" data-cancha-id="${canchaId}">\u{1F9EA} Gestionar</button>`,\n            );\n          }\n        }\n\n        return botones.length > 0\n          ? botones.join("")\n          : \'<span style="color:#666;">Sin acciones disponibles</span>\';\n      }\n\n      // Generar botones de administraci\xF3n (solo para AngloAmerican)\n      // NOTA: Las funciones generarBotonesAdmin() y actualizarColumnaAdmin() fueron eliminadas\n      // porque ahora se usa el sistema de selecci\xF3n m\xFAltiple con checkboxes\n\n      // Agregar event listeners a botones de acci\xF3n\n      function agregarEventListeners() {\n        document.querySelectorAll(".btn-accion").forEach((btn) => {\n          btn.addEventListener("click", manejarAccion);\n        });\n\n        // Los event listeners para botones del mapa se agregan en renderizarCanchas()\n        console.log("\u{1F5B1}\uFE0F Event listeners de acciones agregados");\n      }\n\n      // Agregar event listeners de doble-click a las filas de la tabla\n      function agregarEventListenersDobleClick() {\n        document.querySelectorAll(".cancha-row").forEach((row) => {\n          row.addEventListener("dblclick", (e) => {\n            const canchaId = e.currentTarget.dataset.canchaId;\n            console.log("\u{1F5B1}\uFE0F Doble-click en cancha:", canchaId);\n            hacerZoomEnMapaDashboard(canchaId);\n          });\n        });\n        console.log("\u2705 Event listeners de doble-click agregados");\n      }\n\n      // Enviar mensaje al iframe del mapa para hacer zoom a una cancha\n      function hacerZoomEnMapaDashboard(canchaId) {\n        const mapContainer = document.getElementById("dashboard-map-container");\n        const iframe = mapContainer?.querySelector("iframe");\n\n        if (!iframe || !iframe.contentWindow) {\n          console.log("\u26A0\uFE0F Iframe del mapa no disponible");\n          return;\n        }\n\n        // Enviar mensaje al iframe\n        iframe.contentWindow.postMessage(\n          {\n            type: "zoom-to-cancha",\n            canchaId: canchaId,\n          },\n          "*",\n        );\n\n        console.log("\u{1F4E4} Mensaje de zoom enviado al mapa:", canchaId);\n      }\n\n      // Manejar acciones de botones\n      async function manejarAccion(e) {\n        if (cargando) return;\n\n        const accion = e.target.dataset.accion;\n        const canchaId = parseInt(e.target.dataset.canchaId);\n\n        // Manejar apertura de modales de RECEPCI\xD3N (solo lectura + bot\xF3n Comenzar)\n        if (accion === "recepcionar-besalco") {\n          abrirModalRecepcionBesalco(canchaId);\n          return;\n        } else if (accion === "recepcionar-linkapsis") {\n          abrirModalRecepcionLinkapsis(canchaId);\n          return;\n        } else if (accion === "recepcionar-llayllay") {\n          abrirModalRecepcionLlayLlay(canchaId);\n          return;\n        }\n\n        // Manejar apertura de modales de VALIDACI\xD3N (formulario completo)\n        else if (accion === "validar-besalco") {\n          abrirModalBesalco(canchaId);\n          return;\n        } else if (accion === "validar-linkapsis") {\n          abrirModalLinkapsis(canchaId);\n          return;\n        } else if (accion === "validar-llayllay") {\n          abrirModalLlayLlay(canchaId);\n          return;\n        }\n\n        // Otros modales\n        else if (accion === "abrir-modal-cierre") {\n          abrirModalCierre(canchaId);\n          return;\n        } else if (accion === "abrir-modal-borrar") {\n          abrirModalBorrar(canchaId);\n          return;\n        } else if (accion === "exportar-pdf") {\n          await exportarPDF(canchaId);\n          return;\n        }\n\n        // Confirmar acci\xF3n de cierre\n        if (accion === "cerrar") {\n          if (!confirm("\xBFConfirmas el cierre de esta cancha?")) {\n            return;\n          }\n        }\n\n        // Pedir observaciones para rechazos (acciones directas legacy)\n        let observaciones = null;\n        if (accion.includes("rechazar")) {\n          const empresaNombre =\n            accion === "rechazar-besalco"\n              ? "Besalco"\n              : accion === "rechazar-linkapsis"\n                ? "Linkapsis"\n                : "LlayLlay";\n          observaciones = prompt(\n            `Observaciones del rechazo por ${empresaNombre}:`,\n          );\n          if (observaciones === null) return; // Usuario cancel\xF3\n        }\n\n        try {\n          cargando = true;\n          const textoOriginal = e.target.textContent;\n          e.target.disabled = true;\n          e.target.textContent = "Procesando...";\n\n          const response = await fetch(`/api/canchas/${canchaId}/action`, {\n            method: "POST",\n            headers: {\n              "Content-Type": "application/json",\n            },\n            body: JSON.stringify({ accion, observaciones }),\n          });\n\n          if (!response.ok) {\n            const error = await response.json();\n            throw new Error(error.message || "Error al ejecutar acci\xF3n");\n          }\n\n          await cargarCanchas();\n          mostrarMensaje("Acci\xF3n realizada exitosamente", "success");\n        } catch (error) {\n          console.error("Error en acci\xF3n:", error);\n          mostrarMensaje("Error: " + error.message, "error");\n        } finally {\n          cargando = false;\n        }\n      }\n\n      // Mostrar mensajes\n      function mostrarMensaje(mensaje, tipo) {\n        const div = document.createElement("div");\n        div.className = tipo;\n        div.innerHTML = `<strong>${tipo === "success" ? "\xC9xito:" : "Error:"}</strong> ${mensaje}`;\n\n        mensajeContainer.appendChild(div);\n\n        setTimeout(() => {\n          div.remove();\n        }, 5000);\n      }\n\n      // === FUNCIONES DE MODALES DE VALIDACI\xD3N ===\n      let canchaIdActual = null;\n\n      // Funci\xF3n para cargar historial de observaciones de una cancha\n      async function cargarHistorialObservaciones(\n        canchaId,\n        historialElementId,\n      ) {\n        try {\n          const response = await fetch(`/api/canchas/${canchaId}/validaciones`);\n          if (!response.ok) {\n            throw new Error("Error al cargar historial");\n          }\n\n          const validaciones = await response.json();\n          const historialElement = document.getElementById(historialElementId);\n          const content = historialElement.querySelector(".historial-content");\n\n          if (validaciones.length === 0) {\n            content.innerHTML =\n              \'<p style="color: #666; font-style: italic; text-align: center; padding: 2rem;">No hay observaciones previas</p>\';\n          } else {\n            content.innerHTML = `\n              <div class="historial-timeline">\n                ${validaciones\n                  .map((val, index) => {\n                    let medicionesHtml = "";\n\n                    if (val.mediciones) {\n                      if (val.mediciones.espesores) {\n                        // Mediciones de Linkapsis (formato anterior)\n                        medicionesHtml = `\n                        <div class="medicion-linea">\n                          <span class="medicion-label">\u{1F4CF} Medici\xF3n de Espesor:</span> <strong>${val.mediciones.espesores.join(", ")} ${val.mediciones.unidad || "metros"}</strong>\n                          ${val.mediciones.promedio ? `<br><span style="font-size: 0.95rem; color: #666; margin-left: 1.5rem;">\u{1F4CA} Promedio: <strong>${val.mediciones.promedio} ${val.mediciones.unidad || "metros"}</strong></span>` : ""}\n                        </div>`;\n                      } else if (val.mediciones.espesor) {\n                        // Nueva medici\xF3n de Linkapsis\n                        medicionesHtml = `\n                        <div class="medicion-linea">\n                          <span class="medicion-label">\u{1F4CF} Medici\xF3n de Espesor:</span> <strong>${val.mediciones.espesor} ${val.mediciones.unidad || "metros"}</strong>\n                        </div>`;\n                      } else if (val.mediciones.densidad) {\n                        // Mediciones de LlayLlay\n                        medicionesHtml = `\n                        <div class="medicion-linea">\n                          <span class="medicion-label">\u2696\uFE0F Medici\xF3n de Densidad:</span> <strong>${val.mediciones.densidad} ${val.mediciones.unidad || "g/cm\xB3"}</strong>\n                        </div>`;\n                      }\n                    }\n\n                    const empresaNombre =\n                      val.empresa_validadora?.nombre || "Empresa desconocida";\n                    const empresaClass = empresaNombre\n                      .toLowerCase()\n                      .replace(/\\s+/g, "");\n\n                    // Generar separador solo si no es la \xFAltima entrada\n                    const separador =\n                      index < validaciones.length - 1\n                        ? `\n                    <div class="separador-empresas">\n                      \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n                    </div>`\n                        : "";\n\n                    return `\n                    <div class="historial-entry empresa-${empresaClass}">\n                      <div class="empresa-nombre">\u{1F3E2} ${empresaNombre}</div>\n                      <div class="fecha-linea">\n                        <span class="fecha-label">\u{1F4C5} Fecha:</span> ${new Date(\n                          val.created_at,\n                        ).toLocaleDateString("es-ES", {\n                          weekday: "short",\n                          year: "numeric",\n                          month: "short",\n                          day: "numeric",\n                          hour: "2-digit",\n                          minute: "2-digit",\n                        })}\n                      </div>\n                      <div class="observacion-linea">\n                        <span class="observacion-label">\u{1F4AC} Observaciones:</span> "${val.observaciones || "Sin observaciones espec\xEDficas"}"\n                      </div>\n                      ${medicionesHtml}\n                    </div>${separador}`;\n                  })\n                  .join("")}\n              </div>\n            `;\n          }\n        } catch (error) {\n          console.error("Error al cargar historial:", error);\n          const historialElement = document.getElementById(historialElementId);\n          const content = historialElement.querySelector(".historial-content");\n          content.innerHTML =\n            \'<p style="color: #e74c3c;">Error al cargar historial</p>\';\n        }\n      }\n\n      function abrirModalBesalco(canchaId) {\n        canchaIdActual = canchaId;\n        const modal = document.getElementById("validacion-besalco-modal");\n        const form = document.getElementById("form-validacion-besalco");\n\n        // Limpiar formulario\n        form.reset();\n\n        // Cargar historial de observaciones\n        cargarHistorialObservaciones(canchaId, "historial-besalco");\n\n        // Mostrar modal\n        modal.classList.add("show");\n      }\n\n      function abrirModalLinkapsis(canchaId) {\n        canchaIdActual = canchaId;\n        const modal = document.getElementById("validacion-linkapsis-modal");\n        const form = document.getElementById("form-validacion-linkapsis");\n\n        // Limpiar formulario b\xE1sico\n        form.reset();\n\n        // Limpiar checkboxes espec\xEDficamente\n        document.getElementById("trabajo-corte").checked = false;\n        document.getElementById("trabajo-relleno").checked = false;\n\n        // Verificar si ya existen coordenadas previas de Linkapsis\n        verificarCoordenadasExistentes(canchaId);\n\n        // Cargar historial de observaciones (incluye observaciones de Besalco)\n        cargarHistorialObservaciones(canchaId, "historial-linkapsis");\n\n        // Mostrar modal\n        modal.classList.add("show");\n      }\n\n      async function verificarCoordenadasExistentes(canchaId) {\n        try {\n          const response = await fetch(`/api/canchas/${canchaId}/validaciones`);\n          const validaciones = await response.json();\n\n          console.log("Validaciones obtenidas:", validaciones);\n\n          // Buscar validaciones de Linkapsis (empresa_validadora_id = 3) que tengan coordenadas\n          if (validaciones && validaciones.length > 0) {\n            const validacionLinkapsis = validaciones.find(\n              (v) =>\n                v.empresa_validadora_id === 3 &&\n                v.mediciones &&\n                v.mediciones.coordenadas,\n            );\n\n            if (\n              validacionLinkapsis &&\n              validacionLinkapsis.mediciones &&\n              validacionLinkapsis.mediciones.coordenadas\n            ) {\n              const coordenadas = validacionLinkapsis.mediciones.coordenadas;\n              console.log("Coordenadas existentes encontradas:", coordenadas);\n              console.log(\n                "Validaci\xF3n Linkapsis completa:",\n                validacionLinkapsis,\n              );\n\n              // Pre-llenar los campos con coordenadas existentes\n              const coordMap = {\n                "p1-norte": coordenadas.p1?.norte || "",\n                "p1-este": coordenadas.p1?.este || "",\n                "p1-cota": coordenadas.p1?.cota || "",\n                "p2-norte": coordenadas.p2?.norte || "",\n                "p2-este": coordenadas.p2?.este || "",\n                "p2-cota": coordenadas.p2?.cota || "",\n                "p3-norte": coordenadas.p3?.norte || "",\n                "p3-este": coordenadas.p3?.este || "",\n                "p3-cota": coordenadas.p3?.cota || "",\n                "p4-norte": coordenadas.p4?.norte || "",\n                "p4-este": coordenadas.p4?.este || "",\n                "p4-cota": coordenadas.p4?.cota || "",\n              };\n\n              console.log("Mapa de coordenadas para llenar:", coordMap);\n\n              // Llenar los campos si tienen valores\n              Object.keys(coordMap).forEach((id) => {\n                const input = document.getElementById(id);\n                if (input && coordMap[id]) {\n                  console.log(\n                    `Llenando campo ${id} con valor: ${coordMap[id]}`,\n                  );\n                  input.value = coordMap[id];\n                } else if (input) {\n                  console.log(\n                    `Campo ${id} encontrado pero sin valor para llenar`,\n                  );\n                } else {\n                  console.log(`Campo ${id} NO encontrado en el DOM`);\n                }\n              });\n\n              // Mantener espesor y checkboxes vac\xEDos para nueva evaluaci\xF3n\n              const espesorInput = document.getElementById("espesor-linkapsis");\n              if (espesorInput) {\n                espesorInput.value = "";\n              }\n\n              // Mantener checkboxes de tipo de trabajo sin marcar para nueva evaluaci\xF3n\n              document.getElementById("trabajo-corte").checked = false;\n              document.getElementById("trabajo-relleno").checked = false;\n            } else {\n              console.log(\n                "No se encontraron validaciones previas de Linkapsis con coordenadas",\n              );\n              console.log("Validaciones disponibles:", validaciones);\n              // No hay coordenadas previas, limpiar todos los campos\n              const coordInputs = [\n                "p1-norte",\n                "p1-este",\n                "p1-cota",\n                "p2-norte",\n                "p2-este",\n                "p2-cota",\n                "p3-norte",\n                "p3-este",\n                "p3-cota",\n                "p4-norte",\n                "p4-este",\n                "p4-cota",\n              ];\n\n              coordInputs.forEach((id) => {\n                const input = document.getElementById(id);\n                if (input) input.value = "";\n              });\n            }\n          }\n        } catch (error) {\n          console.error("Error al verificar coordenadas existentes:", error);\n          // En caso de error, limpiar campos por seguridad\n          const coordInputs = [\n            "p1-norte",\n            "p1-este",\n            "p1-cota",\n            "p2-norte",\n            "p2-este",\n            "p2-cota",\n            "p3-norte",\n            "p3-este",\n            "p3-cota",\n            "p4-norte",\n            "p4-este",\n            "p4-cota",\n          ];\n\n          coordInputs.forEach((id) => {\n            const input = document.getElementById(id);\n            if (input) input.value = "";\n          });\n        }\n      }\n\n      function abrirModalLlayLlay(canchaId) {\n        canchaIdActual = canchaId;\n        const modal = document.getElementById("validacion-llayllay-modal");\n        const form = document.getElementById("form-validacion-llayllay");\n\n        // Limpiar formulario\n        form.reset();\n\n        // Cargar historial de observaciones (incluye Besalco y Linkapsis)\n        cargarHistorialObservaciones(canchaId, "historial-llayllay");\n\n        // Mostrar modal\n        modal.classList.add("show");\n      }\n\n      // ============ MODALES DE RECEPCI\xD3N (solo lectura + bot\xF3n Comenzar) ============\n\n      function abrirModalRecepcionBesalco(canchaId) {\n        canchaIdActual = canchaId;\n        const modal = document.getElementById("recepcion-besalco-modal");\n\n        // Cargar historial de observaciones\n        cargarHistorialObservaciones(canchaId, "historial-recepcion-besalco");\n\n        // Mostrar modal\n        modal.classList.add("show");\n      }\n\n      function abrirModalRecepcionLinkapsis(canchaId) {\n        canchaIdActual = canchaId;\n        const modal = document.getElementById("recepcion-linkapsis-modal");\n\n        // Cargar historial de observaciones\n        cargarHistorialObservaciones(canchaId, "historial-recepcion-linkapsis");\n\n        // Mostrar modal\n        modal.classList.add("show");\n      }\n\n      function abrirModalRecepcionLlayLlay(canchaId) {\n        canchaIdActual = canchaId;\n        const modal = document.getElementById("recepcion-llayllay-modal");\n\n        // Cargar historial de observaciones\n        cargarHistorialObservaciones(canchaId, "historial-recepcion-llayllay");\n\n        // Mostrar modal\n        modal.classList.add("show");\n      }\n\n      // ============ MODALES DE CIERRE Y BORRADO ============\n\n      function abrirModalCierre(canchaId) {\n        canchaIdActual = canchaId;\n        const modal = document.getElementById("cerrar-cancha-modal");\n\n        // Cargar historial completo para revisi\xF3n final\n        cargarHistorialObservaciones(canchaId, "historial-cierre");\n\n        // Mostrar modal\n        modal.classList.add("show");\n      }\n\n      function abrirModalBorrar(canchaId) {\n        canchaIdActual = canchaId;\n        const modal = document.getElementById("borrar-cancha-modal");\n        const inputConfirmacion = document.getElementById(\n          "confirmacion-borrado",\n        );\n        const btnConfirmar = document.getElementById("confirmar-borrado");\n\n        // Limpiar input y deshabilitar bot\xF3n\n        inputConfirmacion.value = "";\n        btnConfirmar.disabled = true;\n\n        // Cargar historial que se eliminar\xE1\n        cargarHistorialObservaciones(canchaId, "historial-borrado");\n\n        // Mostrar modal\n        modal.classList.add("show");\n      }\n\n      // Funci\xF3n para exportar PDF\n      async function exportarPDF(canchaId) {\n        try {\n          cargando = true;\n          mostrarMensaje("Generando PDF...", "info");\n\n          // Abrir la URL de descarga directamente en una nueva ventana\n          const url = `/api/canchas/${canchaId}/download-pdf`;\n          window.open(url, "_blank");\n\n          mostrarMensaje("PDF generado correctamente", "success");\n        } catch (error) {\n          console.error("Error al exportar PDF:", error);\n          mostrarMensaje("Error al generar PDF: " + error.message, "error");\n        } finally {\n          cargando = false;\n        }\n      }\n\n      function cerrarTodosLosModales() {\n        document.querySelectorAll(".modal").forEach((modal) => {\n          modal.classList.remove("show");\n        });\n        canchaIdActual = null;\n      }\n\n      // Cerrar modal al hacer click fuera\n      window.addEventListener("click", (e) => {\n        if (e.target.classList.contains("modal")) {\n          cerrarTodosLosModales();\n        }\n      });\n\n      // Event listeners para botones de cerrar y cancelar\n      // === SISTEMA DE SELECCI\xD3N M\xDALTIPLE ===\n      let selectedCanchas = new Set();\n\n      function initializeSelectionSystem() {\n        const selectAllCheckbox = document.getElementById(\n          "select-all-checkbox",\n        );\n        const bulkActionsBar = document.getElementById("bulk-actions-bar");\n        const btnBulkDelete = document.getElementById("btn-bulk-delete");\n        const btnBulkTimeline = document.getElementById("btn-bulk-timeline");\n        const btnClearSelection = document.getElementById(\n          "btn-clear-selection",\n        );\n\n        // Seleccionar/Deseleccionar todas\n        if (selectAllCheckbox) {\n          selectAllCheckbox.addEventListener("change", (e) => {\n            const checkboxes = document.querySelectorAll(".cancha-checkbox");\n            checkboxes.forEach((checkbox) => {\n              checkbox.checked = e.target.checked;\n              const canchaId = checkbox.dataset.canchaId;\n              if (e.target.checked) {\n                selectedCanchas.add(canchaId);\n                checkbox.closest("tr").classList.add("selected");\n              } else {\n                selectedCanchas.delete(canchaId);\n                checkbox.closest("tr").classList.remove("selected");\n              }\n            });\n            updateBulkActionsBar();\n          });\n        }\n\n        // Limpiar selecci\xF3n\n        if (btnClearSelection) {\n          btnClearSelection.addEventListener("click", clearSelection);\n        }\n\n        // Borrar canchas seleccionadas\n        if (btnBulkDelete) {\n          btnBulkDelete.addEventListener("click", handleBulkDelete);\n        }\n\n        // Ver timeline de canchas seleccionadas\n        if (btnBulkTimeline) {\n          btnBulkTimeline.addEventListener("click", openTimelineModal);\n        }\n      }\n\n      // Manejar click en checkbox individual (se agrega despu\xE9s de renderizar)\n      function attachCheckboxListeners() {\n        document.querySelectorAll(".cancha-checkbox").forEach((checkbox) => {\n          checkbox.addEventListener("change", (e) => {\n            const canchaId = e.target.dataset.canchaId;\n            const row = e.target.closest("tr");\n\n            if (e.target.checked) {\n              selectedCanchas.add(canchaId);\n              row.classList.add("selected");\n            } else {\n              selectedCanchas.delete(canchaId);\n              row.classList.remove("selected");\n              document.getElementById("select-all-checkbox").checked = false;\n            }\n\n            updateBulkActionsBar();\n          });\n        });\n\n        // Prevenir que el click en checkbox dispare el evento de la fila\n        document.querySelectorAll(".cancha-checkbox").forEach((checkbox) => {\n          checkbox.addEventListener("click", (e) => {\n            e.stopPropagation();\n          });\n        });\n      }\n\n      function updateBulkActionsBar() {\n        const bulkActionsBar = document.getElementById("bulk-actions-bar");\n        const selectedCount = document.getElementById("selected-count");\n        const btnBulkDelete = document.getElementById("btn-bulk-delete");\n        const count = selectedCanchas.size;\n\n        if (count > 0) {\n          bulkActionsBar.classList.remove("hidden");\n          selectedCount.textContent = `${count} cancha${count > 1 ? "s" : ""} seleccionada${count > 1 ? "s" : ""}`;\n\n          // Mostrar bot\xF3n de borrar solo si es AngloAmerican\n          if (empresaLogueada && empresaLogueada.nombre === "AngloAmerican") {\n            btnBulkDelete.classList.remove("hidden");\n          } else {\n            btnBulkDelete.classList.add("hidden");\n          }\n        } else {\n          bulkActionsBar.classList.add("hidden");\n        }\n      }\n\n      function clearSelection() {\n        selectedCanchas.clear();\n        document.querySelectorAll(".cancha-checkbox").forEach((checkbox) => {\n          checkbox.checked = false;\n          checkbox.closest("tr").classList.remove("selected");\n        });\n        document.getElementById("select-all-checkbox").checked = false;\n        updateBulkActionsBar();\n      }\n\n      async function handleBulkDelete() {\n        if (selectedCanchas.size === 0) return;\n\n        const canchaIds = Array.from(selectedCanchas);\n\n        // Si es solo una cancha, usar el modal normal\n        if (canchaIds.length === 1) {\n          abrirModalBorrar(canchaIds[0]);\n          return;\n        }\n\n        // Si son m\xFAltiples canchas, abrir modal adaptado para borrado masivo\n        abrirModalBorradoMasivo(canchaIds);\n      }\n\n      function abrirModalBorradoMasivo(canchaIds) {\n        const modal = document.getElementById("borrar-cancha-modal");\n        const inputConfirmacion = document.getElementById(\n          "confirmacion-borrado",\n        );\n        const btnConfirmar = document.getElementById("confirmar-borrado");\n        const historialDiv = document.getElementById("historial-borrado");\n\n        // Limpiar input y deshabilitar bot\xF3n\n        inputConfirmacion.value = "";\n        btnConfirmar.disabled = true;\n\n        // Mostrar lista de canchas que se borrar\xE1n\n        const canchaNames = canchaIds.map((id) => {\n          const checkbox = document.querySelector(\n            `.cancha-checkbox[data-cancha-id="${id}"]`,\n          );\n          return checkbox ? checkbox.dataset.canchaNombre : `ID ${id}`;\n        });\n\n        historialDiv.innerHTML = `\n          <h4>\u26A0\uFE0F Se eliminar\xE1n ${canchaIds.length} canchas:</h4>\n          <div class="historial-content" style="max-height: 200px; overflow-y: auto;">\n            <ul style="margin: 0; padding-left: 1.5rem;">\n              ${canchaNames.map((name) => `<li><strong>${name}</strong></li>`).join("")}\n            </ul>\n            <p style="margin-top: 1rem; color: #e74c3c; font-weight: 600;">\n              Se eliminar\xE1n todas las validaciones y observaciones asociadas a estas canchas.\n            </p>\n          </div>\n        `;\n\n        // Guardar los IDs para el borrado\n        modal.dataset.bulkDeleteIds = JSON.stringify(canchaIds);\n        modal.dataset.isBulkDelete = "true";\n\n        // Mostrar modal\n        modal.classList.add("show");\n      }\n\n      document.addEventListener("DOMContentLoaded", () => {\n        // === SISTEMA DE SELECCI\xD3N M\xDALTIPLE ===\n        initializeSelectionSystem();\n\n        // Botones de cerrar (X)\n        document.querySelectorAll(".close-btn").forEach((btn) => {\n          btn.addEventListener("click", cerrarTodosLosModales);\n        });\n\n        // Botones de cancelar\n        document.querySelectorAll(".btn-cancel").forEach((btn) => {\n          btn.addEventListener("click", cerrarTodosLosModales);\n        });\n\n        // Formularios de validaci\xF3n\n        configurarFormulariosValidacion();\n      });\n\n      function configurarFormulariosValidacion() {\n        // Formulario Besalco\n        const formBesalco = document.getElementById("form-validacion-besalco");\n        if (formBesalco) {\n          formBesalco.addEventListener("submit", procesarValidacionBesalco);\n\n          const btnRechazar = formBesalco.querySelector(".btn-rechazar");\n          if (btnRechazar) {\n            btnRechazar.addEventListener("click", procesarRechazoBesalco);\n          }\n        }\n\n        // Botones de "Comenzar Trabajo" en modales de recepci\xF3n\n        const btnComenzarBesalco = document.getElementById(\n          "btn-comenzar-besalco",\n        );\n        if (btnComenzarBesalco) {\n          btnComenzarBesalco.addEventListener("click", () =>\n            comenzarTrabajo("Besalco"),\n          );\n        }\n\n        const btnComenzarLinkapsis = document.getElementById(\n          "btn-comenzar-linkapsis",\n        );\n        if (btnComenzarLinkapsis) {\n          btnComenzarLinkapsis.addEventListener("click", () =>\n            comenzarTrabajo("Linkapsis"),\n          );\n        }\n\n        const btnComenzarLlayLlay = document.getElementById(\n          "btn-comenzar-llayllay",\n        );\n        if (btnComenzarLlayLlay) {\n          btnComenzarLlayLlay.addEventListener("click", () =>\n            comenzarTrabajo("LlayLlay"),\n          );\n        }\n\n        // Formulario Linkapsis\n        const formLinkapsis = document.getElementById(\n          "form-validacion-linkapsis",\n        );\n        if (formLinkapsis) {\n          formLinkapsis.addEventListener("submit", procesarValidacionLinkapsis);\n\n          const btnRechazar = formLinkapsis.querySelector(".btn-rechazar");\n          if (btnRechazar) {\n            btnRechazar.addEventListener("click", procesarRechazoLinkapsis);\n          }\n        }\n\n        // Formulario LlayLlay\n        const formLlayLlay = document.getElementById(\n          "form-validacion-llayllay",\n        );\n        if (formLlayLlay) {\n          formLlayLlay.addEventListener("submit", procesarValidacionLlayLlay);\n\n          const btnRechazar = formLlayLlay.querySelector(".btn-rechazar");\n          if (btnRechazar) {\n            btnRechazar.addEventListener("click", procesarRechazoLlayLlay);\n          }\n        }\n\n        // Bot\xF3n de cierre definitivo\n        const btnConfirmarCierre = document.getElementById("confirmar-cierre");\n        if (btnConfirmarCierre) {\n          btnConfirmarCierre.addEventListener("click", async () => {\n            if (\n              confirm(\n                "\xBFEst\xE1s seguro de que deseas cerrar esta cancha definitivamente?",\n              )\n            ) {\n              await ejecutarAccion("cerrar_cancha", canchaIdActual, null);\n              cerrarTodosLosModales();\n            }\n          });\n        }\n\n        // Input de confirmaci\xF3n de borrado\n        const inputConfirmacion = document.getElementById(\n          "confirmacion-borrado",\n        );\n        const btnConfirmarBorrado =\n          document.getElementById("confirmar-borrado");\n\n        if (inputConfirmacion && btnConfirmarBorrado) {\n          inputConfirmacion.addEventListener("input", () => {\n            btnConfirmarBorrado.disabled =\n              inputConfirmacion.value.trim() !== "borrar-cancha";\n          });\n\n          btnConfirmarBorrado.addEventListener("click", async () => {\n            const modal = document.getElementById("borrar-cancha-modal");\n            const isBulkDelete = modal.dataset.isBulkDelete === "true";\n\n            if (isBulkDelete) {\n              // Borrado masivo\n              const canchaIds = JSON.parse(modal.dataset.bulkDeleteIds || "[]");\n              await ejecutarBorradoMasivo(canchaIds);\n            } else {\n              // Borrado individual\n              await ejecutarAccion("borrar_cancha", canchaIdActual, null);\n            }\n\n            // Limpiar dataset y cerrar modal\n            delete modal.dataset.isBulkDelete;\n            delete modal.dataset.bulkDeleteIds;\n            cerrarTodosLosModales();\n          });\n        }\n      }\n\n      // === FUNCIONES DE PROCESAMIENTO DE VALIDACIONES ===\n\n      // Funci\xF3n para cambiar estado de "En Espera" a "En Proceso"\n      async function comenzarTrabajo(empresa) {\n        try {\n          if (!canchaIdActual) {\n            mostrarMensaje("No hay cancha seleccionada", "error");\n            return;\n          }\n\n          console.log(\n            `Comenzando trabajo para ${empresa} en cancha ${canchaIdActual}`,\n          );\n\n          // Cambiar estado de En Espera (7) o Rechazada, en Espera (8) \u2192 En Proceso (3)\n          const response = await fetch(\n            `/api/canchas/${canchaIdActual}/accion`,\n            {\n              method: "POST",\n              headers: { "Content-Type": "application/json" },\n              body: JSON.stringify({\n                accion: "tomar_trabajo",\n                empresa: empresa,\n              }),\n            },\n          );\n\n          if (!response.ok) {\n            const errorData = await response.json();\n            throw new Error(errorData.error || "Error al comenzar trabajo");\n          }\n\n          const result = await response.json();\n          console.log("Trabajo iniciado:", result);\n\n          mostrarMensaje(`\u2705 Trabajo iniciado para ${empresa}`, "success");\n          cerrarTodosLosModales();\n\n          // Recargar canchas para actualizar la tabla\n          await cargarCanchas();\n        } catch (error) {\n          console.error("Error al comenzar trabajo:", error);\n          mostrarMensaje(`Error: ${error.message}`, "error");\n        }\n      }\n\n      async function procesarValidacionBesalco(e) {\n        e.preventDefault();\n\n        const observaciones = document\n          .getElementById("besalco-observaciones")\n          .value.trim();\n        if (!observaciones) {\n          mostrarMensaje("Por favor ingresa observaciones", "error");\n          return;\n        }\n\n        await ejecutarAccion(\n          "finalizar_besalco",\n          canchaIdActual,\n          observaciones,\n        );\n      }\n\n      async function procesarRechazoBesalco(e) {\n        e.preventDefault();\n\n        const observaciones = document\n          .getElementById("besalco-observaciones")\n          .value.trim();\n        if (!observaciones) {\n          mostrarMensaje(\n            "Por favor ingresa observaciones del rechazo",\n            "error",\n          );\n          return;\n        }\n\n        await ejecutarAccion("rechazar_besalco", canchaIdActual, observaciones);\n      }\n\n      async function procesarValidacionLinkapsis(e) {\n        e.preventDefault();\n\n        const observaciones = document\n          .getElementById("linkapsis-observaciones")\n          .value.trim();\n        const espesor = parseFloat(\n          document.getElementById("linkapsis-espesor").value,\n        );\n\n        if (!observaciones || !espesor) {\n          mostrarMensaje(\n            "Por favor completa las observaciones y la medici\xF3n de espesor",\n            "error",\n          );\n          return;\n        }\n\n        // Verificar si es revalidaci\xF3n\n        const isRevalidacion = await esRevalidacion(\n          canchaIdActual,\n          "Linkapsis",\n        );\n\n        // Recopilar tipo de trabajo\n        const tipoTrabajo = [];\n        if (document.getElementById("trabajo-corte").checked) {\n          tipoTrabajo.push("corte");\n        }\n        if (document.getElementById("trabajo-relleno").checked) {\n          tipoTrabajo.push("relleno");\n        }\n\n        // Recopilar coordenadas de los 4 puntos\n        const coordenadas = {\n          p1: {\n            norte:\n              parseFloat(document.getElementById("p1-norte").value) || null,\n            este: parseFloat(document.getElementById("p1-este").value) || null,\n            cota: parseFloat(document.getElementById("p1-cota").value) || null,\n          },\n          p2: {\n            norte:\n              parseFloat(document.getElementById("p2-norte").value) || null,\n            este: parseFloat(document.getElementById("p2-este").value) || null,\n            cota: parseFloat(document.getElementById("p2-cota").value) || null,\n          },\n          p3: {\n            norte:\n              parseFloat(document.getElementById("p3-norte").value) || null,\n            este: parseFloat(document.getElementById("p3-este").value) || null,\n            cota: parseFloat(document.getElementById("p3-cota").value) || null,\n          },\n          p4: {\n            norte:\n              parseFloat(document.getElementById("p4-norte").value) || null,\n            este: parseFloat(document.getElementById("p4-este").value) || null,\n            cota: parseFloat(document.getElementById("p4-cota").value) || null,\n          },\n        };\n\n        const mediciones = {\n          espesor: espesor,\n          unidad: "metros",\n          tipoTrabajo: tipoTrabajo,\n          coordenadas: coordenadas,\n          isRevalidacion: isRevalidacion,\n        };\n\n        await ejecutarAccion(\n          "validar_linkapsis",\n          canchaIdActual,\n          observaciones,\n          mediciones,\n        );\n      }\n\n      async function procesarRechazoLinkapsis(e) {\n        e.preventDefault();\n\n        const observaciones = document\n          .getElementById("linkapsis-observaciones")\n          .value.trim();\n        const espesor = parseFloat(\n          document.getElementById("linkapsis-espesor").value,\n        );\n\n        if (!observaciones) {\n          mostrarMensaje(\n            "Por favor ingresa observaciones del rechazo",\n            "error",\n          );\n          return;\n        }\n\n        // Incluir mediciones aunque sea rechazo\n        let mediciones = null;\n        if (espesor) {\n          // Recopilar tipo de trabajo si est\xE1n marcados\n          const tipoTrabajo = [];\n          if (document.getElementById("trabajo-corte").checked) {\n            tipoTrabajo.push("corte");\n          }\n          if (document.getElementById("trabajo-relleno").checked) {\n            tipoTrabajo.push("relleno");\n          }\n\n          // Recopilar coordenadas si est\xE1n disponibles\n          const coordenadas = {\n            p1: {\n              norte:\n                parseFloat(document.getElementById("p1-norte").value) || null,\n              este:\n                parseFloat(document.getElementById("p1-este").value) || null,\n              cota:\n                parseFloat(document.getElementById("p1-cota").value) || null,\n            },\n            p2: {\n              norte:\n                parseFloat(document.getElementById("p2-norte").value) || null,\n              este:\n                parseFloat(document.getElementById("p2-este").value) || null,\n              cota:\n                parseFloat(document.getElementById("p2-cota").value) || null,\n            },\n            p3: {\n              norte:\n                parseFloat(document.getElementById("p3-norte").value) || null,\n              este:\n                parseFloat(document.getElementById("p3-este").value) || null,\n              cota:\n                parseFloat(document.getElementById("p3-cota").value) || null,\n            },\n            p4: {\n              norte:\n                parseFloat(document.getElementById("p4-norte").value) || null,\n              este:\n                parseFloat(document.getElementById("p4-este").value) || null,\n              cota:\n                parseFloat(document.getElementById("p4-cota").value) || null,\n            },\n          };\n\n          mediciones = {\n            espesor: espesor,\n            unidad: "metros",\n            tipoTrabajo: tipoTrabajo,\n            coordenadas: coordenadas,\n          };\n        }\n\n        await ejecutarAccion(\n          "rechazar_linkapsis",\n          canchaIdActual,\n          observaciones,\n          mediciones,\n        );\n      }\n\n      async function procesarValidacionLlayLlay(e) {\n        e.preventDefault();\n\n        const observaciones = document\n          .getElementById("llayllay-observaciones")\n          .value.trim();\n        const densidad = parseFloat(\n          document.getElementById("llayllay-densidad").value,\n        );\n\n        if (!observaciones || !densidad) {\n          mostrarMensaje(\n            "Por favor completa observaciones y densidad",\n            "error",\n          );\n          return;\n        }\n\n        // Verificar si es revalidaci\xF3n\n        const isRevalidacion = await esRevalidacion(canchaIdActual, "LlayLlay");\n\n        const mediciones = {\n          densidad: densidad,\n          unidad: "g/cm\xB3",\n          isRevalidacion: isRevalidacion,\n        };\n\n        await ejecutarAccion(\n          "validar_llay_llay",\n          canchaIdActual,\n          observaciones,\n          mediciones,\n        );\n      }\n\n      async function procesarRechazoLlayLlay(e) {\n        e.preventDefault();\n\n        const observaciones = document\n          .getElementById("llayllay-observaciones")\n          .value.trim();\n        const densidad = parseFloat(\n          document.getElementById("llayllay-densidad").value,\n        );\n\n        if (!observaciones) {\n          mostrarMensaje(\n            "Por favor ingresa observaciones del rechazo",\n            "error",\n          );\n          return;\n        }\n\n        // Incluir mediciones aunque sea rechazo\n        let mediciones = null;\n        if (densidad) {\n          mediciones = {\n            densidad: densidad,\n            unidad: "g/cm\xB3",\n          };\n        }\n\n        await ejecutarAccion(\n          "rechazar_llay_llay",\n          canchaIdActual,\n          observaciones,\n          mediciones,\n        );\n      }\n\n      // Funci\xF3n auxiliar para determinar si es revalidaci\xF3n\n      async function esRevalidacion(canchaId, empresa) {\n        try {\n          const response = await fetch(`/api/canchas/${canchaId}`);\n          if (!response.ok) return false;\n\n          const data = await response.json();\n          const cancha = data.cancha;\n\n          // Buscar validaciones previas de la misma empresa\n          const validacionesPrevias =\n            cancha.validaciones?.filter(\n              (v) => v.empresa === empresa && v.estado === "VALIDADO",\n            ) || [];\n\n          return validacionesPrevias.length > 0;\n        } catch (error) {\n          console.error("Error al verificar revalidaci\xF3n:", error);\n          return false;\n        }\n      }\n\n      // Funci\xF3n unificada para ejecutar acciones\n      async function ejecutarAccion(\n        accion,\n        canchaId,\n        observaciones,\n        mediciones = null,\n      ) {\n        try {\n          cargando = true;\n\n          const payload = {\n            accion: accion,\n            observaciones: observaciones,\n            usuario: usuarioLogueado, // Incluir informaci\xF3n del usuario actual\n          };\n\n          if (mediciones) {\n            payload.mediciones = mediciones;\n          }\n\n          const response = await fetch(`/api/canchas/${canchaId}/accion`, {\n            method: "POST",\n            headers: {\n              "Content-Type": "application/json",\n            },\n            body: JSON.stringify(payload),\n          });\n\n          if (!response.ok) {\n            throw new Error("Error en la respuesta del servidor");\n          }\n\n          const resultado = await response.json();\n\n          cerrarTodosLosModales();\n          mostrarMensaje(`Acci\xF3n completada exitosamente`, "success");\n\n          // Recargar canchas para mostrar cambios\n          await cargarCanchas();\n        } catch (error) {\n          console.error("Error al ejecutar acci\xF3n:", error);\n          mostrarMensaje("Error al procesar la acci\xF3n", "error");\n        } finally {\n          cargando = false;\n        }\n      }\n\n      // Funci\xF3n para ejecutar borrado masivo de canchas\n      async function ejecutarBorradoMasivo(canchaIds) {\n        try {\n          cargando = true;\n          let eliminadas = 0;\n          let errores = 0;\n\n          for (const canchaId of canchaIds) {\n            try {\n              // Usar el endpoint de acci\xF3n con borrar_cancha\n              const response = await fetch(`/api/canchas/${canchaId}/accion`, {\n                method: "POST",\n                headers: {\n                  "Content-Type": "application/json",\n                },\n                body: JSON.stringify({\n                  accion: "borrar_cancha",\n                }),\n              });\n\n              if (response.ok) {\n                eliminadas++;\n              } else {\n                errores++;\n                console.error(`Error al borrar cancha ${canchaId}`);\n              }\n            } catch (error) {\n              errores++;\n              console.error(`Error al borrar cancha ${canchaId}:`, error);\n            }\n          }\n\n          // Limpiar selecci\xF3n\n          clearSelection();\n\n          // Mostrar resultado\n          if (eliminadas > 0) {\n            mostrarMensaje(\n              `\u2705 ${eliminadas} cancha${eliminadas > 1 ? "s eliminadas" : " eliminada"} correctamente${errores > 0 ? `. ${errores} error${errores > 1 ? "es" : ""}` : ""}`,\n              errores > 0 ? "warning" : "success",\n            );\n          } else {\n            mostrarMensaje("\u274C No se pudo eliminar ninguna cancha", "error");\n          }\n\n          // Recargar canchas\n          await cargarCanchas();\n        } catch (error) {\n          console.error("Error en borrado masivo:", error);\n          mostrarMensaje("Error al borrar las canchas seleccionadas", "error");\n        } finally {\n          cargando = false;\n        }\n      }\n\n      // ========== FUNCIONES DEL TIMELINE ==========\n\n      // Generar color aleatorio vibrante para cada cancha\n      // Generar colores muy distintos entre s\xED usando una paleta predefinida\n      function generateDistinctColors(count) {\n        // Paleta de colores vibrantes y muy diferentes\n        const distinctColors = [\n          "#ef4444", // Rojo vibrante\n          "#3b82f6", // Azul brillante\n          "#10b981", // Verde esmeralda\n          "#f59e0b", // Naranja dorado\n          "#8b5cf6", // P\xFArpura\n          "#ec4899", // Rosa fuerte\n          "#06b6d4", // Cyan\n          "#84cc16", // Lima\n          "#f97316", // Naranja intenso\n          "#6366f1", // \xCDndigo\n          "#14b8a6", // Turquesa\n          "#eab308", // Amarillo\n          "#a855f7", // Violeta\n          "#22c55e", // Verde brillante\n          "#f43f5e", // Rosa rojo\n          "#0ea5e9", // Azul cielo\n        ];\n\n        // Si hay m\xE1s canchas que colores, generar colores adicionales con HSL espaciados\n        if (count > distinctColors.length) {\n          const step = 360 / count;\n          return Array.from({ length: count }, (_, i) => {\n            const hue = Math.floor(i * step);\n            return `hsl(${hue}, 75%, 55%)`;\n          });\n        }\n\n        // Mezclar los colores para que no sigan un patr\xF3n predecible\n        const shuffled = [...distinctColors].sort(() => Math.random() - 0.5);\n        return shuffled.slice(0, count);\n      }\n\n      // Abrir modal de timeline\n      async function openTimelineModal() {\n        if (selectedCanchas.size === 0) {\n          mostrarMensaje(\n            "Selecciona al menos una cancha para ver el timeline",\n            "warning",\n          );\n          return;\n        }\n\n        const modal = document.getElementById("timeline-modal");\n        const legendContainer = document.getElementById("timeline-legend");\n        const eventsContainer = document.getElementById("timeline-events");\n        const modalTitle = modal.querySelector("h3"); // Get title element\n\n        modal.style.display = "flex";\n\n        try {\n          cargando = true;\n\n          // Obtener transiciones de todas las canchas seleccionadas\n          const canchaIds = Array.from(selectedCanchas);\n          const timelineData = await fetchTimelineData(canchaIds);\n\n          // === SMART TITLE LOGIC ===\n          if (timelineData.length > 1) {\n            modalTitle.innerHTML = `\n              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>\n              </svg>\n              Timeline Comparativo\n            `;\n          } else if (timelineData.length === 1) {\n            modalTitle.innerHTML = `\n              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>\n              </svg>\n              Timeline de Transiciones\n            `;\n          } else {\n            modalTitle.innerHTML = `\n              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>\n              </svg>\n              Timeline\n            `;\n          }\n\n          // Generar colores distintos para cada cancha\n          const colors = generateDistinctColors(timelineData.length);\n          const canchaColors = {};\n          timelineData.forEach((data, index) => {\n            canchaColors[data.canchaId] = colors[index];\n          });\n\n          // Renderizar leyenda\n          renderLegend(timelineData, canchaColors, legendContainer);\n\n          // Renderizar timeline\n          renderTimeline(timelineData, canchaColors, eventsContainer);\n\n          // Inicializar checkboxes DESPU\xC9S de renderizar todo\n          if (timelineData.length >= 2) {\n            initializeTimelineCheckboxes();\n          }\n        } catch (error) {\n          console.error("Error cargando timeline:", error);\n          mostrarMensaje("Error al cargar el timeline", "error");\n        } finally {\n          cargando = false;\n        }\n      }\n\n      // Obtener datos de transiciones para m\xFAltiples canchas\n      async function fetchTimelineData(canchaIds) {\n        const promises = canchaIds.map(async (id) => {\n          try {\n            const response = await fetch(`/api/canchas/${id}/timeline`);\n            if (!response.ok) throw new Error("Error al obtener timeline");\n\n            const data = await response.json();\n            const cancha = todasLasCanchas.find((c) => c.id == id);\n\n            return {\n              canchaId: id,\n              canchaName: cancha?.nombre || `Cancha ${id}`,\n              transiciones: data.transiciones || [],\n            };\n          } catch (error) {\n            console.error(`Error obteniendo timeline de cancha ${id}:`, error);\n            return {\n              canchaId: id,\n              canchaName: `Cancha ${id}`,\n              transiciones: [],\n            };\n          }\n        });\n\n        return await Promise.all(promises);\n      }\n\n      // Renderizar leyenda de canchas\n      function renderLegend(timelineData, canchaColors, container) {\n        if (!timelineData || timelineData.length === 0) {\n          container.innerHTML = "";\n          return;\n        }\n\n        const title =\n          timelineData.length === 1\n            ? "Cancha en Timeline"\n            : `Canchas en Timeline (${timelineData.length})`;\n\n        // Mostrar checkboxes solo si hay 2 o m\xE1s canchas\n        const showCheckboxes = timelineData.length >= 2;\n\n        container.innerHTML =\n          `<div class="timeline-legend-container">\n            <div class="timeline-legend-title">\n              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <circle cx="12" cy="12" r="10"></circle>\n                <path d="M12 6v6l4 2"></path>\n              </svg>\n              ${title}\n            </div>\n            <div class="timeline-legend-items">` +\n          timelineData\n            .map((data) => {\n              const color = canchaColors[data.canchaId];\n              const displayName = data.canchaName.replace(/_/g, " ");\n              const checkboxHtml = showCheckboxes\n                ? `<input type="checkbox" \n                         class="timeline-legend-checkbox" \n                         data-cancha-id="${data.canchaId}" \n                         checked \n                         title="Mostrar/ocultar eventos de esta cancha">`\n                : "";\n\n              return `\n              <div class="timeline-legend-item ${showCheckboxes ? "with-checkbox" : ""}" \n                   style="color: ${color};" \n                   data-cancha-id="${data.canchaId}">\n                ${checkboxHtml}\n                <span class="timeline-legend-dot" style="background-color: ${color};"></span>\n                <span class="timeline-legend-name">${displayName}</span>\n              </div>\n            `;\n            })\n            .join("") +\n          `</div></div>`;\n      }\n\n      // Inicializar event listeners de checkboxes del timeline\n      function initializeTimelineCheckboxes() {\n        console.log("\u{1F527} Inicializando checkboxes del timeline...");\n\n        const checkboxes = document.querySelectorAll(\n          ".timeline-legend-checkbox",\n        );\n        console.log(`\u{1F4CA} Encontrados ${checkboxes.length} checkboxes`);\n\n        checkboxes.forEach((checkbox, index) => {\n          const canchaId = checkbox.dataset.canchaId;\n          console.log(\n            `\u2705 Configurando checkbox ${index} para cancha ID: ${canchaId}`,\n          );\n\n          checkbox.addEventListener("change", (e) => {\n            const isVisible = e.target.checked;\n            console.log(\n              `\u{1F504} Toggle cancha ${canchaId}: ${isVisible ? "MOSTRAR" : "OCULTAR"}`,\n            );\n            toggleCanchaVisibility(canchaId, isVisible);\n          });\n        });\n      }\n\n      // Toggle visibilidad de eventos de una cancha espec\xEDfica\n      function toggleCanchaVisibility(canchaId, isVisible) {\n        console.log(\n          `\u{1F3AF} toggleCanchaVisibility llamado: cancha=${canchaId}, visible=${isVisible}`,\n        );\n\n        const events = document.querySelectorAll(\n          `.timeline-event[data-cancha-id="${canchaId}"]`,\n        );\n        const legendItem = document.querySelector(\n          `.timeline-legend-item[data-cancha-id="${canchaId}"]`,\n        );\n\n        console.log(\n          `\u{1F4CD} Encontrados ${events.length} eventos para cancha ${canchaId}`,\n        );\n        console.log(`\u{1F4CD} Legend item encontrado:`, legendItem ? "S\xCD" : "NO");\n\n        events.forEach((event) => {\n          if (isVisible) {\n            event.classList.remove("hidden");\n          } else {\n            event.classList.add("hidden");\n          }\n        });\n\n        // Actualizar estilo del item de leyenda\n        if (legendItem) {\n          if (isVisible) {\n            legendItem.classList.remove("dimmed");\n          } else {\n            legendItem.classList.add("dimmed");\n          }\n        }\n\n        console.log(`\u2705 Toggle completado para cancha ${canchaId}`);\n      }\n\n      // Renderizar timeline visual\n      function renderTimeline(timelineData, canchaColors, container) {\n        container.innerHTML = "";\n        // Obtener todas las fechas para calcular el rango\n        let allDates = [];\n        let allTransitions = [];\n\n        timelineData.forEach((data) => {\n          data.transiciones.forEach((t) => {\n            allDates.push(new Date(t.fecha_transicion));\n            allTransitions.push({\n              ...t,\n              canchaId: data.canchaId,\n              canchaName: data.canchaName,\n              color: canchaColors[data.canchaId],\n            });\n          });\n        });\n\n        if (allDates.length === 0) {\n          container.innerHTML =\n            \'<p style="text-align: center; padding: 2rem; color: #666;">No hay transiciones para mostrar</p>\';\n          return;\n        }\n\n        // Ordenar transiciones por fecha\n        allTransitions.sort(\n          (a, b) => new Date(a.fecha_transicion) - new Date(b.fecha_transicion),\n        );\n\n        const minDate = new Date(Math.min(...allDates));\n        const maxDate = new Date(Math.max(...allDates));\n        const timeRange = maxDate - minDate || 86400000; // M\xEDnimo 1 d\xEDa\n\n        // Usar el ancho real del contenedor y calcular m\xE1rgenes en porcentaje\n        const totalWidth = container.parentElement.offsetWidth;\n        const marginLeftPercent = 0.02; // 2% a la izquierda\n        const marginRightPercent = 0.05; // 5% a la derecha (m\xE1s espacio para la flecha)\n        const marginLeft = totalWidth * marginLeftPercent;\n        const marginRight = totalWidth * marginRightPercent;\n        const containerWidth = totalWidth - marginLeft - marginRight; // Ancho \xFAtil sin m\xE1rgenes\n        const containerHeight = container.parentElement.offsetHeight;\n        const startX = marginLeft; // Comenzar despu\xE9s del margen izquierdo\n        const centerY = containerHeight / 2;\n\n        // Agrupar eventos por posici\xF3n X para evitar superposici\xF3n\n        const eventsByPosition = {};\n\n        allTransitions.forEach((transicion) => {\n          const eventDate = new Date(transicion.fecha_transicion);\n          const xPosition =\n            startX + ((eventDate - minDate) / timeRange) * containerWidth;\n          const xKey = Math.round(xPosition / 5) * 5; // Agrupar por cada 5px\n\n          if (!eventsByPosition[xKey]) {\n            eventsByPosition[xKey] = [];\n          }\n          eventsByPosition[xKey].push({ transicion, xPosition });\n        });\n\n        // Renderizar cada evento\n        Object.values(eventsByPosition).forEach((events) => {\n          events.forEach((eventData, stackIndex) => {\n            const { transicion, xPosition } = eventData;\n            const eventDate = new Date(transicion.fecha_transicion);\n\n            // Alternar eventos arriba y abajo de la l\xEDnea central\n            const isTop = stackIndex % 2 === 0;\n            const offsetMultiplier = Math.floor(stackIndex / 2) + 1;\n            const baseOffset = 80;\n            const yOffset = baseOffset * offsetMultiplier;\n            const yPosition = isTop ? centerY - yOffset : centerY + yOffset;\n\n            // Crear marcador de evento\n            const eventDiv = document.createElement("div");\n            eventDiv.className = "timeline-event";\n            eventDiv.setAttribute("data-cancha-id", transicion.canchaId);\n            eventDiv.style.position = "absolute";\n            eventDiv.style.left = `${xPosition}px`;\n            eventDiv.style.top = `${centerY}px`;\n            eventDiv.style.width = "0px";\n            eventDiv.style.height = "0px";\n            eventDiv.style.color = transicion.color;\n\n            // L\xEDnea perpendicular desde el eje hasta el punto\n            const line = document.createElement("div");\n            line.className = "timeline-line";\n            line.style.position = "absolute";\n            line.style.backgroundColor = transicion.color;\n            line.style.width = "4px";\n            line.style.left = "50%";\n            line.style.transform = "translateX(-50%)";\n\n            if (isTop) {\n              line.style.height = `${yOffset}px`;\n              line.style.bottom = "0px";\n            } else {\n              line.style.height = `${yOffset}px`;\n              line.style.top = "0px";\n            }\n\n            // Mapeo de nombres amigables para timeline\n            const NOMBRES_ACCIONES_TIMELINE = {\n              // AngloAmerican - Bot\xF3n "CREAR CANCHA"\n              crear_cancha: "Creaci\xF3n de Cancha",\n              crear_cancha_con_poligono: "Creaci\xF3n de Cancha",\n              \n              // AngloAmerican - Bot\xF3n "ENVIAR A BESALCO"\n              enviar_besalco: "Env\xEDo a Besalco",\n              \n              // AngloAmerican - Bot\xF3n "CERRAR CANCHA"\n              cerrar_cancha: "Cierre de Cancha",\n\n              // Besalco - Bot\xF3n "RECEPCIONAR TRABAJO"\n              recepcionar_besalco: "Trabajo recepcionado por Besalco",\n              \n              // Besalco - Bot\xF3n "GESTIONAR" (finalizar y enviar a Linkapsis)\n              finalizar_besalco: "Trabajo finalizado por Besalco",\n              \n              // Besalco - Bot\xF3n "RECHAZAR"\n              rechazar_besalco: "Trabajo rechazado por Besalco",\n\n              // Linkapsis - Bot\xF3n "RECEPCIONAR TRABAJO"\n              recepcionar_linkapsis: "Trabajo recepcionado por Linkapsis",\n              \n              // Linkapsis - Bot\xF3n "GESTIONAR" (validar espesores y enviar a LlayLlay)\n              validar_linkapsis: "Espesores validados por Linkapsis",\n              \n              // Linkapsis - Bot\xF3n "RECHAZAR"\n              rechazar_linkapsis: "Espesores rechazados por Linkapsis",\n\n              // LlayLlay - Bot\xF3n "RECEPCIONAR TRABAJO"\n              recepcionar_llay_llay: "Trabajo recepcionado por LlayLlay",\n              \n              // LlayLlay - Bot\xF3n "GESTIONAR" (validar densidad y enviar a AA)\n              validar_llay_llay: "Densidad validada por LlayLlay",\n              \n              // LlayLlay - Bot\xF3n "RECHAZAR"\n              rechazar_llay_llay: "Densidad rechazada por LlayLlay",\n\n              // Gen\xE9rico - Cualquier bot\xF3n "RECHAZAR"\n              rechazar_cancha: "Cancha rechazada",\n              \n              // Tomar trabajo (si se usa)\n              tomar_trabajo: "Trabajo tomado",\n            };\n\n            const accionRaw = transicion.accion || "Sin acci\xF3n";\n            let accionTexto =\n              NOMBRES_ACCIONES_TIMELINE[accionRaw] ||\n              // Fallback: capitalizar si no est\xE1 en el mapeo\n              accionRaw\n                .replace(/_/g, " ")\n                .replace(/\\b\\w/g, (l) => l.toUpperCase());\n\n            // Para \'tomar_trabajo\', agregar el nombre de la empresa din\xE1micamente\n            if (accionRaw === "tomar_trabajo" && transicion.empresa_nueva) {\n              accionTexto = `Trabajo tomado por ${transicion.empresa_nueva}`;\n            }\n\n            // Mapeo de iniciales de empresas para mostrar en los puntos\n            const INICIALES_EMPRESAS = {\n              AngloAmerican: "AA",\n              Besalco: "BS",\n              Linkapsis: "LK",\n              LlayLlay: "LL",\n            };\n\n            // Colores espec\xEDficos para cada empresa\n            const COLORES_EMPRESAS = {\n              AA: "#3b82f6", // Azul\n              BS: "#06b6d4", // Celeste/Cyan\n              LK: "#f97316", // Naranja\n              LL: "#ef4444", // Rojo\n            };\n\n            // Obtener iniciales de la empresa (usar empresa_nueva como prioridad)\n            const empresaNombre =\n              transicion.empresa_nueva || transicion.empresa_anterior || "";\n            const inicialesEmpresa = INICIALES_EMPRESAS[empresaNombre] || "";\n\n            // Punto en el eje\n            const dot = document.createElement("div");\n            dot.className = "timeline-dot";\n            // Fondo blanco con borde de color de la cancha\n            dot.style.backgroundColor = "#ffffff";\n            dot.style.borderColor = transicion.color;\n            dot.title = `${transicion.canchaName}\\n${accionTexto}\\n${eventDate.toLocaleDateString("es-CL")}`;\n\n            // Agregar iniciales de la empresa dentro del punto\n            if (inicialesEmpresa) {\n              dot.textContent = inicialesEmpresa;\n              const colorInicial =\n                COLORES_EMPRESAS[inicialesEmpresa] || "#334155";\n              dot.style.color = colorInicial;\n              dot.style.display = "flex";\n              dot.style.alignItems = "center";\n              dot.style.justifyContent = "center";\n              dot.style.fontSize = "10px";\n              dot.style.fontWeight = "900";\n              dot.style.letterSpacing = "-0.5px";\n            }\n\n            // Etiqueta de la acci\xF3n\n            const label = document.createElement("div");\n            label.className = "timeline-label";\n\n            if (timelineData.length > 1) {\n              // Si hay m\xFAltiples canchas, mostrar nombre corto\n              const nombreCorto =\n                transicion.canchaName.length > 20\n                  ? transicion.canchaName.substring(0, 17) + "..."\n                  : transicion.canchaName;\n              label.innerHTML = `<strong style="color: ${transicion.color};">${nombreCorto}</strong><br/>${accionTexto}`;\n            } else {\n              label.textContent = accionTexto;\n            }\n\n            if (isTop) {\n              label.style.bottom = `${yOffset + 15}px`;\n            } else {\n              label.style.top = `${yOffset + 15}px`;\n            }\n\n            // Etiqueta de FECHA (Nueva implementaci\xF3n)\n            const dateLabel = document.createElement("div");\n            dateLabel.className = "timeline-event-date";\n            dateLabel.textContent = eventDate.toLocaleDateString("es-CL", {\n              day: "2-digit",\n              month: "short",\n            });\n\n            // A\xF1adir elementos al contenedor del evento\n            eventDiv.appendChild(line);\n            eventDiv.appendChild(dot);\n            eventDiv.appendChild(label);\n            eventDiv.appendChild(dateLabel);\n\n            container.appendChild(eventDiv);\n          });\n        });\n\n        // Renderizar marcadores de fecha en el eje\n        renderDateMarkers(\n          minDate,\n          maxDate,\n          containerWidth,\n          startX,\n          centerY,\n          container,\n        );\n      }\n\n      // Funci\xF3n para renderizar marcadores de fecha en el eje del timeline\n      function renderDateMarkers(\n        minDate,\n        maxDate,\n        containerWidth,\n        startX,\n        centerY,\n        container,\n      ) {\n        const rangoTotal = maxDate - minDate;\n        const diasTotales = rangoTotal / (1000 * 60 * 60 * 24);\n\n        // Calcular intervalo \xF3ptimo seg\xFAn el rango de fechas\n        let intervalo;\n        if (diasTotales <= 15)\n          intervalo = 2; // 2 d\xEDas\n        else if (diasTotales <= 30)\n          intervalo = 3; // 3 d\xEDas\n        else intervalo = 5; // 5 d\xEDas\n\n        // Generar marcadores\n        let currentDate = new Date(minDate);\n\n        while (currentDate <= maxDate) {\n          const xPosition =\n            startX + ((currentDate - minDate) / rangoTotal) * containerWidth;\n\n          const marker = document.createElement("div");\n          marker.className = "timeline-date-marker";\n          marker.style.left = `${xPosition}px`;\n          marker.style.top = `${centerY - 70}px`; // Posicionar arriba del eje\n\n          const label = document.createElement("div");\n          label.className = "timeline-date-marker-label";\n          label.textContent = currentDate.toLocaleDateString("es-CL", {\n            day: "numeric",\n            month: "short",\n          });\n\n          const line = document.createElement("div");\n          line.className = "timeline-date-marker-line";\n\n          // Agregar primero la etiqueta, luego la l\xEDnea (para que la l\xEDnea vaya hacia abajo)\n          marker.appendChild(label);\n          marker.appendChild(line);\n          container.appendChild(marker);\n\n          // Avanzar al siguiente marcador\n          currentDate.setDate(currentDate.getDate() + intervalo);\n        }\n      }\n\n      // Cerrar modal de timeline\n      const timelineCloseBtn = document.getElementById("timeline-close-btn");\n      if (timelineCloseBtn) {\n        timelineCloseBtn.addEventListener("click", () => {\n          const modal = document.getElementById("timeline-modal");\n          modal.style.display = "none";\n        });\n      }\n\n      // Funciones para el Modal del Mapa\n      function abrirMapaModal(canchaId, canchaName) {\n        console.log("\u{1F680} abrirMapaModal llamado con:", { canchaId, canchaName });\n\n        const modal = document.getElementById("mapModal");\n        const mapContainer = document.getElementById("mapContainer");\n        const canchaIdSpan = document.getElementById("mapCanchaId");\n        const closeBtn = document.getElementById("mapCloseBtn");\n\n        // Extraer el muro del nombre de la cancha (primera parte antes del primer _)\n        const muro = canchaName ? canchaName.split("_")[0] : null;\n        console.log(\n          `\u{1F5FA}\uFE0F Abriendo mapa para cancha ${canchaId} (${canchaName}) - Muro detectado: ${muro}`,\n        );\n\n        // Mostrar ID y nombre de la cancha en el t\xEDtulo\n        canchaIdSpan.textContent = `${canchaId} (${canchaName || "Sin nombre"})`;\n\n        // Agregar event listener al bot\xF3n de cerrar\n        closeBtn.addEventListener("click", cerrarMapaModal);\n\n        // Mostrar el modal\n        modal.classList.add("show");\n\n        // Agregar evento para cerrar con Escape\n        document.addEventListener("keydown", handleEscapeKey);\n\n        // Mostrar indicador de carga\n        mapContainer.innerHTML =\n          \'<div class="map-loading">Cargando mapa...</div>\';\n\n        // Cargar el mapa en un iframe con el filtro de muro y cancha ID\n        setTimeout(() => {\n          const iframe = document.createElement("iframe");\n          // Pasar el muro y canchaId como par\xE1metros en la URL\n          let mapUrl = "/mapbox-window";\n          const params = new URLSearchParams();\n\n          if (muro) {\n            params.set("muro", muro);\n          }\n          if (canchaId) {\n            params.set("canchaId", canchaId);\n          }\n\n          if (params.toString()) {\n            mapUrl += "?" + params.toString();\n          }\n\n          console.log("\u{1F310} URL del mapa:", mapUrl);\n          iframe.src = mapUrl;\n          iframe.style.width = "100%";\n          iframe.style.height = "100%";\n          iframe.style.border = "none";\n          iframe.style.borderRadius = "0 0 16px 16px";\n\n          mapContainer.innerHTML = "";\n          mapContainer.appendChild(iframe);\n        }, 300);\n      }\n\n      function cerrarMapaModal() {\n        const modal = document.getElementById("mapModal");\n        const mapContainer = document.getElementById("mapContainer");\n        const closeBtn = document.getElementById("mapCloseBtn");\n\n        modal.classList.remove("show");\n\n        // Remover event listeners\n        document.removeEventListener("keydown", handleEscapeKey);\n        closeBtn.removeEventListener("click", cerrarMapaModal);\n\n        // Limpiar el contenido del mapa\n        setTimeout(() => {\n          mapContainer.innerHTML = "";\n        }, 300);\n      }\n\n      function handleEscapeKey(e) {\n        if (e.key === "Escape") {\n          cerrarMapaModal();\n        }\n      }\n\n      // Cerrar modal al hacer clic fuera del contenido\n      document.addEventListener("click", function (e) {\n        const modal = document.getElementById("mapModal");\n        if (e.target === modal) {\n          cerrarMapaModal();\n        }\n\n        const createModal = document.getElementById("createCanchaModal");\n        if (e.target === createModal) {\n          cerrarModalCrearCancha();\n        }\n      });\n\n      // =====================================================\n      // FUNCIONES PARA CREAR CANCHA CON POL\xCDGONO\n      // =====================================================\n\n      // Variable global para almacenar las coordenadas del pol\xEDgono dibujado\n      let poligonoCoordinadas = null;\n\n      // Funci\xF3n para abrir el modal de crear cancha\n      function abrirModalCrearCancha() {\n        console.log("\u{1F3D7}\uFE0F Abriendo modal de crear cancha...");\n        const modal = document.getElementById("createCanchaModal");\n        const closeBtn = document.getElementById("createCanchaCloseBtn");\n\n        // Resetear formulario\n        document.getElementById("muro-select").value = "";\n        document.getElementById("sector-select").value = "";\n        document.getElementById("nombre-detalle-input").value = "";\n        document.getElementById("open-drawing-btn").disabled = true;\n        document.getElementById("create-cancha-btn").disabled = true;\n        document.getElementById("drawing-status").innerHTML = "";\n        document.getElementById("drawingMapContainer").style.display = "none";\n        poligonoCoordinadas = null;\n\n        // Inicializar estado del selector de sector\n        const sectorSelect = document.getElementById("sector-select");\n        sectorSelect.disabled = true;\n        sectorSelect.innerHTML =\n          \'<option value="">Selecciona un muro primero</option>\';\n\n        // Agregar event listeners\n        closeBtn.addEventListener("click", cerrarModalCrearCancha);\n        document\n          .getElementById("open-drawing-btn")\n          .addEventListener("click", abrirMapaDibujo);\n        document\n          .getElementById("create-cancha-btn")\n          .addEventListener("click", crearCanchaConPoligono);\n\n        // Agregar listeners para validar formulario\n        document\n          .getElementById("muro-select")\n          .addEventListener("change", validarFormularioCreacion);\n        document\n          .getElementById("sector-select")\n          .addEventListener("change", validarFormularioCreacion);\n        document\n          .getElementById("nombre-detalle-input")\n          .addEventListener("input", validarFormularioCreacion);\n\n        modal.classList.add("show");\n\n        // Agregar evento para cerrar con Escape\n        document.addEventListener("keydown", handleEscapeKeyCrear);\n      }\n\n      // Funci\xF3n para cerrar el modal de crear cancha\n      function cerrarModalCrearCancha() {\n        console.log("\u274C Cerrando modal de crear cancha...");\n        const modal = document.getElementById("createCanchaModal");\n        const closeBtn = document.getElementById("createCanchaCloseBtn");\n\n        modal.classList.remove("show");\n\n        // Remover event listeners\n        document.removeEventListener("keydown", handleEscapeKeyCrear);\n        window.removeEventListener("message", handleDrawingMessage);\n        closeBtn.removeEventListener("click", cerrarModalCrearCancha);\n        document\n          .getElementById("open-drawing-btn")\n          .removeEventListener("click", abrirMapaDibujo);\n        document\n          .getElementById("create-cancha-btn")\n          .removeEventListener("click", crearCanchaConPoligono);\n        document\n          .getElementById("muro-select")\n          .removeEventListener("change", validarFormularioCreacion);\n        document\n          .getElementById("sector-select")\n          .removeEventListener("change", validarFormularioCreacion);\n        document\n          .getElementById("nombre-detalle-input")\n          .removeEventListener("input", validarFormularioCreacion);\n\n        // Limpiar el contenido del mapa de dibujo\n        setTimeout(() => {\n          document.getElementById("drawingMapContainer").innerHTML = "";\n        }, 300);\n      }\n\n      // Funci\xF3n para validar el formulario y habilitar botones\n      function validarFormularioCreacion() {\n        const muro = document.getElementById("muro-select").value;\n        const sector = document.getElementById("sector-select").value;\n        const nombreDetalle = document\n          .getElementById("nombre-detalle-input")\n          .value.trim();\n\n        // Solo actualizar opciones de sector si el muro cambi\xF3\n        const sectorSelect = document.getElementById("sector-select");\n        if (sectorSelect.dataset.ultimoMuro !== muro) {\n          actualizarOpcionesSector(muro);\n          sectorSelect.dataset.ultimoMuro = muro;\n        }\n\n        const formularioCompleto = muro && sector && nombreDetalle;\n        document.getElementById("open-drawing-btn").disabled =\n          !formularioCompleto;\n\n        // Solo habilitar crear cancha si tambi\xE9n hay pol\xEDgono dibujado\n        const puedeCrear = formularioCompleto && poligonoCoordinadas;\n        document.getElementById("create-cancha-btn").disabled = !puedeCrear;\n\n        console.log("\u{1F50D} Validaci\xF3n formulario:", {\n          muro,\n          sector,\n          nombreDetalle,\n          formularioCompleto,\n          puedeCrear,\n        });\n      }\n\n      // Funci\xF3n para actualizar las opciones del selector de sector\n      function actualizarOpcionesSector(muro) {\n        const sectorSelect = document.getElementById("sector-select");\n\n        if (!muro) {\n          sectorSelect.disabled = true;\n          sectorSelect.innerHTML =\n            \'<option value="">Selecciona un muro primero</option>\';\n          return;\n        }\n\n        // Guardar la selecci\xF3n actual antes de regenerar\n        const seleccionActual = sectorSelect.value;\n\n        sectorSelect.disabled = false;\n\n        // Determinar el rango de sectores seg\xFAn el muro\n        let maxSector = 3; // Por defecto para MO y ME\n        if (muro === "MP") {\n          maxSector = 7;\n        }\n\n        // Generar opciones din\xE1micamente\n        let opciones = \'<option value="">Selecciona un sector</option>\';\n        for (let i = 1; i <= maxSector; i++) {\n          opciones += `<option value="S${i}">S${i}</option>`;\n        }\n\n        sectorSelect.innerHTML = opciones;\n\n        // Restaurar la selecci\xF3n anterior si es v\xE1lida\n        if (seleccionActual && seleccionActual.match(/^S[1-9]$/)) {\n          const numeroSector = parseInt(seleccionActual.substring(1));\n          if (numeroSector <= maxSector) {\n            sectorSelect.value = seleccionActual;\n          }\n        }\n\n        console.log(\n          `\u{1F4CD} Muro ${muro} seleccionado - Sectores disponibles: S1 a S${maxSector}`,\n        );\n      }\n\n      // Funci\xF3n para abrir el mapa de dibujo\n      function abrirMapaDibujo() {\n        console.log("\u{1F5FA}\uFE0F Abriendo mapa de dibujo...");\n        const muro = document.getElementById("muro-select").value;\n        const drawingContainer = document.getElementById("drawingMapContainer");\n        const statusDiv = document.getElementById("drawing-status");\n\n        // Mostrar status de carga\n        statusDiv.innerHTML = "\u{1F504} Cargando mapa de dibujo...";\n        statusDiv.className = "drawing-status info";\n\n        // Mostrar el contenedor del mapa\n        drawingContainer.style.display = "block";\n\n        // Crear iframe con el mapa de dibujo\n        setTimeout(() => {\n          const iframe = document.createElement("iframe");\n          iframe.src = `/mapbox-window?muro=${encodeURIComponent(muro)}&drawing=true`;\n          iframe.style.width = "100%";\n          iframe.style.height = "100%";\n          iframe.style.border = "none";\n\n          // Limpiar listener anterior si existe\n          window.removeEventListener("message", handleDrawingMessage);\n\n          // Agregar listener para mensajes del iframe\n          window.addEventListener("message", handleDrawingMessage);\n\n          drawingContainer.innerHTML = "";\n          drawingContainer.appendChild(iframe);\n\n          statusDiv.innerHTML = "\u{1F3A8} Herramientas de dibujo activas";\n          statusDiv.className = "drawing-status info";\n        }, 300);\n      }\n\n      // Funci\xF3n para manejar mensajes del iframe de dibujo\n      function handleDrawingMessage(event) {\n        if (event.data.type === "polygon-drawn") {\n          poligonoCoordinadas = event.data.coordinates;\n          console.log("\u2705 Pol\xEDgono recibido del iframe:", poligonoCoordinadas);\n\n          const statusDiv = document.getElementById("drawing-status");\n          statusDiv.innerHTML = `\u2705 \xA1\xC1rea dibujada correctamente! (${poligonoCoordinadas.length} puntos) Ahora puedes crear la cancha.`;\n          statusDiv.className = "drawing-status success";\n\n          // Validar formulario nuevamente para habilitar el bot\xF3n de crear\n          validarFormularioCreacion();\n        } else if (event.data.type === "polygon-deleted") {\n          poligonoCoordinadas = null;\n          console.log("\u{1F5D1}\uFE0F Pol\xEDgono eliminado del iframe");\n\n          const statusDiv = document.getElementById("drawing-status");\n          statusDiv.innerHTML = "\u{1F3A8} Dibuja un nuevo \xE1rea de trabajo en el mapa";\n          statusDiv.className = "drawing-status info";\n\n          // Validar formulario nuevamente para deshabilitar el bot\xF3n de crear\n          validarFormularioCreacion();\n        }\n      }\n\n      // Funci\xF3n para crear la cancha con pol\xEDgono\n      async function crearCanchaConPoligono() {\n        console.log("\u{1F680} Creando cancha con pol\xEDgono...");\n\n        const muro = document.getElementById("muro-select").value;\n        const sector = document.getElementById("sector-select").value;\n        const nombreDetalle = document\n          .getElementById("nombre-detalle-input")\n          .value.trim();\n\n        if (!muro || !sector || !nombreDetalle || !poligonoCoordinadas) {\n          alert(\n            "Por favor completa todos los campos y dibuja el \xE1rea en el mapa",\n          );\n          return;\n        }\n\n        try {\n          // Deshabilitar bot\xF3n mientras se crea\n          document.getElementById("create-cancha-btn").disabled = true;\n          document.getElementById("create-cancha-btn").textContent =\n            "Creando...";\n\n          const response = await fetch("/api/canchas", {\n            method: "POST",\n            headers: {\n              "Content-Type": "application/json",\n            },\n            body: JSON.stringify({\n              muro,\n              sector,\n              nombreDetalle,\n              poligonoCoordinadas,\n            }),\n          });\n\n          if (!response.ok) {\n            throw new Error("Error al crear la cancha");\n          }\n\n          const nuevaCancha = await response.json();\n          console.log("\u2705 Cancha creada exitosamente:", nuevaCancha);\n\n          // Cerrar modal\n          cerrarModalCrearCancha();\n\n          // Recargar la lista de canchas\n          await cargarCanchas();\n\n          // Mostrar mensaje de \xE9xito\n          mostrarMensaje(\n            `Cancha ${nuevaCancha.nombre} creada exitosamente con \xE1rea dibujada`,\n            "success",\n          );\n        } catch (error) {\n          console.error("\u274C Error al crear cancha:", error);\n          alert("Error al crear la cancha: " + error.message);\n        } finally {\n          // Restaurar bot\xF3n\n          document.getElementById("create-cancha-btn").disabled = false;\n          document.getElementById("create-cancha-btn").textContent =\n            "Crear Cancha";\n        }\n      }\n\n      // Manejar tecla Escape para cerrar modal de crear cancha\n      function handleEscapeKeyCrear(e) {\n        if (e.key === "Escape") {\n          cerrarModalCrearCancha();\n        }\n      }\n\n      // Inicializar la aplicaci\xF3n\n      inicializar();\n    <\/script> <!-- Modal para Crear Cancha (solo AngloAmerican) --> <div id="createCanchaModal" class="map-modal" data-astro-cid-j7pv25f6> <div class="map-modal-content create-cancha-modal-content" data-astro-cid-j7pv25f6> <div class="map-modal-header" data-astro-cid-j7pv25f6> <h3 class="map-modal-title" data-astro-cid-j7pv25f6>Crear Nueva Cancha</h3> <button id="createCanchaCloseBtn" class="map-close-btn" data-astro-cid-j7pv25f6>&times;</button> </div> <div class="create-cancha-container" data-astro-cid-j7pv25f6> <!-- Panel izquierdo: Formulario --> <div class="create-cancha-form" data-astro-cid-j7pv25f6> <h4 class="form-section-title" data-astro-cid-j7pv25f6>\u{1F4CB} Datos de la Cancha</h4> <div class="form-group" data-astro-cid-j7pv25f6> <label for="muro-select" data-astro-cid-j7pv25f6>Muro:</label> <select id="muro-select" required data-astro-cid-j7pv25f6> <option value="" data-astro-cid-j7pv25f6>Seleccionar Muro</option> <option value="MP" data-astro-cid-j7pv25f6>MP</option> <option value="ME" data-astro-cid-j7pv25f6>ME</option> <option value="MO" data-astro-cid-j7pv25f6>MO</option> </select> </div> <div class="form-group" data-astro-cid-j7pv25f6> <label for="sector-select" data-astro-cid-j7pv25f6>Sector:</label> <select id="sector-select" disabled required data-astro-cid-j7pv25f6> <option value="" data-astro-cid-j7pv25f6>Selecciona un muro primero</option> </select> </div> <div class="form-group" data-astro-cid-j7pv25f6> <label for="nombre-detalle-input" data-astro-cid-j7pv25f6>Nombre Detalle:</label> <input type="text" id="nombre-detalle-input" placeholder="ej: TEST1" required data-astro-cid-j7pv25f6> </div> <div class="form-actions" data-astro-cid-j7pv25f6> <button id="open-drawing-btn" class="btn-primary" disabled data-astro-cid-j7pv25f6>\u{1F5FA}\uFE0F Dibujar \xC1rea en Mapa</button> <button id="create-cancha-btn" class="btn-success" disabled data-astro-cid-j7pv25f6>\u2705 Crear Cancha</button> </div> <div id="drawing-status" class="drawing-status" data-astro-cid-j7pv25f6></div> </div> <!-- Panel derecho: Mapa --> <div class="create-cancha-map-panel" data-astro-cid-j7pv25f6> <div class="map-panel-header" data-astro-cid-j7pv25f6> <h4 class="map-panel-title" data-astro-cid-j7pv25f6>\u{1F5FA}\uFE0F \xC1rea de Trabajo</h4> <p class="map-panel-subtitle" data-astro-cid-j7pv25f6>\nDibuja el pol\xEDgono que define el \xE1rea de la cancha\n</p> </div> <div id="drawingMapContainer" class="drawing-map-container" data-astro-cid-j7pv25f6> <!-- El mapa de dibujo se cargar\xE1 aqu\xED --> </div> </div> </div> </div> </div> <!-- Modal para el Mapa --> <div id="mapModal" class="map-modal" data-astro-cid-j7pv25f6> <div class="map-modal-content" data-astro-cid-j7pv25f6> <div class="map-modal-header" data-astro-cid-j7pv25f6> <h3 class="map-modal-title" data-astro-cid-j7pv25f6>\nVisor de Mapa - Cancha <span id="mapCanchaId" data-astro-cid-j7pv25f6></span> </h3> <button id="mapCloseBtn" class="map-close-btn" data-astro-cid-j7pv25f6>&times;</button> </div> <div id="mapContainer" class="map-container" data-astro-cid-j7pv25f6> <!-- El mapa se cargar\xE1 aqu\xED din\xE1micamente --> </div> </div> </div> ', " "], ["", ' <meta charset="utf-8"> <link rel="icon" type="image/svg+xml" href="/favicon.svg"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Sistema de Gesti\xF3n de Canchas - AngloAmerican</title> <!-- Chart.js para gr\xE1ficos de perfil --> ', "   <!-- SheetJS library para procesar archivos Excel/CSV --> ", " ", '<div class="header" data-astro-cid-j7pv25f6> <!-- Logos de empresas (comentado temporalmente) --> <!--\n      <div class="logos-container">\n        <img title="Besalco" width="280" height="60" src="/Besalco.png" alt="Besalco" class="company-logo">\n        <img title="Linkapsis" width="280" height="60" src="/Linkapsis.png" alt="Linkapsis" class="company-logo">\n        <img title="AngloAmerican" width="280" height="60" src="/AngloAmerican.png" alt="AngloAmerican" class="company-logo">\n        <img title="LlayLlay" width="80" height="80" src="/LlayLlay.png" alt="LlayLlay" class="company-logo">\n      </div>\n      --> <canvas id="particles-canvas" data-astro-cid-j7pv25f6></canvas> <h1 data-astro-cid-j7pv25f6>Gesti\xF3n de Canchas AngloAmerican - Las T\xF3rtolas</h1> </div> <div class="container" data-astro-cid-j7pv25f6> <div id="mensaje-container" data-astro-cid-j7pv25f6></div> <!-- Pantalla Principal --> <div id="main-screen" data-astro-cid-j7pv25f6> <!-- Header de usuario logueado --> <div class="empresa-header" id="user-header" data-astro-cid-j7pv25f6> <div class="empresa-info" data-astro-cid-j7pv25f6> <span class="empresa-nombre" id="user-name" data-astro-cid-j7pv25f6>Cargando usuario...</span> <span class="empresa-rol" id="user-role" data-astro-cid-j7pv25f6>Verificando permisos...</span> </div> <div class="header-buttons" data-astro-cid-j7pv25f6> <div id="user-company" class="empresa-actual" data-astro-cid-j7pv25f6> <img id="user-company-logo" src="" alt="Logo Empresa" style="display: none;" data-astro-cid-j7pv25f6> </div> <button id="btn-abrir-modal-crear" type="button" class="header-btn header-btn-create" style="display: none;" data-astro-cid-j7pv25f6>\u{1F3D7}\uFE0F Crear Cancha</button> <a id="btn-admin-usuarios" href="/admin/usuarios" class="header-btn header-btn-admin" style="display: none;" data-astro-cid-j7pv25f6>\u{1F465} Gesti\xF3n Usuarios</a> <!-- === BOTONES ESPECIALES PARA LINKAPSIS === --> <!-- \n              Estos botones solo se muestran cuando el usuario logueado es de Linkapsis.\n              Permiten funcionalidades especiales de carga de datos:\n              - Subir Revanchas: Modal para cargar informaci\xF3n de revanchas\n              - Subir Canchas: Modal para cargar informaci\xF3n masiva de canchas\n            --> <button id="btn-subir-revanchas" type="button" class="header-btn header-btn-linkapsis" style="display: none;" data-astro-cid-j7pv25f6>\u{1F4E4} Subir Revanchas</button> <button id="btn-subir-canchas" type="button" class="header-btn header-btn-linkapsis" style="display: none;" data-astro-cid-j7pv25f6>\u{1F4C1} Subir Canchas</button> <button id="btn-logout" type="button" class="header-btn header-btn-logout" data-astro-cid-j7pv25f6>Cerrar Sesi\xF3n</button> </div> </div> <!-- Controles y Filtros --> <div class="controls" data-astro-cid-j7pv25f6> <!-- Filtros --> <!-- Filtros --> <div class="filtros-container" data-astro-cid-j7pv25f6> <h3 data-astro-cid-j7pv25f6>Filtros</h3> <!-- Layout principal con controles a la izquierda y stats a la derecha --> <div class="filtros-main-layout" data-astro-cid-j7pv25f6> <!-- Controles de filtros --> <div class="filtros-controls" data-astro-cid-j7pv25f6> <div class="filtros-row" data-astro-cid-j7pv25f6> <div class="filtro-group" data-astro-cid-j7pv25f6> <label data-astro-cid-j7pv25f6>Vista:</label> <div class="toggle-container" data-astro-cid-j7pv25f6> <div class="toggle-slider" data-astro-cid-j7pv25f6></div> <button id="btn-vista-acciones" class="toggle-btn active" data-astro-cid-j7pv25f6>Mis Acciones</button> <button id="btn-vista-historico" class="toggle-btn" data-astro-cid-j7pv25f6>Ver Hist\xF3rico</button> </div> </div> <div class="filtro-group" data-astro-cid-j7pv25f6> <label for="filtro-fecha" data-astro-cid-j7pv25f6>Filtro de Fecha:</label> <select id="filtro-fecha" data-astro-cid-j7pv25f6> <option value="all" data-astro-cid-j7pv25f6>Todas las fechas</option> <option value="today" data-astro-cid-j7pv25f6>Hoy</option> <option value="week" data-astro-cid-j7pv25f6>\xDAltima semana</option> <option value="month" data-astro-cid-j7pv25f6>\xDAltimo mes</option> <option value="custom" data-astro-cid-j7pv25f6>Rango personalizado</option> </select> </div> <div id="rango-fechas" class="filtro-group rango-fechas hidden" data-astro-cid-j7pv25f6> <label data-astro-cid-j7pv25f6>Desde:</label> <input type="date" id="fecha-desde" data-astro-cid-j7pv25f6> <label data-astro-cid-j7pv25f6>Hasta:</label> <input type="date" id="fecha-hasta" data-astro-cid-j7pv25f6> <button id="btn-aplicar-rango" type="button" data-astro-cid-j7pv25f6>Aplicar</button> </div> </div> </div> <!-- Dashboard de Estad\xEDsticas en sidebar --> <div class="stats-sidebar" data-astro-cid-j7pv25f6> <div class="stat-card stat-primary" data-astro-cid-j7pv25f6> <div class="stat-icon" data-astro-cid-j7pv25f6>\u2699\uFE0F</div> <div class="stat-number" id="stat-acciones" data-astro-cid-j7pv25f6>-</div> <div class="stat-label" data-astro-cid-j7pv25f6>Acciones Disponibles</div> </div> <div class="stat-card stat-info" data-astro-cid-j7pv25f6> <div class="stat-icon" data-astro-cid-j7pv25f6>\u{1F4CB}</div> <div class="stat-number" id="stat-total" data-astro-cid-j7pv25f6>-</div> <div class="stat-label" data-astro-cid-j7pv25f6>Total de Canchas</div> </div> </div> </div> </div> </div> <!-- Tabla de canchas --> <div class="table-container" data-astro-cid-j7pv25f6> <table data-astro-cid-j7pv25f6> <thead data-astro-cid-j7pv25f6> <tr data-astro-cid-j7pv25f6> <th style="width: 50px;" data-astro-cid-j7pv25f6> <input type="checkbox" id="select-all-checkbox" title="Seleccionar todas" data-astro-cid-j7pv25f6> </th> <th data-astro-cid-j7pv25f6>Nombre de Cancha</th> <th data-astro-cid-j7pv25f6>Estado Actual</th> <th data-astro-cid-j7pv25f6>Empresa Actual</th> <th data-astro-cid-j7pv25f6>Fecha Creaci\xF3n</th> <th data-astro-cid-j7pv25f6>Mapa</th> <th data-astro-cid-j7pv25f6>Acciones</th> </tr> </thead> <tbody id="canchas-tbody" data-astro-cid-j7pv25f6> <!-- Las canchas se cargar\xE1n din\xE1micamente --> </tbody> </table> <!-- Controles de paginaci\xF3n --> <div class="pagination-container" data-astro-cid-j7pv25f6> <div class="pagination-info" data-astro-cid-j7pv25f6>\nMostrando <span id="pagination-start" data-astro-cid-j7pv25f6>0</span> - <span id="pagination-end" data-astro-cid-j7pv25f6>0</span> de <span id="pagination-total" data-astro-cid-j7pv25f6>0</span> canchas\n</div> <div class="pagination-controls" data-astro-cid-j7pv25f6> <button id="btn-primera-pagina" class="pagination-btn" title="Primera p\xE1gina" data-astro-cid-j7pv25f6>&laquo;</button> <button id="btn-pagina-anterior" class="pagination-btn" title="P\xE1gina anterior" data-astro-cid-j7pv25f6>&lsaquo;</button> <span class="pagination-current" data-astro-cid-j7pv25f6>\nP\xE1gina <span id="pagina-actual" data-astro-cid-j7pv25f6>1</span> de <span id="total-paginas" data-astro-cid-j7pv25f6>1</span> </span> <button id="btn-pagina-siguiente" class="pagination-btn" title="P\xE1gina siguiente" data-astro-cid-j7pv25f6>&rsaquo;</button> <button id="btn-ultima-pagina" class="pagination-btn" title="\xDAltima p\xE1gina" data-astro-cid-j7pv25f6>&raquo;</button> </div> </div> </div> </div> <!-- === BOT\xD3N FLOTANTE DE ACCIONES MASIVAS === --> <div id="bulk-actions-bar" class="bulk-actions-bar hidden" data-astro-cid-j7pv25f6> <div class="bulk-actions-content" data-astro-cid-j7pv25f6> <span id="selected-count" class="selected-count" data-astro-cid-j7pv25f6>0 canchas seleccionadas</span> <div class="bulk-actions-buttons" data-astro-cid-j7pv25f6> <button id="btn-bulk-timeline" class="btn-bulk-action btn-bulk-timeline" title="Ver timeline de canchas seleccionadas" data-astro-cid-j7pv25f6>\n\u{1F4CA} Ver Timeline\n</button> <button id="btn-bulk-delete" class="btn-bulk-action btn-bulk-delete hidden" title="Borrar canchas seleccionadas" data-astro-cid-j7pv25f6>\n\u{1F5D1}\uFE0F Borrar Seleccionadas\n</button> <!-- Espacio para futuros botones de acciones masivas --> </div> <button id="btn-clear-selection" class="btn-clear-selection" title="Limpiar selecci\xF3n" data-astro-cid-j7pv25f6>\n\u2716 Limpiar\n</button> </div> </div> <!-- === DASHBOARD DE ESTADOS === --> <div class="dashboard-estados-section" data-astro-cid-j7pv25f6> <div class="dashboard-estados-header" data-astro-cid-j7pv25f6> <h3 class="dashboard-estados-title" data-astro-cid-j7pv25f6>\u{1F4CA} Estados de Canchas</h3> </div> <div class="dashboard-estados" data-astro-cid-j7pv25f6> <div class="estado-widget" data-estado="creada" data-astro-cid-j7pv25f6> <div class="widget-circle widget-creada" data-astro-cid-j7pv25f6> <span class="widget-number" id="count-creada" data-astro-cid-j7pv25f6>0</span> </div> <div class="widget-label" data-astro-cid-j7pv25f6>Creada</div> </div> <div class="estado-widget" data-estado="en-espera" data-astro-cid-j7pv25f6> <div class="widget-circle widget-en-espera" data-astro-cid-j7pv25f6> <span class="widget-number" id="count-en-espera" data-astro-cid-j7pv25f6>0</span> </div> <div class="widget-label" data-astro-cid-j7pv25f6>En Espera</div> </div> <div class="estado-widget" data-estado="en-proceso" data-astro-cid-j7pv25f6> <div class="widget-circle widget-en-proceso" data-astro-cid-j7pv25f6> <span class="widget-number" id="count-en-proceso" data-astro-cid-j7pv25f6>0</span> </div> <div class="widget-label" data-astro-cid-j7pv25f6>En Proceso</div> </div> <div class="estado-widget" data-estado="validada" data-astro-cid-j7pv25f6> <div class="widget-circle widget-validada" data-astro-cid-j7pv25f6> <span class="widget-number" id="count-validada" data-astro-cid-j7pv25f6>0</span> </div> <div class="widget-label" data-astro-cid-j7pv25f6>Validada</div> </div> <div class="estado-widget" data-estado="rechazada-en-espera" data-astro-cid-j7pv25f6> <div class="widget-circle widget-rechazada-en-espera" data-astro-cid-j7pv25f6> <span class="widget-number" id="count-rechazada-en-espera" data-astro-cid-j7pv25f6>0</span> </div> <div class="widget-label" data-astro-cid-j7pv25f6>Rechazada, en Espera</div> </div> <div class="estado-widget" data-estado="cerrada" data-astro-cid-j7pv25f6> <div class="widget-circle widget-cerrada" data-astro-cid-j7pv25f6> <span class="widget-number" id="count-cerrada" data-astro-cid-j7pv25f6>0</span> </div> <div class="widget-label" data-astro-cid-j7pv25f6>Cerrada</div> </div> </div> </div> <!-- === MAPA DASHBOARD === --> <div class="dashboard-map-section" data-astro-cid-j7pv25f6> <div class="dashboard-map-header" data-astro-cid-j7pv25f6> <div class="map-header-left" data-astro-cid-j7pv25f6> <h3 class="dashboard-map-title" data-astro-cid-j7pv25f6>\u{1F5FA}\uFE0F Vista de Mapa</h3> <p class="dashboard-map-subtitle" id="map-subtitle" data-astro-cid-j7pv25f6>\nMostrando todas las canchas\n</p> </div> <div class="map-header-controls" data-astro-cid-j7pv25f6> <!-- Filtro de Muros --> <div class="map-filter-group" data-astro-cid-j7pv25f6> <label for="map-muro-filter" class="filter-label" data-astro-cid-j7pv25f6>Muro:</label> <select id="map-muro-filter" class="map-filter-select" data-astro-cid-j7pv25f6> <option value="" data-astro-cid-j7pv25f6>Todos</option> <option value="Principal" data-astro-cid-j7pv25f6>Principal</option> <option value="Este" data-astro-cid-j7pv25f6>Este</option> <option value="Oeste" data-astro-cid-j7pv25f6>Oeste</option> </select> </div> <!-- Toggle Revanchas --> <div class="map-toggle-group" data-astro-cid-j7pv25f6> <label class="toggle-switch" data-astro-cid-j7pv25f6> <input type="checkbox" id="toggle-revanchas" data-astro-cid-j7pv25f6> <span class="toggle-slider-round" data-astro-cid-j7pv25f6></span> </label> <span class="toggle-label" data-astro-cid-j7pv25f6>Revanchas</span> </div> </div> </div> <div class="dashboard-map-container" id="dashboard-map-container" data-astro-cid-j7pv25f6> <div class="dashboard-map-loading" data-astro-cid-j7pv25f6>Cargando mapa...</div> </div> </div> <!-- Modal para validaci\xF3n de Linkapsis (Espesores) --> <div id="validacion-linkapsis-modal" class="modal" data-astro-cid-j7pv25f6> <div class="modal-content" data-astro-cid-j7pv25f6> <div class="modal-header" data-astro-cid-j7pv25f6> <h3 class="modal-title" data-astro-cid-j7pv25f6>Validaci\xF3n de Espesores - Linkapsis</h3> <button class="close-btn" data-astro-cid-j7pv25f6>\xD7</button> </div> <!-- Historial de observaciones anteriores --> <div id="historial-linkapsis" class="historial-observaciones" data-astro-cid-j7pv25f6> <h4 data-astro-cid-j7pv25f6>Observaciones del Proceso:</h4> <div class="historial-content" data-astro-cid-j7pv25f6> <p data-astro-cid-j7pv25f6>Cargando historial...</p> </div> </div> <form id="form-validacion-linkapsis" data-astro-cid-j7pv25f6> <div class="form-group" data-astro-cid-j7pv25f6> <label for="linkapsis-observaciones" data-astro-cid-j7pv25f6>Observaciones:</label> <textarea id="linkapsis-observaciones" placeholder="Ingresa observaciones sobre la validaci\xF3n..." required data-astro-cid-j7pv25f6></textarea> </div> <div class="form-group" data-astro-cid-j7pv25f6> <label for="linkapsis-espesor" data-astro-cid-j7pv25f6>Medici\xF3n de Espesor (metros):</label> <input type="number" id="linkapsis-espesor" placeholder="Ej: 0.03" min="0" step="0.001" required data-astro-cid-j7pv25f6> <small data-astro-cid-j7pv25f6>Ingresa la medici\xF3n en metros (ej: 0.03)</small> </div> <!-- Tipo de Trabajo --> <div class="form-group" data-astro-cid-j7pv25f6> <label data-astro-cid-j7pv25f6>Tipo de Trabajo:</label> <div class="checkbox-group" data-astro-cid-j7pv25f6> <label class="checkbox-item" data-astro-cid-j7pv25f6> <input type="checkbox" id="trabajo-corte" name="tipo-trabajo" value="corte" data-astro-cid-j7pv25f6> <span data-astro-cid-j7pv25f6>Corte</span> </label> <label class="checkbox-item" data-astro-cid-j7pv25f6> <input type="checkbox" id="trabajo-relleno" name="tipo-trabajo" value="relleno" data-astro-cid-j7pv25f6> <span data-astro-cid-j7pv25f6>Relleno</span> </label> </div> </div> <!-- Coordenadas de Puntos --> <div class="form-group" data-astro-cid-j7pv25f6> <label data-astro-cid-j7pv25f6>Coordenadas de Puntos:</label> <div class="coordenadas-grid" data-astro-cid-j7pv25f6> <!-- Punto 1 --> <div class="punto-section" data-astro-cid-j7pv25f6> <h5 data-astro-cid-j7pv25f6>Punto 1</h5> <div class="coordenadas-row" data-astro-cid-j7pv25f6> <div class="coord-field" data-astro-cid-j7pv25f6> <label for="p1-norte" data-astro-cid-j7pv25f6>Norte:</label> <input type="number" id="p1-norte" placeholder="Norte P1" step="0.001" data-astro-cid-j7pv25f6> </div> <div class="coord-field" data-astro-cid-j7pv25f6> <label for="p1-este" data-astro-cid-j7pv25f6>Este:</label> <input type="number" id="p1-este" placeholder="Este P1" step="0.001" data-astro-cid-j7pv25f6> </div> <div class="coord-field" data-astro-cid-j7pv25f6> <label for="p1-cota" data-astro-cid-j7pv25f6>Cota:</label> <input type="number" id="p1-cota" placeholder="Cota P1" step="0.001" data-astro-cid-j7pv25f6> </div> </div> </div> <!-- Punto 2 --> <div class="punto-section" data-astro-cid-j7pv25f6> <h5 data-astro-cid-j7pv25f6>Punto 2</h5> <div class="coordenadas-row" data-astro-cid-j7pv25f6> <div class="coord-field" data-astro-cid-j7pv25f6> <label for="p2-norte" data-astro-cid-j7pv25f6>Norte:</label> <input type="number" id="p2-norte" placeholder="Norte P2" step="0.001" data-astro-cid-j7pv25f6> </div> <div class="coord-field" data-astro-cid-j7pv25f6> <label for="p2-este" data-astro-cid-j7pv25f6>Este:</label> <input type="number" id="p2-este" placeholder="Este P2" step="0.001" data-astro-cid-j7pv25f6> </div> <div class="coord-field" data-astro-cid-j7pv25f6> <label for="p2-cota" data-astro-cid-j7pv25f6>Cota:</label> <input type="number" id="p2-cota" placeholder="Cota P2" step="0.001" data-astro-cid-j7pv25f6> </div> </div> </div> <!-- Punto 3 --> <div class="punto-section" data-astro-cid-j7pv25f6> <h5 data-astro-cid-j7pv25f6>Punto 3</h5> <div class="coordenadas-row" data-astro-cid-j7pv25f6> <div class="coord-field" data-astro-cid-j7pv25f6> <label for="p3-norte" data-astro-cid-j7pv25f6>Norte:</label> <input type="number" id="p3-norte" placeholder="Norte P3" step="0.001" data-astro-cid-j7pv25f6> </div> <div class="coord-field" data-astro-cid-j7pv25f6> <label for="p3-este" data-astro-cid-j7pv25f6>Este:</label> <input type="number" id="p3-este" placeholder="Este P3" step="0.001" data-astro-cid-j7pv25f6> </div> <div class="coord-field" data-astro-cid-j7pv25f6> <label for="p3-cota" data-astro-cid-j7pv25f6>Cota:</label> <input type="number" id="p3-cota" placeholder="Cota P3" step="0.001" data-astro-cid-j7pv25f6> </div> </div> </div> <!-- Punto 4 --> <div class="punto-section" data-astro-cid-j7pv25f6> <h5 data-astro-cid-j7pv25f6>Punto 4</h5> <div class="coordenadas-row" data-astro-cid-j7pv25f6> <div class="coord-field" data-astro-cid-j7pv25f6> <label for="p4-norte" data-astro-cid-j7pv25f6>Norte:</label> <input type="number" id="p4-norte" placeholder="Norte P4" step="0.001" data-astro-cid-j7pv25f6> </div> <div class="coord-field" data-astro-cid-j7pv25f6> <label for="p4-este" data-astro-cid-j7pv25f6>Este:</label> <input type="number" id="p4-este" placeholder="Este P4" step="0.001" data-astro-cid-j7pv25f6> </div> <div class="coord-field" data-astro-cid-j7pv25f6> <label for="p4-cota" data-astro-cid-j7pv25f6>Cota:</label> <input type="number" id="p4-cota" placeholder="Cota P4" step="0.001" data-astro-cid-j7pv25f6> </div> </div> </div> </div> </div> <div class="form-actions" data-astro-cid-j7pv25f6> <button type="button" class="btn-cancel" data-astro-cid-j7pv25f6>Cancelar</button> <button type="submit" class="btn-validar" data-astro-cid-j7pv25f6>Validar Espesores</button> <button type="button" class="btn-rechazar" data-astro-cid-j7pv25f6>Rechazar</button> </div> </form> </div> </div> <!-- Modal para validaci\xF3n de LlayLlay (Densidad) --> <!-- Modal de RECEPCI\xD3N de trabajo para Besalco --> <div id="recepcion-besalco-modal" class="modal" data-astro-cid-j7pv25f6> <div class="modal-content" data-astro-cid-j7pv25f6> <div class="modal-header" data-astro-cid-j7pv25f6> <h3 class="modal-title" data-astro-cid-j7pv25f6>\u{1F4CB} Recepci\xF3n de Trabajo - Besalco</h3> <button class="close-btn" data-astro-cid-j7pv25f6>\xD7</button> </div> <!-- Historial de observaciones (solo lectura) --> <div id="historial-recepcion-besalco" class="historial-observaciones" data-astro-cid-j7pv25f6> <h4 data-astro-cid-j7pv25f6>Observaciones del Proceso:</h4> <div class="historial-content" data-astro-cid-j7pv25f6> <p data-astro-cid-j7pv25f6>Cargando historial...</p> </div> </div> <div style="padding: 1rem; background: #e8f4f8; border-left: 4px solid #3498db; border-radius: 4px; margin: 1rem 0;" data-astro-cid-j7pv25f6> <p style="margin: 0; color: #2c3e50;" data-astro-cid-j7pv25f6> <strong data-astro-cid-j7pv25f6>Modo Recepci\xF3n:</strong> Revise el trabajo anterior y presione\n              "Comenzar Trabajo" para iniciar la validaci\xF3n.\n</p> </div> <div class="form-actions" style="justify-content: center;" data-astro-cid-j7pv25f6> <button type="button" class="btn-cancel" data-astro-cid-j7pv25f6>Cancelar</button> <button type="button" class="btn-comenzar" id="btn-comenzar-besalco" data-astro-cid-j7pv25f6>\u{1F680} Comenzar Trabajo</button> </div> </div> </div> <!-- Modal de RECEPCI\xD3N de trabajo para Linkapsis --> <div id="recepcion-linkapsis-modal" class="modal" data-astro-cid-j7pv25f6> <div class="modal-content" data-astro-cid-j7pv25f6> <div class="modal-header" data-astro-cid-j7pv25f6> <h3 class="modal-title" data-astro-cid-j7pv25f6>\u{1F4CB} Recepci\xF3n de Trabajo - Linkapsis</h3> <button class="close-btn" data-astro-cid-j7pv25f6>\xD7</button> </div> <!-- Historial de observaciones (solo lectura) --> <div id="historial-recepcion-linkapsis" class="historial-observaciones" data-astro-cid-j7pv25f6> <h4 data-astro-cid-j7pv25f6>Observaciones del Proceso:</h4> <div class="historial-content" data-astro-cid-j7pv25f6> <p data-astro-cid-j7pv25f6>Cargando historial...</p> </div> </div> <div style="padding: 1rem; background: #e8f4f8; border-left: 4px solid #3498db; border-radius: 4px; margin: 1rem 0;" data-astro-cid-j7pv25f6> <p style="margin: 0; color: #2c3e50;" data-astro-cid-j7pv25f6> <strong data-astro-cid-j7pv25f6>Modo Recepci\xF3n:</strong> Revise el trabajo anterior y presione\n              "Comenzar Trabajo" para iniciar la validaci\xF3n de espesores.\n</p> </div> <div class="form-actions" style="justify-content: center;" data-astro-cid-j7pv25f6> <button type="button" class="btn-cancel" data-astro-cid-j7pv25f6>Cancelar</button> <button type="button" class="btn-comenzar" id="btn-comenzar-linkapsis" data-astro-cid-j7pv25f6>\u{1F680} Comenzar Trabajo</button> </div> </div> </div> <!-- ========================================== --> <!-- MODALES ESPECIALES PARA LINKAPSIS          --> <!-- ========================================== --> <!-- \n        Estos modales est\xE1n preparados para funcionalidades especiales de Linkapsis:\n        1. Modal Subir Revanchas: Para cargar informaci\xF3n de revanchas\n        2. Modal Subir Canchas: Para carga masiva de canchas\n        \n        ESTADO ACTUAL: Estructura base creada, lista para desarrollo\n        TODO: Implementar formularios y l\xF3gica de procesamiento de datos\n      --> <!-- Modal para Subir Revanchas (Linkapsis) --> <div id="modal-subir-revanchas" class="modal" data-astro-cid-j7pv25f6> <div class="modal-content modal-large" data-astro-cid-j7pv25f6> <div class="modal-header" data-astro-cid-j7pv25f6> <h3 class="modal-title" data-astro-cid-j7pv25f6>\u{1F4E4} Subir Revanchas - Linkapsis</h3> <button class="close-btn" data-astro-cid-j7pv25f6>\xD7</button> </div> <div class="modal-body" data-astro-cid-j7pv25f6> <!-- Selector de Tipo de Muro --> <div class="form-group" data-astro-cid-j7pv25f6> <label for="tipo-muro-revanchas" data-astro-cid-j7pv25f6> <strong data-astro-cid-j7pv25f6>Tipo de Muro:</strong> </label> <select id="tipo-muro-revanchas" class="form-select" data-astro-cid-j7pv25f6> <option value="" data-astro-cid-j7pv25f6>Seleccione un muro...</option> <option value="principal" data-astro-cid-j7pv25f6>Muro Principal</option> <option value="oeste" data-astro-cid-j7pv25f6>Muro Oeste</option> <option value="este" data-astro-cid-j7pv25f6>Muro Este</option> </select> <small style="color: #64748b; display: block; margin-top: 0.5rem;" data-astro-cid-j7pv25f6>\nSeleccione el tipo de muro antes de cargar el archivo\n</small> </div> <!-- Selector de Archivo --> <div class="form-group" data-astro-cid-j7pv25f6> <label for="file-revanchas" data-astro-cid-j7pv25f6> <strong data-astro-cid-j7pv25f6>Archivo de Revanchas:</strong> </label> <input type="file" id="file-revanchas" accept=".csv,.xlsx,.xls" disabled style="padding: 0.75rem; border: 2px dashed #cbd5e1; border-radius: 8px; background: #f8fafc; cursor: pointer;" data-astro-cid-j7pv25f6> <small style="color: #64748b; display: block; margin-top: 0.5rem;" data-astro-cid-j7pv25f6>\nFormatos soportados: CSV, XLSX, XLS\n</small> </div> <!-- Mensajes de Error/Info --> <div id="mensaje-revanchas" style="display:none; padding: 1rem; border-radius: 8px; margin: 1rem 0;" data-astro-cid-j7pv25f6></div> <!-- \xC1rea de Preview --> <div id="preview-revanchas" style="display:none; margin-top: 1.5rem;" data-astro-cid-j7pv25f6> <h4 style="color: #1e293b; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;" data-astro-cid-j7pv25f6> <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-astro-cid-j7pv25f6> <path d="M9 11l3 3L22 4" data-astro-cid-j7pv25f6></path> <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11" data-astro-cid-j7pv25f6></path> </svg>\nVista Previa de Datos\n</h4> <div id="info-archivo-revanchas" style="background: #f0f9ff; border-left: 4px solid #3b82f6; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;" data-astro-cid-j7pv25f6></div> <div id="tabla-revanchas" style="overflow-x: auto; max-height: 500px; border: 1px solid #e2e8f0; border-radius: 8px;" data-astro-cid-j7pv25f6></div> </div> </div> <div class="form-actions" data-astro-cid-j7pv25f6> <button type="button" class="btn-cancel" data-astro-cid-j7pv25f6>Cancelar</button> <button type="button" id="btn-procesar-revanchas" class="btn-primary" disabled style="opacity: 0.5;" data-astro-cid-j7pv25f6>\nProcesar Datos\n</button> </div> </div> </div> <!-- Modal para Subir Canchas (Linkapsis) --> <div id="modal-subir-canchas" class="modal" data-astro-cid-j7pv25f6> <div class="modal-content modal-large" data-astro-cid-j7pv25f6> <div class="modal-header" data-astro-cid-j7pv25f6> <h3 class="modal-title" data-astro-cid-j7pv25f6>\u{1F4C1} Subir Canchas - Linkapsis</h3> <button class="close-btn" data-astro-cid-j7pv25f6>\xD7</button> </div> <div class="modal-body" data-astro-cid-j7pv25f6> <form id="form-subir-canchas" data-astro-cid-j7pv25f6> <!-- Fila 1: Muro y Sector --> <div class="form-row" data-astro-cid-j7pv25f6> <div class="form-group" data-astro-cid-j7pv25f6> <label for="muro-cancha" data-astro-cid-j7pv25f6> <strong data-astro-cid-j7pv25f6>Muro *</strong> </label> <select id="muro-cancha" required data-astro-cid-j7pv25f6> <option value="" data-astro-cid-j7pv25f6>Seleccione...</option> <option value="Principal" data-astro-cid-j7pv25f6>Principal</option> <option value="Este" data-astro-cid-j7pv25f6>Este</option> <option value="Oeste" data-astro-cid-j7pv25f6>Oeste</option> </select> </div> <div class="form-group" data-astro-cid-j7pv25f6> <label for="sector-cancha" data-astro-cid-j7pv25f6> <strong data-astro-cid-j7pv25f6>Sector *</strong> </label> <select id="sector-cancha" disabled required data-astro-cid-j7pv25f6> <option value="" data-astro-cid-j7pv25f6>Seleccione muro primero...</option> </select> </div> </div> <!-- Fila 2: Relleno y Fecha --> <div class="form-row" data-astro-cid-j7pv25f6> <div class="form-group" data-astro-cid-j7pv25f6> <label for="relleno-cancha" data-astro-cid-j7pv25f6> <strong data-astro-cid-j7pv25f6>Relleno *</strong> </label> <input type="text" id="relleno-cancha" placeholder="Ingrese nombre del relleno" required data-astro-cid-j7pv25f6> </div> <div class="form-group" data-astro-cid-j7pv25f6> <label for="fecha-cancha" data-astro-cid-j7pv25f6> <strong data-astro-cid-j7pv25f6>Fecha *</strong> </label> <input type="date" id="fecha-cancha" required data-astro-cid-j7pv25f6> </div> </div> <!-- Fila 3: Foto --> <div class="form-group" data-astro-cid-j7pv25f6> <label for="foto-cancha" data-astro-cid-j7pv25f6> <strong data-astro-cid-j7pv25f6>Foto</strong> </label> <input type="file" id="foto-cancha" accept="image/*" data-astro-cid-j7pv25f6> <small style="color: #64748b;" data-astro-cid-j7pv25f6>Formatos: JPG, PNG (m\xE1x. 5MB)</small> <div id="preview-foto-cancha" style="display:none; margin-top: 1rem;" data-astro-cid-j7pv25f6> <img id="img-preview-cancha" style="max-width: 200px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" alt="Preview" data-astro-cid-j7pv25f6> </div> </div> <!-- Fila 4: Archivo --> <div class="form-group" data-astro-cid-j7pv25f6> <label for="archivo-cancha" data-astro-cid-j7pv25f6> <strong data-astro-cid-j7pv25f6>Archivo *</strong> </label> <input type="file" id="archivo-cancha" accept=".csv,.xlsx,.asc" required data-astro-cid-j7pv25f6> <small style="color: #64748b;" data-astro-cid-j7pv25f6>Formatos: CSV, XLSX, ASC</small> </div> <!-- Fila 5: Responsable y M\xE9todo --> <div class="form-row" data-astro-cid-j7pv25f6> <div class="form-group" data-astro-cid-j7pv25f6> <label for="responsable-cancha" data-astro-cid-j7pv25f6> <strong data-astro-cid-j7pv25f6>Responsable *</strong> </label> <select id="responsable-cancha" required data-astro-cid-j7pv25f6> <option value="" data-astro-cid-j7pv25f6>Cargando...</option> </select> </div> <div class="form-group" data-astro-cid-j7pv25f6> <label for="metodo-cancha" data-astro-cid-j7pv25f6> <strong data-astro-cid-j7pv25f6>M\xE9todo *</strong> </label> <select id="metodo-cancha" required data-astro-cid-j7pv25f6> <option value="" data-astro-cid-j7pv25f6>Seleccione...</option> <option value="Movimiento de Tierra" data-astro-cid-j7pv25f6>Movimiento de Tierra</option> <option value="Hidraulico" data-astro-cid-j7pv25f6>Hidr\xE1ulico</option> </select> </div> </div> <!-- Fila 6: N\xB0 Capas --> <div class="form-group" data-astro-cid-j7pv25f6> <label for="capas-cancha" data-astro-cid-j7pv25f6> <strong data-astro-cid-j7pv25f6>N\xB0 Capas *</strong> </label> <select id="capas-cancha" required data-astro-cid-j7pv25f6> <option value="" data-astro-cid-j7pv25f6>Seleccione...</option> <option value="1" data-astro-cid-j7pv25f6>1</option> <option value="2" data-astro-cid-j7pv25f6>2</option> <option value="3" data-astro-cid-j7pv25f6>3</option> <option value="4" data-astro-cid-j7pv25f6>4</option> </select> </div> </form> </div> <div class="form-actions" data-astro-cid-j7pv25f6> <button type="button" class="btn-cancel" data-astro-cid-j7pv25f6>Cancelar</button> <button type="submit" class="btn-primary" form="form-subir-canchas" data-astro-cid-j7pv25f6>\nGuardar Cancha\n</button> </div> </div> </div> <!-- Modal de RECEPCI\xD3N de trabajo para LlayLlay --> <div id="recepcion-llayllay-modal" class="modal" data-astro-cid-j7pv25f6> <div class="modal-content" data-astro-cid-j7pv25f6> <div class="modal-header" data-astro-cid-j7pv25f6> <h3 class="modal-title" data-astro-cid-j7pv25f6>\u{1F4CB} Recepci\xF3n de Trabajo - LlayLlay</h3> <button class="close-btn" data-astro-cid-j7pv25f6>\xD7</button> </div> <!-- Historial de observaciones (solo lectura) --> <div id="historial-recepcion-llayllay" class="historial-observaciones" data-astro-cid-j7pv25f6> <h4 data-astro-cid-j7pv25f6>Observaciones del Proceso:</h4> <div class="historial-content" data-astro-cid-j7pv25f6> <p data-astro-cid-j7pv25f6>Cargando historial...</p> </div> </div> <div style="padding: 1rem; background: #e8f4f8; border-left: 4px solid #3498db; border-radius: 4px; margin: 1rem 0;" data-astro-cid-j7pv25f6> <p style="margin: 0; color: #2c3e50;" data-astro-cid-j7pv25f6> <strong data-astro-cid-j7pv25f6>Modo Recepci\xF3n:</strong> Revise el trabajo anterior y presione\n              "Comenzar Trabajo" para iniciar la validaci\xF3n de densidad.\n</p> </div> <div class="form-actions" style="justify-content: center;" data-astro-cid-j7pv25f6> <button type="button" class="btn-cancel" data-astro-cid-j7pv25f6>Cancelar</button> <button type="button" class="btn-comenzar" id="btn-comenzar-llayllay" data-astro-cid-j7pv25f6>\u{1F680} Comenzar Trabajo</button> </div> </div> </div> <!-- Modal de VALIDACI\xD3N de trabajo para LlayLlay --> <div id="validacion-llayllay-modal" class="modal" data-astro-cid-j7pv25f6> <div class="modal-content" data-astro-cid-j7pv25f6> <div class="modal-header" data-astro-cid-j7pv25f6> <h3 class="modal-title" data-astro-cid-j7pv25f6>Validaci\xF3n de Densidad - LlayLlay</h3> <button class="close-btn" data-astro-cid-j7pv25f6>\xD7</button> </div> <!-- Historial de observaciones anteriores --> <div id="historial-llayllay" class="historial-observaciones" data-astro-cid-j7pv25f6> <h4 data-astro-cid-j7pv25f6>Observaciones del Proceso:</h4> <div class="historial-content" data-astro-cid-j7pv25f6> <p data-astro-cid-j7pv25f6>Cargando historial...</p> </div> </div> <form id="form-validacion-llayllay" data-astro-cid-j7pv25f6> <div class="form-group" data-astro-cid-j7pv25f6> <label for="llayllay-observaciones" data-astro-cid-j7pv25f6>Observaciones:</label> <textarea id="llayllay-observaciones" placeholder="Ingresa observaciones sobre la validaci\xF3n..." required data-astro-cid-j7pv25f6></textarea> </div> <div class="form-group" data-astro-cid-j7pv25f6> <label for="llayllay-densidad" data-astro-cid-j7pv25f6>Densidad (g/cm\xB3):</label> <input type="number" id="llayllay-densidad" placeholder="ej: 2.35" min="0" step="0.01" required data-astro-cid-j7pv25f6> </div> <div class="form-actions" data-astro-cid-j7pv25f6> <button type="button" class="btn-cancel" data-astro-cid-j7pv25f6>Cancelar</button> <button type="submit" class="btn-validar" data-astro-cid-j7pv25f6>Validar Densidad</button> <button type="button" class="btn-rechazar" data-astro-cid-j7pv25f6>Rechazar</button> </div> </form> </div> </div> <!-- Modal para validaci\xF3n/rechazo de Besalco --> <div id="validacion-besalco-modal" class="modal" data-astro-cid-j7pv25f6> <div class="modal-content" data-astro-cid-j7pv25f6> <div class="modal-header" data-astro-cid-j7pv25f6> <h3 class="modal-title" data-astro-cid-j7pv25f6>Validaci\xF3n de Trabajo - Besalco</h3> <button class="close-btn" data-astro-cid-j7pv25f6>\xD7</button> </div> <!-- Historial de observaciones anteriores --> <div id="historial-besalco" class="historial-observaciones" data-astro-cid-j7pv25f6> <h4 data-astro-cid-j7pv25f6>Observaciones del Proceso:</h4> <div class="historial-content" data-astro-cid-j7pv25f6> <p data-astro-cid-j7pv25f6>Cargando historial...</p> </div> </div> <form id="form-validacion-besalco" data-astro-cid-j7pv25f6> <div class="form-group" data-astro-cid-j7pv25f6> <label for="besalco-observaciones" data-astro-cid-j7pv25f6>Observaciones del Trabajo:</label> <textarea id="besalco-observaciones" placeholder="Describe el trabajo realizado o motivo del rechazo..." required data-astro-cid-j7pv25f6></textarea> </div> <div class="form-actions" data-astro-cid-j7pv25f6> <button type="button" class="btn-cancel" data-astro-cid-j7pv25f6>Cancelar</button> <button type="submit" class="btn-finalizar" data-astro-cid-j7pv25f6>Finalizar Trabajo</button> <button type="button" class="btn-rechazar" data-astro-cid-j7pv25f6>Rechazar Trabajo</button> </div> </form> </div> </div> <!-- Modal para cerrar cancha (AngloAmerican) --> <div id="cerrar-cancha-modal" class="modal" data-astro-cid-j7pv25f6> <div class="modal-content" data-astro-cid-j7pv25f6> <div class="modal-header" data-astro-cid-j7pv25f6> <h3 class="modal-title" data-astro-cid-j7pv25f6>Cerrar Cancha - AngloAmerican</h3> <button class="close-btn" data-astro-cid-j7pv25f6>\xD7</button> </div> <!-- Historial completo de observaciones --> <div id="historial-cierre" class="historial-observaciones" data-astro-cid-j7pv25f6> <h4 data-astro-cid-j7pv25f6>Historial Completo del Proceso:</h4> <div class="historial-content" data-astro-cid-j7pv25f6> <p data-astro-cid-j7pv25f6>Cargando historial completo...</p> </div> </div> <div class="form-actions" style="justify-content: center; gap: 1rem; padding-top: 1rem;" data-astro-cid-j7pv25f6> <button type="button" class="btn-cancel" data-astro-cid-j7pv25f6>Cancelar</button> <button type="button" class="btn-finalizar" id="confirmar-cierre" data-astro-cid-j7pv25f6>Cerrar Cancha Definitivamente</button> </div> </div> </div> <!-- Modal para borrar cancha (AngloAmerican) --> <div id="borrar-cancha-modal" class="modal" data-astro-cid-j7pv25f6> <div class="modal-content" data-astro-cid-j7pv25f6> <div class="modal-header" data-astro-cid-j7pv25f6> <h3 class="modal-title" style="color: #e74c3c;" data-astro-cid-j7pv25f6>\n\u26A0\uFE0F Borrar Cancha Definitivamente\n</h3> <button class="close-btn" data-astro-cid-j7pv25f6>\xD7</button> </div> <div style="padding: 1rem; background: #fef5e7; border: 2px solid #f39c12; border-radius: 8px; margin: 1rem 0;" data-astro-cid-j7pv25f6> <h4 style="color: #d68910; margin: 0 0 0.5rem 0;" data-astro-cid-j7pv25f6>\n\u26A0\uFE0F ADVERTENCIA\n</h4> <p style="margin: 0; color: #8e6e01;" data-astro-cid-j7pv25f6>\nEsta acci\xF3n <strong data-astro-cid-j7pv25f6>NO SE PUEDE DESHACER</strong>. Se eliminar\xE1 la\n              cancha y todas sus validaciones asociadas de forma permanente.\n</p> </div> <div id="historial-borrado" class="historial-observaciones" data-astro-cid-j7pv25f6> <h4 data-astro-cid-j7pv25f6>Historial que se Eliminar\xE1:</h4> <div class="historial-content" data-astro-cid-j7pv25f6> <p data-astro-cid-j7pv25f6>Cargando historial...</p> </div> </div> <div class="form-group" data-astro-cid-j7pv25f6> <label for="confirmacion-borrado" style="color: #e74c3c; font-weight: 700;" data-astro-cid-j7pv25f6>\nPara confirmar, escribe exactamente: <code style="background: #f8f9fa; padding: 0.25rem;" data-astro-cid-j7pv25f6>borrar-cancha</code> </label> <input type="text" id="confirmacion-borrado" placeholder="Escribe \'borrar-cancha\' para confirmar" style="border: 2px solid #e74c3c;" data-astro-cid-j7pv25f6> </div> <div class="form-actions" style="justify-content: center; gap: 1rem; padding-top: 1rem;" data-astro-cid-j7pv25f6> <button type="button" class="btn-cancel" data-astro-cid-j7pv25f6>Cancelar</button> <button type="button" class="btn-danger" id="confirmar-borrado" disabled data-astro-cid-j7pv25f6>BORRAR CANCHA DEFINITIVAMENTE</button> </div> </div> </div> <!-- Modal para Timeline de Canchas --> <div id="timeline-modal" class="modal" data-astro-cid-j7pv25f6> <div class="modal-content modal-timeline" data-astro-cid-j7pv25f6> <div class="modal-header" data-astro-cid-j7pv25f6> <div data-astro-cid-j7pv25f6> <h3 class="modal-title" data-astro-cid-j7pv25f6> <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-astro-cid-j7pv25f6> <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" data-astro-cid-j7pv25f6></polyline> </svg>\nTimeline de Transiciones\n</h3> <p style="margin: 0.5rem 0 0 0; font-size: 0.95rem; color: rgba(255,255,255,0.85); font-weight: 400;" data-astro-cid-j7pv25f6>\nVisualizaci\xF3n cronol\xF3gica de eventos de las canchas\n                seleccionadas\n</p> </div> <button class="close-btn" id="timeline-close-btn" data-astro-cid-j7pv25f6>\xD7</button> </div> <div class="timeline-container" data-astro-cid-j7pv25f6> <div id="timeline-legend" class="timeline-legend" data-astro-cid-j7pv25f6></div> <div id="timeline-canvas-wrapper" class="timeline-canvas-wrapper" data-astro-cid-j7pv25f6> <canvas id="timeline-canvas" data-astro-cid-j7pv25f6></canvas> <div id="timeline-axis" class="timeline-axis" data-astro-cid-j7pv25f6></div> <div id="timeline-events" class="timeline-events" data-astro-cid-j7pv25f6></div> </div> </div> </div> </div> </div> <script type="module">\n      // ========== ANIMACI\xD3N DE PART\xCDCULAS EN HEADER ==========\n      function initParticles() {\n        const canvas = document.getElementById("particles-canvas");\n        if (!canvas) return;\n\n        const ctx = canvas.getContext("2d");\n        const header = canvas.parentElement;\n\n        let width, height;\n\n        // Ajustar tama\xF1o del canvas\n        function resizeCanvas() {\n          width = header.offsetWidth;\n          height = header.offsetHeight;\n          canvas.width = width;\n          canvas.height = height;\n        }\n\n        resizeCanvas();\n\n        // Configuraci\xF3n de part\xEDculas\n        let particles = [];\n        const particleDensity = 9000; // Menor n\xFAmero = m\xE1s part\xEDculas\n\n        // Mouse interaction\n        let mouse = { x: null, y: null, radius: 150 };\n\n        header.addEventListener("mousemove", (event) => {\n          const rect = header.getBoundingClientRect();\n          mouse.x = event.clientX - rect.left;\n          mouse.y = event.clientY - rect.top;\n        });\n\n        header.addEventListener("mouseleave", () => {\n          mouse.x = null;\n          mouse.y = null;\n        });\n\n        class Particle {\n          constructor() {\n            this.x = Math.random() * width;\n            this.y = Math.random() * height;\n            this.size = Math.random() * 2 + 1.5; // Tama\xF1o variado\n            this.speedX = (Math.random() * 1.5 - 0.75) * 0.5; // Velocidad lenta y elegante\n            this.speedY = (Math.random() * 1.5 - 0.75) * 0.5;\n            this.density = Math.random() * 30 + 1;\n          }\n\n          update() {\n            // Movimiento normal\n            this.x += this.speedX;\n            this.y += this.speedY;\n\n            // Rebote en bordes\n            if (this.x > width || this.x < 0) this.speedX = -this.speedX;\n            if (this.y > height || this.y < 0) this.speedY = -this.speedY;\n\n            // Interacci\xF3n con mouse\n            if (mouse.x != null) {\n              let dx = mouse.x - this.x;\n              let dy = mouse.y - this.y;\n              let distance = Math.sqrt(dx * dx + dy * dy);\n\n              if (distance < mouse.radius) {\n                const forceDirectionX = dx / distance;\n                const forceDirectionY = dy / distance;\n                const maxDistance = mouse.radius;\n                const force = (maxDistance - distance) / maxDistance;\n                const directionX = forceDirectionX * force * this.density;\n                const directionY = forceDirectionY * force * this.density;\n\n                // Efecto de repulsi\xF3n suave\n                this.x -= directionX * 0.05;\n                this.y -= directionY * 0.05;\n              }\n            }\n          }\n\n          draw() {\n            ctx.beginPath();\n            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);\n            ctx.fillStyle = "rgba(255, 255, 255, 0.7)"; // Part\xEDculas claras\n            ctx.fill();\n          }\n        }\n\n        function init() {\n          particles = [];\n          let numberOfParticles = (width * height) / particleDensity;\n          // Asegurar un m\xEDnimo de part\xEDculas\n          if (numberOfParticles < 50) numberOfParticles = 50;\n          if (numberOfParticles > 150) numberOfParticles = 150; // L\xEDmite superior\n\n          for (let i = 0; i < numberOfParticles; i++) {\n            particles.push(new Particle());\n          }\n        }\n\n        init();\n\n        window.addEventListener("resize", () => {\n          resizeCanvas();\n          init();\n        });\n\n        // Animar\n        function animate() {\n          ctx.clearRect(0, 0, width, height);\n\n          particles.forEach((particle) => {\n            particle.update();\n            particle.draw();\n          });\n\n          connect();\n\n          requestAnimationFrame(animate);\n        }\n\n        function connect() {\n          const maxDistance = 130; // Distancia de conexi\xF3n\n          for (let a = 0; a < particles.length; a++) {\n            for (let b = a; b < particles.length; b++) {\n              let dx = particles[a].x - particles[b].x;\n              let dy = particles[a].y - particles[b].y;\n              let distance = Math.sqrt(dx * dx + dy * dy);\n\n              if (distance < maxDistance) {\n                let opacityValue = 1 - distance / maxDistance;\n                ctx.strokeStyle =\n                  "rgba(255, 255, 255," + opacityValue * 0.35 + ")";\n                ctx.lineWidth = 0.8;\n                ctx.beginPath();\n                ctx.moveTo(particles[a].x, particles[a].y);\n                ctx.lineTo(particles[b].x, particles[b].y);\n                ctx.stroke();\n              }\n            }\n          }\n        }\n\n        animate();\n      }\n\n      // Inicializar part\xEDculas cuando cargue el DOM\n      initParticles();\n      // ========== FIN ANIMACI\xD3N DE PART\xCDCULAS ==========\n\n      // Variables globales\n      let usuarioLogueado = null;\n      let empresaLogueada = null;\n      let cargando = false;\n      let vistaActual = "acciones"; // \'acciones\' o \'historico\'\n      let filtroFecha = "all";\n      let todasLasCanchas = [];\n      let canchasFiltradas = [];\n\n      // Variables de paginaci\xF3n\n      let paginaActual = 1;\n      const filasPorPagina = 15;\n      let filtroEstadoActivo = null; // Estado seleccionado desde los c\xEDrculos\n\n      // Elementos del DOM\n      const mainScreen = document.getElementById("main-screen");\n      const userHeader = document.getElementById("user-header");\n      const userName = document.getElementById("user-name");\n      const userRole = document.getElementById("user-role");\n      const userCompany = document.getElementById("user-company");\n      const btnAdminUsuarios = document.getElementById("btn-admin-usuarios");\n      const btnLogout = document.getElementById("btn-logout");\n      const formCrearCancha = document.getElementById("form-crear-cancha");\n      const btnCrearCancha = document.getElementById("btn-crear-cancha");\n      const btnAbrirModalCrear = document.getElementById(\n        "btn-abrir-modal-crear",\n      );\n      const canchasTBody = document.getElementById("canchas-tbody");\n      const mensajeContainer = document.getElementById("mensaje-container");\n      // Elementos del dashboard de estad\xEDsticas (reemplaza contador-resultados)\n\n      // Elementos de filtros\n      const btnVistaAcciones = document.getElementById("btn-vista-acciones");\n      const btnVistaHistorico = document.getElementById("btn-vista-historico");\n      const filtroFechaSelect = document.getElementById("filtro-fecha");\n      const rangoFechas = document.getElementById("rango-fechas");\n      const fechaDesde = document.getElementById("fecha-desde");\n      const fechaHasta = document.getElementById("fecha-hasta");\n      const btnAplicarRango = document.getElementById("btn-aplicar-rango");\n\n      // Cargar datos iniciales\n      async function inicializar() {\n        try {\n          configurarEventListeners();\n\n          // Esperar a que el AuthGuard termine de verificar\n          window.addEventListener("userAuthenticated", (event) => {\n            cargarUsuarioAutenticado(event.detail);\n          });\n\n          // Verificar si ya hay usuario autenticado\n          verificarUsuarioExistente();\n        } catch (error) {\n          console.error("Error al inicializar:", error);\n          mostrarMensaje("Error al cargar datos iniciales", "error");\n        }\n      }\n\n      // Verificar si hay usuario autenticado en localStorage\n      function verificarUsuarioExistente() {\n        try {\n          const sessionData = localStorage.getItem("userSession");\n          if (sessionData) {\n            const session = JSON.parse(sessionData);\n            const expiresAt = new Date(session.expiresAt);\n\n            if (expiresAt > new Date()) {\n              cargarUsuarioAutenticado(session.usuario);\n            } else {\n              // Sesi\xF3n expirada, redirigir al login\n              window.location.href = "/login";\n            }\n          } else {\n            // No hay sesi\xF3n, redirigir al login\n            window.location.href = "/login";\n          }\n        } catch (error) {\n          console.error("Error verificando usuario:", error);\n          window.location.href = "/login";\n        }\n      }\n\n      // Configurar todos los event listeners\n      function configurarEventListeners() {\n        // Logout\n        btnLogout.addEventListener("click", cerrarSesion);\n\n        // Filtros\n        btnVistaAcciones.addEventListener("click", () =>\n          cambiarVista("acciones"),\n        );\n        btnVistaHistorico.addEventListener("click", () =>\n          cambiarVista("historico"),\n        );\n        filtroFechaSelect.addEventListener("change", manejarCambioFiltroFecha);\n        btnAplicarRango.addEventListener("click", aplicarRangoFechas);\n\n        // Modal\n        configurarModalEventListeners();\n\n        // === EVENT LISTENERS PARA BOTONES ESPECIALES DE LINKAPSIS ===\n        configurarBotonesLinkapsis();\n\n        // Crear cancha (si aplica)\n        if (btnCrearCancha) {\n          console.log("Registrando event listener para btnCrearCancha");\n          btnCrearCancha.addEventListener("click", crearCancha);\n        } else {\n          console.log("No se encontr\xF3 btnCrearCancha");\n        }\n\n        // Bot\xF3n para abrir modal de crear cancha con pol\xEDgono\n        if (btnAbrirModalCrear) {\n          console.log("Registrando event listener para btnAbrirModalCrear");\n          btnAbrirModalCrear.addEventListener("click", abrirModalCrearCancha);\n        } else {\n          console.log("No se encontr\xF3 btnAbrirModalCrear");\n        }\n\n        // Configurar selectores din\xE1micos de Muro y Sector\n        configurarSelectoresMuroSector();\n\n        // Configurar botones de paginaci\xF3n\n        configurarPaginacion();\n\n        // Configurar controles del mapa\n        configurarControlesMapa();\n\n        // Inicializar slider de filtros\n        setTimeout(updateSliderPosition, 100);\n        window.addEventListener("resize", updateSliderPosition);\n      }\n\n      // Configurar controles del header del mapa\n      function configurarControlesMapa() {\n        const mapMuroFilter = document.getElementById("map-muro-filter");\n        const toggleRevanchas = document.getElementById("toggle-revanchas");\n        const mapSubtitle = document.getElementById("map-subtitle");\n\n        // Filtro de muros del mapa\n        if (mapMuroFilter) {\n          mapMuroFilter.addEventListener("change", (e) => {\n            const muroSeleccionado = e.target.value;\n            console.log("\u{1F5FA}\uFE0F Filtro de muro cambiado:", muroSeleccionado);\n\n            // Actualizar subt\xEDtulo\n            if (mapSubtitle) {\n              if (muroSeleccionado) {\n                mapSubtitle.textContent = \\`Mostrando canchas del Muro \\${muroSeleccionado}\\`;\n              } else {\n                mapSubtitle.textContent = "Mostrando todas las canchas";\n              }\n            }\n\n            // Recargar el iframe del mapa con el filtro aplicado\n            recargarMapaConFiltro(muroSeleccionado);\n          });\n        }\n\n        // Toggle de Revanchas\n        if (toggleRevanchas) {\n          toggleRevanchas.addEventListener("change", async (e) => {\n            const activado = e.target.checked;\n            console.log("\u{1F4CA} Revanchas toggle:", activado ? "ON" : "OFF");\n            \n            const mapContainer = document.getElementById("dashboard-map-container");\n            const iframe = mapContainer?.querySelector("iframe");\n            \n            if (!iframe || !iframe.contentWindow) {\n              console.log("\u26A0\uFE0F Iframe del mapa no disponible");\n              return;\n            }\n\n            if (activado) {\n              try {\n                console.log("\u{1F504} Cargando revanchas georreferenciadas...");\n                \n                // Obtener filtro de muro actual\n                const muroFiltro = mapMuroFilter?.value || \'\';\n                \n                // Construir URL con filtros\n                let apiUrl = \'/api/revanchas/georreferenciadas?soloUltimas=true&formato=geojson\';\n                if (muroFiltro) {\n                  apiUrl += \\`&muro=\\${muroFiltro}\\`;\n                }\n                \n                // Cargar datos de revanchas georreferenciadas\n                const response = await fetch(apiUrl);\n                if (!response.ok) {\n                  throw new Error(\\`Error \\${response.status}: \\${response.statusText}\\`);\n                }\n                \n                const geojsonData = await response.json();\n                console.log(\\`\u2705 \\${geojsonData.features.length} revanchas georreferenciadas cargadas\\`);\n                \n                // Enviar datos al iframe del mapa\n                iframe.contentWindow.postMessage({\n                  type: \'mostrar-revanchas\',\n                  data: geojsonData\n                }, \'*\');\n                \n                console.log("\u{1F4E4} Datos de revanchas enviados al mapa");\n              } catch (error) {\n                console.error("\u274C Error al cargar revanchas:", error);\n                alert("Error al cargar revanchas georreferenciadas");\n                // Desmarcar el toggle en caso de error\n                e.target.checked = false;\n              }\n            } else {\n              // Ocultar capa de revanchas\n              iframe.contentWindow.postMessage({\n                type: \'ocultar-revanchas\'\n              }, \'*\');\n              console.log("\u{1F4E4} Comando de ocultar revanchas enviado al mapa");\n            }\n          });\n        }\n      }\n\n      // Recargar el mapa con el filtro de muro aplicado\n      function recargarMapaConFiltro(muro) {\n        const mapContainer = document.getElementById("dashboard-map-container");\n        if (!mapContainer) return;\n\n        // Mostrar indicador de carga\n        mapContainer.innerHTML =\n          \'<div class="dashboard-map-loading">Cargando mapa...</div>\';\n\n        // Construir URL del mapa con filtro\n        let mapUrl = "/mapbox-window?dashboardMode=true";\n\n        // Obtener IDs de todas las canchas filtradas\n        const canchaIds = canchasFiltradas.map((c) => c.id).join(",");\n        if (canchaIds) {\n          mapUrl += \\`&canchaIds=\\${canchaIds}\\`;\n        }\n\n        // Agregar filtro de muro si est\xE1 seleccionado\n        if (muro) {\n          // Convertir nombre completo a c\xF3digo (Principal -> MP, Este -> ME, Oeste -> MO)\n          const muroCodigo =\n            muro === "Principal"\n              ? "MP"\n              : muro === "Este"\n                ? "ME"\n                : muro === "Oeste"\n                  ? "MO"\n                  : muro;\n          mapUrl += \\`&muro=\\${muroCodigo}\\`;\n        }\n\n        console.log("\u{1F310} Recargando mapa con URL:", mapUrl);\n\n        // Crear nuevo iframe\n        setTimeout(() => {\n          const iframe = document.createElement("iframe");\n          iframe.src = mapUrl;\n          iframe.style.width = "100%";\n          iframe.style.height = "100%";\n          iframe.style.border = "none";\n\n          mapContainer.innerHTML = "";\n          mapContainer.appendChild(iframe);\n        }, 300);\n      }\n\n      // Configurar event listeners de paginaci\xF3n\n      function configurarPaginacion() {\n        document\n          .getElementById("btn-primera-pagina")\n          .addEventListener("click", () => {\n            paginaActual = 1;\n            renderizarPaginaCanchas();\n          });\n\n        document\n          .getElementById("btn-pagina-anterior")\n          .addEventListener("click", () => {\n            if (paginaActual > 1) {\n              paginaActual--;\n              renderizarPaginaCanchas();\n            }\n          });\n\n        document\n          .getElementById("btn-pagina-siguiente")\n          .addEventListener("click", () => {\n            const totalPaginas = Math.ceil(\n              canchasFiltradas.length / filasPorPagina,\n            );\n            if (paginaActual < totalPaginas) {\n              paginaActual++;\n              renderizarPaginaCanchas();\n            }\n          });\n\n        document\n          .getElementById("btn-ultima-pagina")\n          .addEventListener("click", () => {\n            const totalPaginas = Math.ceil(\n              canchasFiltradas.length / filasPorPagina,\n            );\n            paginaActual = totalPaginas || 1;\n            renderizarPaginaCanchas();\n          });\n\n        // Configurar event listeners para widgets de estado (doble click)\n        const estadoWidgets = document.querySelectorAll(".estado-widget");\n        estadoWidgets.forEach((widget) => {\n          widget.addEventListener("dblclick", () => {\n            const estadoData = widget.getAttribute("data-estado");\n            const estadoMap = {\n              creada: "Creada",\n              "en-espera": "En Espera",\n              "en-proceso": "En Proceso",\n              validada: "Validada",\n              "rechazada-en-espera": "Rechazada, en Espera",\n              cerrada: "Cerrada",\n            };\n            const estadoNombre = estadoMap[estadoData];\n            if (estadoNombre) {\n              filtrarPorEstadoWidget(estadoNombre);\n            }\n          });\n        });\n      }\n\n      // Configurar selectores din\xE1micos de Muro y Sector\n      function configurarSelectoresMuroSector() {\n        const selectMuro = document.getElementById("muro-select");\n        const selectSector = document.getElementById("sector-select");\n\n        if (!selectMuro || !selectSector) return;\n\n        selectMuro.addEventListener("change", function () {\n          const muroSeleccionado = this.value;\n\n          // Limpiar opciones del sector\n          selectSector.innerHTML = "";\n\n          if (!muroSeleccionado) {\n            selectSector.disabled = true;\n            selectSector.innerHTML =\n              \'<option value="">Primero selecciona un muro</option>\';\n            return;\n          }\n\n          selectSector.disabled = false;\n          selectSector.innerHTML =\n            \'<option value="">Selecciona un sector</option>\';\n\n          // Agregar opciones seg\xFAn el muro seleccionado\n          if (muroSeleccionado === "MP") {\n            // MP: S1 hasta S7\n            for (let i = 1; i <= 7; i++) {\n              const option = document.createElement("option");\n              option.value = \\`S\\${i}\\`;\n              option.textContent = \\`S\\${i}\\`;\n              selectSector.appendChild(option);\n            }\n          } else if (muroSeleccionado === "ME" || muroSeleccionado === "MO") {\n            // ME y MO: S1 hasta S3\n            for (let i = 1; i <= 3; i++) {\n              const option = document.createElement("option");\n              option.value = \\`S\\${i}\\`;\n              option.textContent = \\`S\\${i}\\`;\n              selectSector.appendChild(option);\n            }\n          }\n        });\n      }\n\n      // Configurar event listeners del modal\n      function configurarModalEventListeners() {\n        // Bot\xF3n de cerrar modal\n        const closeBtn = document.querySelector(".close-btn");\n        if (closeBtn) {\n          closeBtn.addEventListener("click", cerrarTodosLosModales);\n        }\n      }\n\n      // === FUNCI\xD3N TEMPORAL DE DEBUG ===\n      window.debugCancha = function (canchaId) {\n        const cancha = todasLasCanchas.find((c) => c.id == canchaId);\n        if (cancha) {\n          console.log("=== DEBUG CANCHA ===");\n          console.log("Cancha encontrada:", cancha);\n          console.log("Estado actual:", cancha.estado_actual);\n          console.log("Empresa actual:", cancha.empresa_actual);\n          console.log("Validaciones:", cancha.validaciones);\n\n          if (cancha.validaciones) {\n            cancha.validaciones.forEach((v) => {\n              console.log(\\`- \\${v.empresa}: \\${v.estado}\\`);\n            });\n          }\n\n          // Verificar qu\xE9 botones deber\xEDa mostrar\n          const botonesGenerados = generarBotonesAccion(\n            canchaId,\n            cancha.estado_actual,\n            cancha.empresa_actual,\n          );\n          console.log("Botones que deber\xEDa generar:", botonesGenerados);\n\n          return cancha;\n        } else {\n          console.log("Cancha no encontrada con ID:", canchaId);\n          console.log(\n            "Canchas disponibles:",\n            todasLasCanchas.map((c) => ({ id: c.id, nombre: c.nombre })),\n          );\n          return null;\n        }\n      };\n\n      window.debugTodasLasCanchas = function () {\n        console.log("=== TODAS LAS CANCHAS ===");\n        todasLasCanchas.forEach((cancha) => {\n          console.log(\n            \\`ID: \\${cancha.id}, Nombre: \\${cancha.nombre}, Estado: \\${cancha.estado_actual}, Empresa: \\${cancha.empresa_actual}\\`,\n          );\n        });\n        return todasLasCanchas;\n      };\n\n      // === FUNCIONES DE AUTENTICACI\xD3N ===\n      // Las funciones de autenticaci\xF3n ahora se manejan en login.astro y AuthGuard.astro\n\n      // Cargar informaci\xF3n del usuario autenticado\n      async function cargarUsuarioAutenticado(usuario) {\n        try {\n          console.log("Cargando usuario autenticado:", usuario);\n\n          usuarioLogueado = usuario;\n          empresaLogueada = {\n            id: usuario.empresa_id,\n            nombre: usuario.empresa_nombre,\n          };\n\n          // Actualizar UI del header\n          userName.textContent = usuario.nombre_completo;\n          userRole.textContent = \\`\\${usuario.rol_nombre} - \\${usuario.empresa_nombre}\\`;\n\n          // Asignar logo de empresa\n          const companyLogo = document.getElementById("user-company-logo");\n          const logoMap = {\n            AngloAmerican: "/AngloAmerican.png",\n            Besalco: "/Besalco.png",\n            Linkapsis: "/Linkapsis.png",\n            LlayLlay: "/LlayLlay.png",\n          };\n\n          if (companyLogo && logoMap[usuario.empresa_nombre]) {\n            companyLogo.src = logoMap[usuario.empresa_nombre];\n            companyLogo.alt = \\`Logo \\${usuario.empresa_nombre}\\`;\n            companyLogo.style.display = "block";\n          }\n\n          userCompany.className = \\`empresa-actual empresa-\\${usuario.empresa_nombre.toLowerCase().replace(" ", "")}\\`;\n\n          // Mostrar/ocultar bot\xF3n de crear cancha seg\xFAn la empresa\n          if (usuario.empresa_nombre === "AngloAmerican") {\n            console.log("Mostrando bot\xF3n de crear cancha para AngloAmerican");\n            if (btnAbrirModalCrear)\n              btnAbrirModalCrear.style.display = "inline-flex";\n          } else {\n            console.log(\n              "Ocultando bot\xF3n de crear cancha para:",\n              usuario.empresa_nombre,\n            );\n            if (btnAbrirModalCrear) btnAbrirModalCrear.style.display = "none";\n          }\n\n          // Mostrar enlace de administraci\xF3n si es de AngloAmerican\n          if (usuario.empresa_id === 1) {\n            // AngloAmerican\n            btnAdminUsuarios.style.display = "inline-block";\n          } else {\n            btnAdminUsuarios.style.display = "none";\n          }\n\n          // === MOSTRAR BOTONES ESPECIALES PARA LINKAPSIS ===\n          // Linkapsis tiene empresa_nombre === "Linkapsis" (verificar en base de datos)\n          const btnSubirRevanchas = document.getElementById(\n            "btn-subir-revanchas",\n          );\n          const btnSubirCanchas = document.getElementById("btn-subir-canchas");\n\n          if (usuario.empresa_nombre === "Linkapsis") {\n            console.log("Mostrando botones especiales para Linkapsis");\n            if (btnSubirRevanchas)\n              btnSubirRevanchas.style.display = "inline-flex";\n            if (btnSubirCanchas) btnSubirCanchas.style.display = "inline-flex";\n          } else {\n            if (btnSubirRevanchas) btnSubirRevanchas.style.display = "none";\n            if (btnSubirCanchas) btnSubirCanchas.style.display = "none";\n          }\n\n          // Cargar datos\n          await cargarCanchas();\n\n          // Mensaje de bienvenida eliminado para evitar duplicados\n        } catch (error) {\n          console.error("Error cargando usuario:", error);\n          mostrarMensaje("Error al cargar informaci\xF3n del usuario", "error");\n          window.location.href = "/login";\n        }\n      }\n\n      function getRolEmpresa(nombreEmpresa) {\n        const roles = {\n          AngloAmerican: "Creaci\xF3n y cierre de canchas",\n          Besalco: "Trabajo de maquinaria",\n          Linkapsis: "Validaci\xF3n de espesores",\n          LlayLlay: "Validaci\xF3n de densidad",\n        };\n        return roles[nombreEmpresa] || "Usuario del sistema";\n      }\n\n      // ========================================\n      // FUNCIONES PARA BOTONES LINKAPSIS\n      // ========================================\n      /**\n       * Configurar event listeners para los botones especiales de Linkapsis\n       * - btn-subir-revanchas: Abre modal para cargar informaci\xF3n de revanchas\n       * - btn-subir-canchas: Abre modal para carga masiva de canchas\n       */\n      function configurarBotonesLinkapsis() {\n        const btnSubirRevanchas = document.getElementById(\n          "btn-subir-revanchas",\n        );\n        const btnSubirCanchas = document.getElementById("btn-subir-canchas");\n\n        // Event listener para Subir Revanchas\n        if (btnSubirRevanchas) {\n          btnSubirRevanchas.addEventListener("click", () => {\n            console.log("Abriendo modal de Subir Revanchas");\n            abrirModalSubirRevanchas();\n          });\n        }\n\n        // Event listener para Subir Canchas\n        if (btnSubirCanchas) {\n          btnSubirCanchas.addEventListener("click", () => {\n            console.log("Abriendo modal de Subir Canchas");\n            abrirModalSubirCanchas();\n          });\n        }\n\n        // Configurar cierre de modales\n        configurarCierreModalesLinkapsis();\n      }\n\n      /**\n       * Abrir modal de Subir Revanchas\n       * TODO: Implementar l\xF3gica de carga y procesamiento de revanchas\n       */\n      function abrirModalSubirRevanchas() {\n        const modal = document.getElementById("modal-subir-revanchas");\n        if (modal) {\n          modal.classList.add("show");\n          // TODO: Inicializar formulario, limpiar campos previos\n          // TODO: Configurar validaciones de archivo\n        }\n      }\n\n      /**\n       * Abrir modal de Subir Canchas\n       * TODO: Implementar l\xF3gica de carga masiva de canchas\n       */\n      function abrirModalSubirCanchas() {\n        const modal = document.getElementById("modal-subir-canchas");\n        if (modal) {\n          modal.classList.add("show");\n          // TODO: Inicializar formulario, limpiar campos previos\n          // TODO: Configurar validaciones de archivo y geometr\xEDas\n        }\n      }\n\n      /**\n       * Configurar event listeners para cerrar modales de Linkapsis\n       * Permite cerrar con:\n       * - Bot\xF3n X (close-btn)\n       * - Bot\xF3n Cancelar/Cerrar (btn-cancel)\n       * - Click fuera del modal (backdrop)\n       */\n      function configurarCierreModalesLinkapsis() {\n        const modales = [\n          { id: "modal-subir-revanchas", nombre: "Subir Revanchas" },\n          { id: "modal-subir-canchas", nombre: "Subir Canchas" },\n        ];\n\n        modales.forEach((modalInfo) => {\n          const modal = document.getElementById(modalInfo.id);\n          if (!modal) {\n            console.warn(\\`Modal \\${modalInfo.nombre} no encontrado\\`);\n            return;\n          }\n\n          const closeBtn = modal.querySelector(".close-btn");\n          const cancelBtn = modal.querySelector(".btn-cancel");\n\n          // Cerrar con bot\xF3n X\n          if (closeBtn) {\n            closeBtn.addEventListener("click", () => {\n              console.log(\\`Cerrando modal \\${modalInfo.nombre} (bot\xF3n X)\\`);\n              modal.classList.remove("show");\n            });\n          }\n\n          // Cerrar con bot\xF3n Cancelar/Cerrar\n          if (cancelBtn) {\n            cancelBtn.addEventListener("click", () => {\n              console.log(\n                \\`Cerrando modal \\${modalInfo.nombre} (bot\xF3n Cancelar)\\`,\n              );\n              modal.classList.remove("show");\n            });\n          }\n\n          // Cerrar al hacer click en el backdrop (fuera del modal-content)\n          modal.addEventListener("click", (e) => {\n            if (e.target === modal) {\n              console.log(\\`Cerrando modal \\${modalInfo.nombre} (backdrop)\\`);\n              modal.classList.remove("show");\n            }\n          });\n        });\n      }\n\n      function cerrarSesion() {\n        usuarioLogueado = null;\n        empresaLogueada = null;\n\n        // Limpiar localStorage\n        localStorage.removeItem("userSession");\n\n        // Redirigir al login\n        window.location.href = "/login";\n        todasLasCanchas = [];\n        canchasFiltradas = [];\n\n        mostrarMensaje("Sesi\xF3n cerrada correctamente", "success");\n      }\n\n      // === FUNCIONES DE CARGA DE DATOS ===\n\n      // === FUNCIONES DE FILTROS ===\n      function cambiarVista(nuevaVista) {\n        console.log("Cambiando vista a:", nuevaVista);\n        vistaActual = nuevaVista;\n\n        // Actualizar botones\n        btnVistaAcciones.classList.toggle("active", nuevaVista === "acciones");\n        btnVistaHistorico.classList.toggle(\n          "active",\n          nuevaVista === "historico",\n        );\n\n        // Aplicar filtros\n        aplicarFiltros();\n\n        // Actualizar slider\n        updateSliderPosition();\n      }\n\n      function updateSliderPosition() {\n        const container = document.querySelector(".toggle-container");\n        const activeBtn = container?.querySelector(".active");\n        const slider = container?.querySelector(".toggle-slider");\n\n        if (activeBtn && slider && container) {\n          // Calcular posici\xF3n relativa al contenedor\n          const containerRect = container.getBoundingClientRect();\n          const btnRect = activeBtn.getBoundingClientRect();\n\n          const left = btnRect.left - containerRect.left;\n          const width = btnRect.width;\n\n          slider.style.transform = \\`translateX(\\${left}px)\\`;\n          slider.style.width = \\`\\${width}px\\`;\n        }\n      }\n\n      function manejarCambioFiltroFecha() {\n        filtroFecha = filtroFechaSelect.value;\n\n        if (filtroFecha === "custom") {\n          rangoFechas.classList.remove("hidden");\n        } else {\n          rangoFechas.classList.add("hidden");\n          aplicarFiltros();\n        }\n      }\n\n      function aplicarRangoFechas() {\n        const desde = fechaDesde.value;\n        const hasta = fechaHasta.value;\n\n        if (!desde || !hasta) {\n          mostrarMensaje("Por favor selecciona ambas fechas", "error");\n          return;\n        }\n\n        aplicarFiltros();\n      }\n\n      function aplicarFiltros() {\n        if (!empresaLogueada || !todasLasCanchas.length) return;\n\n        canchasFiltradas = [...todasLasCanchas];\n        console.log("Aplicando filtros, vista actual:", vistaActual);\n        console.log("Total canchas antes del filtro:", canchasFiltradas.length);\n\n        // Filtro por vista (acciones vs hist\xF3rico)\n        if (vistaActual === "acciones") {\n          canchasFiltradas = filtrarPorAccionesDisponibles(canchasFiltradas);\n          console.log(\n            "Canchas despu\xE9s del filtro de acciones:",\n            canchasFiltradas.length,\n          );\n        }\n\n        // Filtro por fecha\n        canchasFiltradas = filtrarPorFecha(canchasFiltradas);\n\n        // Filtro por estado desde widgets circulares\n        if (filtroEstadoActivo) {\n          canchasFiltradas = canchasFiltradas.filter(\n            (cancha) => cancha.estado_actual === filtroEstadoActivo,\n          );\n          console.log(\n            "Canchas despu\xE9s del filtro de estado:",\n            canchasFiltradas.length,\n          );\n        }\n\n        // Reiniciar a la primera p\xE1gina al aplicar filtros\n        paginaActual = 1;\n\n        // Mostrar resultados\n        mostrarCanchas(canchasFiltradas);\n        actualizarContadorResultados(\n          canchasFiltradas.length,\n          todasLasCanchas.length,\n        );\n      }\n\n      function filtrarPorAccionesDisponibles(canchas) {\n        const empresaId = empresaLogueada.id;\n        const empresaNombre = empresaLogueada.nombre;\n\n        console.log("Filtrando para empresa:", empresaNombre);\n\n        return canchas.filter((cancha) => {\n          const estado = cancha.estado_actual;\n          const empresaActual = cancha.empresa_actual;\n\n          console.log(\n            \\`Cancha \\${cancha.nombre}: estado="\\${estado}", empresa="\\${empresaActual}"\\`,\n          );\n\n          let tieneAccion = false;\n\n          switch (empresaNombre) {\n            case "AngloAmerican":\n              // AngloAmerican puede actuar cuando:\n              // - Cancha creada (enviar a Besalco)\n              // - Cancha validada (cerrar)\n              tieneAccion = estado === "Creada" || estado === "Validada";\n              break;\n\n            case "Besalco":\n              // Besalco puede actuar cuando:\n              // - Est\xE1 en espera (reci\xE9n asignada o rechazada)\n              // - Est\xE1 en proceso (trabajando activamente)\n              tieneAccion =\n                (estado === "En Espera" && empresaActual === "Besalco") ||\n                (estado === "En Proceso" && empresaActual === "Besalco") ||\n                (estado === "Rechazada, en Espera" &&\n                  empresaActual === "Besalco");\n              break;\n\n            case "Linkapsis":\n              // Linkapsis puede actuar cuando est\xE1 en espera o en proceso\n              tieneAccion =\n                (estado === "En Espera" && empresaActual === "Linkapsis") ||\n                (estado === "En Proceso" && empresaActual === "Linkapsis");\n              break;\n\n            case "LlayLlay":\n              // LlayLlay puede actuar cuando est\xE1 en espera o en proceso\n              tieneAccion =\n                (estado === "En Espera" && empresaActual === "LlayLlay") ||\n                (estado === "En Proceso" && empresaActual === "LlayLlay");\n              break;\n\n            default:\n              tieneAccion = false;\n          }\n\n          console.log(\\`-> Tiene acci\xF3n: \\${tieneAccion}\\`);\n          return tieneAccion;\n        });\n      }\n\n      function filtrarPorFecha(canchas) {\n        if (filtroFecha === "all") return canchas;\n\n        const ahora = new Date();\n        const hoy = new Date(\n          ahora.getFullYear(),\n          ahora.getMonth(),\n          ahora.getDate(),\n        );\n\n        return canchas.filter((cancha) => {\n          const fechaCancha = new Date(cancha.created_at);\n\n          switch (filtroFecha) {\n            case "today":\n              return fechaCancha >= hoy;\n            case "week":\n              const semanaAtras = new Date(\n                hoy.getTime() - 7 * 24 * 60 * 60 * 1000,\n              );\n              return fechaCancha >= semanaAtras;\n            case "month":\n              const mesAtras = new Date(\n                hoy.getTime() - 30 * 24 * 60 * 60 * 1000,\n              );\n              return fechaCancha >= mesAtras;\n            case "custom":\n              if (!fechaDesde.value || !fechaHasta.value) return true;\n              const desde = new Date(fechaDesde.value);\n              const hasta = new Date(fechaHasta.value + "T23:59:59");\n              return fechaCancha >= desde && fechaCancha <= hasta;\n            default:\n              return true;\n          }\n        });\n      }\n\n      // Actualizar dashboard de estados con contadores\n      function actualizarContadorResultados(mostradas, total) {\n        // === ACTUALIZAR WIDGETS ORIGINALES (SIDEBAR) ===\n        // Contar acciones disponibles para la empresa logueada\n        const accionesDisponibles = canchasFiltradas.filter((cancha) => {\n          const estado = cancha.estado_actual;\n          const empresaActual = cancha.empresa_actual;\n\n          if (!empresaLogueada) return false;\n\n          let tieneAccion = false;\n          const empresaNombre = empresaLogueada.nombre;\n\n          switch (empresaNombre) {\n            case "AngloAmerican":\n              // AngloAmerican puede actuar cuando:\n              // - Cancha creada (enviar a Besalco)\n              // - Cancha validada (cerrar)\n              tieneAccion = estado === "Creada" || estado === "Validada";\n              break;\n            case "Besalco":\n              // Besalco puede actuar cuando:\n              // - Est\xE1 en espera (reci\xE9n asignada o rechazada)\n              // - Est\xE1 en proceso (trabajando activamente)\n              tieneAccion =\n                (estado === "En Espera" && empresaActual === "Besalco") ||\n                (estado === "En Proceso" && empresaActual === "Besalco") ||\n                (estado === "Rechazada, en Espera" &&\n                  empresaActual === "Besalco");\n              break;\n            case "Linkapsis":\n              // Linkapsis puede actuar cuando est\xE1 en espera o en proceso\n              tieneAccion =\n                (estado === "En Espera" && empresaActual === "Linkapsis") ||\n                (estado === "En Proceso" && empresaActual === "Linkapsis");\n              break;\n            case "LlayLlay":\n              // LlayLlay puede actuar cuando est\xE1 en espera o en proceso\n              tieneAccion =\n                (estado === "En Espera" && empresaActual === "LlayLlay") ||\n                (estado === "En Proceso" && empresaActual === "LlayLlay");\n              break;\n            default:\n              tieneAccion = false;\n          }\n          return tieneAccion;\n        }).length;\n\n        // Actualizar contadores del sidebar\n        const statAcciones = document.getElementById("stat-acciones");\n        const statTotal = document.getElementById("stat-total");\n\n        if (statAcciones) {\n          animateNumber(\n            statAcciones,\n            parseInt(statAcciones.textContent) || 0,\n            accionesDisponibles,\n          );\n        }\n\n        if (statTotal) {\n          animateNumber(statTotal, parseInt(statTotal.textContent) || 0, total);\n        }\n\n        // === ACTUALIZAR WIDGETS CIRCULARES (DASHBOARD DE ESTADOS) ===\n        // Contar canchas por estado\n        const contadores = {\n          Creada: 0,\n          "En Espera": 0,\n          "En Proceso": 0,\n          Validada: 0,\n          "Rechazada, en Espera": 0,\n          Cerrada: 0,\n        };\n\n        // Contar las canchas filtradas por estado\n        canchasFiltradas.forEach((cancha) => {\n          const estado = cancha.estado_actual;\n          if (contadores.hasOwnProperty(estado)) {\n            contadores[estado]++;\n          }\n        });\n\n        // Actualizar los widgets circulares con animaci\xF3n\n        animateNumber(\n          document.getElementById("count-creada"),\n          parseInt(document.getElementById("count-creada").textContent) || 0,\n          contadores["Creada"],\n        );\n\n        animateNumber(\n          document.getElementById("count-en-espera"),\n          parseInt(document.getElementById("count-en-espera").textContent) || 0,\n          contadores["En Espera"],\n        );\n\n        animateNumber(\n          document.getElementById("count-en-proceso"),\n          parseInt(document.getElementById("count-en-proceso").textContent) ||\n            0,\n          contadores["En Proceso"],\n        );\n\n        animateNumber(\n          document.getElementById("count-validada"),\n          parseInt(document.getElementById("count-validada").textContent) || 0,\n          contadores["Validada"],\n        );\n\n        animateNumber(\n          document.getElementById("count-rechazada-en-espera"),\n          parseInt(\n            document.getElementById("count-rechazada-en-espera").textContent,\n          ) || 0,\n          contadores["Rechazada, en Espera"],\n        );\n\n        animateNumber(\n          document.getElementById("count-cerrada"),\n          parseInt(document.getElementById("count-cerrada").textContent) || 0,\n          contadores["Cerrada"],\n        );\n\n        // Actualizar subt\xEDtulo del mapa\n        actualizarSubtituloMapa(mostradas);\n      }\n\n      // Manejar doble click en widgets de estado para filtrar\n      function filtrarPorEstadoWidget(estadoNombre) {\n        const widgets = document.querySelectorAll(".estado-widget");\n\n        // Si se clickea el mismo estado, desactivar filtro\n        if (filtroEstadoActivo === estadoNombre) {\n          filtroEstadoActivo = null;\n          widgets.forEach((w) => {\n            w.classList.remove("selected");\n            w.classList.remove("dimmed");\n          });\n        } else {\n          // Activar nuevo filtro\n          filtroEstadoActivo = estadoNombre;\n\n          // Actualizar clases de selecci\xF3n y dimmed\n          widgets.forEach((widget) => {\n            const estadoWidget = widget.getAttribute("data-estado");\n            const estadoMap = {\n              creada: "Creada",\n              "en-espera": "En Espera",\n              "en-proceso": "En Proceso",\n              validada: "Validada",\n              "rechazada-en-espera": "Rechazada, en Espera",\n              cerrada: "Cerrada",\n            };\n\n            if (estadoMap[estadoWidget] === estadoNombre) {\n              widget.classList.add("selected");\n              widget.classList.remove("dimmed");\n            } else {\n              widget.classList.remove("selected");\n              widget.classList.add("dimmed");\n            }\n          });\n        }\n\n        // Re-aplicar filtros\n        aplicarFiltros();\n      }\n\n      // Actualizar subt\xEDtulo del mapa seg\xFAn filtros activos\n      function actualizarSubtituloMapa(cantidadCanchas) {\n        const subtitle = document.getElementById("map-subtitle");\n        if (!subtitle) return;\n\n        let texto = "";\n\n        if (vistaActual === "acciones") {\n          texto = \\`Mostrando \\${cantidadCanchas} cancha\\${cantidadCanchas !== 1 ? "s" : ""} con acciones disponibles\\`;\n        } else {\n          texto = \\`Mostrando \\${cantidadCanchas} cancha\\${cantidadCanchas !== 1 ? "s" : ""} del hist\xF3rico\\`;\n        }\n\n        // Agregar informaci\xF3n del filtro de fecha\n        if (filtroFecha === "today") {\n          texto += " (Hoy)";\n        } else if (filtroFecha === "week") {\n          texto += " (\xDAltima semana)";\n        } else if (filtroFecha === "month") {\n          texto += " (\xDAltimo mes)";\n        } else if (filtroFecha === "custom") {\n          texto += " (Rango personalizado)";\n        }\n\n        subtitle.textContent = texto;\n      }\n\n      // Actualizar mapa dashboard con las canchas filtradas\n      function actualizarMapaDashboard(canchas) {\n        const mapContainer = document.getElementById("dashboard-map-container");\n        if (!mapContainer) return;\n\n        console.log(\n          "\u{1F5FA}\uFE0F Actualizando mapa dashboard con",\n          canchas.length,\n          "canchas",\n        );\n\n        // Extraer IDs de canchas para el mapa\n        const canchaIds = canchas.map((c) => c.id).join(",");\n\n        // Construir URL del iframe con par\xE1metros de filtrado\n        const params = new URLSearchParams();\n        params.set("dashboardMode", "true");\n        params.set("canchaIds", canchaIds);\n\n        const mapUrl = \\`/mapbox-window?\\${params.toString()}\\`;\n\n        // Crear o actualizar iframe\n        let iframe = mapContainer.querySelector("iframe");\n        if (!iframe) {\n          iframe = document.createElement("iframe");\n          iframe.style.width = "100%";\n          iframe.style.height = "100%";\n          iframe.style.border = "none";\n\n          // Limpiar loading y agregar iframe\n          mapContainer.innerHTML = "";\n          mapContainer.appendChild(iframe);\n        }\n\n        // Actualizar src del iframe\n        iframe.src = mapUrl;\n\n        console.log("\u2705 Mapa dashboard actualizado con URL:", mapUrl);\n      }\n\n      // Funci\xF3n para animar n\xFAmeros\n      function animateNumber(element, start, end, suffix = "") {\n        const duration = 800;\n        const startTime = Date.now();\n\n        function update() {\n          const elapsed = Date.now() - startTime;\n          const progress = Math.min(elapsed / duration, 1);\n\n          // Easing function (ease-out)\n          const easedProgress = 1 - Math.pow(1 - progress, 3);\n          const current = Math.round(start + (end - start) * easedProgress);\n\n          element.textContent = current + suffix;\n\n          if (progress < 1) {\n            requestAnimationFrame(update);\n          }\n        }\n\n        update();\n      }\n\n      // === FUNCI\xD3N DE CREACI\xD3N DE CANCHAS ===\n      async function crearCancha() {\n        console.log("Funci\xF3n crearCancha llamada");\n        if (cargando) return;\n\n        const muro = document.getElementById("muro").value.trim();\n        const sector = document.getElementById("sector").value.trim();\n        const nombreDetalle = document\n          .getElementById("nombre-detalle")\n          .value.trim();\n\n        console.log("Datos del formulario:", { muro, sector, nombreDetalle });\n\n        if (!muro || !sector || !nombreDetalle) {\n          alert("Por favor completa todos los campos");\n          return;\n        }\n\n        try {\n          cargando = true;\n          btnCrearCancha.textContent = "Creando...";\n          btnCrearCancha.disabled = true;\n\n          const response = await fetch("/api/canchas", {\n            method: "POST",\n            headers: {\n              "Content-Type": "application/json",\n            },\n            body: JSON.stringify({ muro, sector, nombreDetalle }),\n          });\n\n          if (!response.ok) {\n            const error = await response.json();\n            throw new Error(error.message || "Error al crear cancha");\n          }\n\n          // Limpiar formulario\n          document.getElementById("muro").value = "";\n          document.getElementById("sector").value = "";\n          document.getElementById("nombre-detalle").value = "";\n\n          // Recargar tabla\n          await cargarCanchas();\n\n          mostrarMensaje("Cancha creada exitosamente", "success");\n        } catch (error) {\n          console.error("Error al crear cancha:", error);\n          mostrarMensaje("Error al crear la cancha: " + error.message, "error");\n        } finally {\n          cargando = false;\n          btnCrearCancha.textContent = "Crear Cancha";\n          btnCrearCancha.disabled = false;\n        }\n      }\n\n      // === FUNCI\xD3N DE CARGA DE CANCHAS ===\n      async function cargarCanchas() {\n        try {\n          const response = await fetch("/api/canchas");\n          if (!response.ok) {\n            throw new Error("Error al cargar canchas");\n          }\n\n          todasLasCanchas = await response.json();\n          console.log("\u{1F5C2}\uFE0F Datos de canchas cargados:", todasLasCanchas);\n          if (todasLasCanchas.length > 0) {\n            console.log("\u{1F50D} Primer cancha ejemplo:", todasLasCanchas[0]);\n            console.log(\n              "\u{1F3F7}\uFE0F Campos disponibles:",\n              Object.keys(todasLasCanchas[0]),\n            );\n          }\n          aplicarFiltros();\n        } catch (error) {\n          console.error("Error al cargar canchas:", error);\n          mostrarMensaje("Error al cargar las canchas", "error");\n        }\n      }\n\n      // Mostrar canchas filtradas\n      function mostrarCanchas(canchas) {\n        renderizarCanchas(canchas);\n        actualizarMapaDashboard(canchas);\n      }\n\n      // Renderizar tabla de canchas con paginaci\xF3n\n      function renderizarCanchas(canchas) {\n        canchasFiltradas = canchas;\n        paginaActual = 1; // Resetear a la primera p\xE1gina cuando cambian los datos\n        renderizarPaginaCanchas();\n      }\n\n      // Renderizar p\xE1gina espec\xEDfica de canchas\n      function renderizarPaginaCanchas() {\n        const inicio = (paginaActual - 1) * filasPorPagina;\n        const fin = inicio + filasPorPagina;\n        const canchasPagina = canchasFiltradas.slice(inicio, fin);\n\n        canchasTBody.innerHTML = canchasPagina\n          .map(\n            (cancha) => \\`\n          <tr data-cancha-id="\\${cancha.id}" class="cancha-row">\n            <td style="text-align: center;">\n              <input type="checkbox" class="cancha-checkbox" data-cancha-id="\\${cancha.id}" data-cancha-nombre="\\${cancha.nombre}">\n            </td>\n            <td><strong>\\${cancha.nombre.toUpperCase()}</strong></td>\n            <td>\n              <span class="estado estado-\\${cancha.estado_actual.toLowerCase().replace(/\\\\s+/g, "-")}">\n                \\${cancha.estado_actual}\n              </span>\n            </td>\n            <td>\n              <span class="empresa-actual empresa-\\${cancha.empresa_actual.toLowerCase().replace(/\\\\s+/g, "-")}">\n                \\${cancha.empresa_actual}\n              </span>\n            </td>\n            <td>\\${new Date(cancha.created_at).toLocaleDateString("es-ES")}</td>\n            <td>\n              <button class="btn-mapa" data-cancha-id="\\${cancha.id}" data-cancha-nombre="\\${cancha.nombre}" type="button" style="background:none; border:none; font-size:1.5rem; cursor:pointer; padding:0.5rem; transition: transform 0.2s;" title="Ver en mapa">\u{1F5FA}\uFE0F</button>\n            </td>\n            <td>\n              <div class="actions" data-cancha-id="\\${cancha.id}" data-estado="\\${cancha.estado_actual}" data-empresa="\\${cancha.empresa_actual}">\n              </div>\n            </td>\n          </tr>\n        \\`,\n          )\n          .join("");\n\n        // Agregar event listeners para botones del mapa inmediatamente despu\xE9s de renderizar\n        setTimeout(() => {\n          console.log("\u{1F527} Agregando event listeners para botones del mapa...");\n          document.querySelectorAll(".btn-mapa").forEach((btn, index) => {\n            console.log(\\`\u{1F527} Configurando bot\xF3n \\${index}:\\`, btn.dataset);\n            btn.addEventListener("click", (e) => {\n              const canchaId = e.target.dataset.canchaId;\n              const canchaName = e.target.dataset.canchaNombre;\n              console.log("\u{1F5FA}\uFE0F Bot\xF3n de mapa clickeado:", {\n                canchaId,\n                canchaName,\n              });\n              console.log("\u{1F50D} Datasets disponibles:", e.target.dataset);\n              abrirMapaModal(canchaId, canchaName);\n            });\n          });\n\n          // Agregar listeners de checkboxes\n          attachCheckboxListeners();\n        }, 100); // Peque\xF1o delay para asegurar que el DOM est\xE9 actualizado\n\n        actualizarAcciones();\n        actualizarControlesPaginacion();\n      }\n\n      // Actualizar controles de paginaci\xF3n\n      function actualizarControlesPaginacion() {\n        const totalCanchas = canchasFiltradas.length;\n        const totalPaginas = Math.ceil(totalCanchas / filasPorPagina);\n        const inicio = (paginaActual - 1) * filasPorPagina + 1;\n        const fin = Math.min(inicio + filasPorPagina - 1, totalCanchas);\n\n        document.getElementById("pagination-start").textContent =\n          totalCanchas > 0 ? inicio : 0;\n        document.getElementById("pagination-end").textContent = fin;\n        document.getElementById("pagination-total").textContent = totalCanchas;\n        document.getElementById("pagina-actual").textContent = paginaActual;\n        document.getElementById("total-paginas").textContent =\n          totalPaginas || 1;\n\n        // Habilitar/deshabilitar botones\n        document.getElementById("btn-primera-pagina").disabled =\n          paginaActual === 1;\n        document.getElementById("btn-pagina-anterior").disabled =\n          paginaActual === 1;\n        document.getElementById("btn-pagina-siguiente").disabled =\n          paginaActual >= totalPaginas;\n        document.getElementById("btn-ultima-pagina").disabled =\n          paginaActual >= totalPaginas;\n      }\n\n      // Actualizar botones de acci\xF3n seg\xFAn empresa seleccionada\n      function actualizarAcciones() {\n        console.log("Actualizando acciones para empresa:", empresaLogueada);\n        const actionsDivs = document.querySelectorAll(".actions");\n\n        console.log("Encontrados", actionsDivs.length, "divs de acciones");\n\n        actionsDivs.forEach((div, index) => {\n          const canchaId = div.dataset.canchaId;\n          const estado = div.dataset.estado;\n          const empresaActual = div.dataset.empresa;\n\n          console.log(\n            \\`Procesando div \\${index}: canchaId=\\${canchaId}, estado=\\${estado}, empresaActual=\\${empresaActual}\\`,\n          );\n\n          const botonesHTML = generarBotonesAccion(\n            canchaId,\n            estado,\n            empresaActual,\n          );\n          console.log(\\`Botones generados: \\${botonesHTML}\\`);\n          div.innerHTML = botonesHTML;\n        });\n\n        // Agregar event listeners a los botones\n        agregarEventListeners();\n        console.log("Event listeners agregados");\n\n        // Agregar event listeners de doble-click\n        agregarEventListenersDobleClick();\n      }\n\n      // Generar botones seg\xFAn empresa y estado\n      function generarBotonesAccion(canchaId, estado, empresaActual) {\n        console.log(\n          \\`generarBotonesAccion: canchaId=\\${canchaId}, estado=\\${estado}, empresaActual=\\${empresaActual}\\`,\n        );\n        console.log("empresaLogueada:", empresaLogueada);\n\n        if (!empresaLogueada) {\n          console.log("No hay empresa logueada");\n          return \'<span style="color:#666;">Selecciona tu empresa</span>\';\n        }\n\n        const botones = [];\n        const empresaId = empresaLogueada.id;\n        console.log("Empresa ID:", empresaId);\n\n        // AngloAmerican\n        if (empresaId === 1) {\n          console.log("Procesando para AngloAmerican");\n          if (estado === "Creada") {\n            console.log("Estado es Creada, agregando bot\xF3n enviar a Besalco");\n            botones.push(\n              \\`<button class="btn-accion" data-accion="enviar-besalco" data-cancha-id="\\${canchaId}">\u{1F4E4} Enviar a Besalco</button>\\`,\n            );\n          } else if (estado === "Validada") {\n            console.log("Estado es Validada, agregando bot\xF3n cerrar cancha");\n            botones.push(\n              \\`<button class="btn-accion btn-success" data-accion="abrir-modal-cierre" data-cancha-id="\\${canchaId}">\u{1F512} Cerrar Cancha</button>\\`,\n            );\n          } else if (\n            estado === "En Proceso" &&\n            empresaActual === "AngloAmerican"\n          ) {\n            console.log(\n              "Estado es En Proceso y empresa actual es AngloAmerican",\n            );\n            // Buscar la cancha para verificar validaciones\n            const cancha = todasLasCanchas.find((c) => c.id == canchaId);\n            if (cancha) {\n              const validaciones = cancha.validaciones || [];\n              console.log("Validaciones encontradas:", validaciones);\n              const hasLinkapsis = validaciones.some(\n                (v) => v.empresa === "Linkapsis" && v.estado === "VALIDADO",\n              );\n              const hasLlayLlay = validaciones.some(\n                (v) => v.empresa === "LlayLlay" && v.estado === "VALIDADO",\n              );\n              const hasBesalco = validaciones.some(\n                (v) => v.empresa === "Besalco" && v.estado === "VALIDADO",\n              );\n\n              console.log("Estado validaciones:", {\n                hasLinkapsis,\n                hasLlayLlay,\n                hasBesalco,\n              });\n\n              if (hasLinkapsis && hasLlayLlay && hasBesalco) {\n                console.log(\n                  "Todas las validaciones completas, agregando bot\xF3n PDF",\n                );\n                botones.push(\n                  \\`<button class="btn-accion btn-pdf" data-accion="exportar-pdf" data-cancha-id="\\${canchaId}">\u{1F4C4} PDF</button>\\`,\n                );\n              }\n            }\n          } else if (estado === "Finalizada" || estado === "Cerrada") {\n            console.log("Estado es Finalizada/Cerrada, agregando bot\xF3n PDF");\n            // Para canchas finalizadas o cerradas, siempre mostrar el bot\xF3n PDF\n            botones.push(\n              \\`<button class="btn-accion btn-pdf" data-accion="exportar-pdf" data-cancha-id="\\${canchaId}">\u{1F4C4} PDF</button>\\`,\n            );\n          }\n        }\n\n        // Besalco\n        else if (empresaId === 2) {\n          if (\n            (estado === "En Espera" || estado === "Rechazada, en Espera") &&\n            empresaActual === "Besalco"\n          ) {\n            // Cancha en espera - Recepcionar para revisar\n            botones.push(\n              \\`<button class="btn-accion btn-info" data-accion="recepcionar-besalco" data-cancha-id="\\${canchaId}">\u{1F4CB} Recepcionar Trabajo</button>\\`,\n            );\n          } else if (estado === "En Proceso" && empresaActual === "Besalco") {\n            // Cancha en proceso - Validar trabajo activo\n            botones.push(\n              \\`<button class="btn-accion btn-success" data-accion="validar-besalco" data-cancha-id="\\${canchaId}">\u{1F6E0}\uFE0F Gestionar</button>\\`,\n            );\n          }\n        }\n\n        // Linkapsis\n        else if (empresaId === 3) {\n          if (estado === "En Espera" && empresaActual === "Linkapsis") {\n            // Cancha en espera - Recepcionar para revisar\n            botones.push(\n              \\`<button class="btn-accion btn-info" data-accion="recepcionar-linkapsis" data-cancha-id="\\${canchaId}">\u{1F4CB} Recepcionar Trabajo</button>\\`,\n            );\n          } else if (estado === "En Proceso" && empresaActual === "Linkapsis") {\n            // Cancha en proceso - Validar espesores\n            botones.push(\n              \\`<button class="btn-accion btn-success" data-accion="validar-linkapsis" data-cancha-id="\\${canchaId}">\u{1F4CF} Gestionar</button>\\`,\n            );\n          }\n        }\n\n        // LlayLlay\n        else if (empresaId === 4) {\n          if (estado === "En Espera" && empresaActual === "LlayLlay") {\n            // Cancha en espera - Recepcionar para revisar\n            botones.push(\n              \\`<button class="btn-accion btn-info" data-accion="recepcionar-llayllay" data-cancha-id="\\${canchaId}">\u{1F4CB} Recepcionar Trabajo</button>\\`,\n            );\n          } else if (estado === "En Proceso" && empresaActual === "LlayLlay") {\n            // Cancha en proceso - Validar densidad\n            botones.push(\n              \\`<button class="btn-accion btn-success" data-accion="validar-llayllay" data-cancha-id="\\${canchaId}">\u{1F9EA} Gestionar</button>\\`,\n            );\n          }\n        }\n\n        return botones.length > 0\n          ? botones.join("")\n          : \'<span style="color:#666;">Sin acciones disponibles</span>\';\n      }\n\n      // Generar botones de administraci\xF3n (solo para AngloAmerican)\n      // NOTA: Las funciones generarBotonesAdmin() y actualizarColumnaAdmin() fueron eliminadas\n      // porque ahora se usa el sistema de selecci\xF3n m\xFAltiple con checkboxes\n\n      // Agregar event listeners a botones de acci\xF3n\n      function agregarEventListeners() {\n        document.querySelectorAll(".btn-accion").forEach((btn) => {\n          btn.addEventListener("click", manejarAccion);\n        });\n\n        // Los event listeners para botones del mapa se agregan en renderizarCanchas()\n        console.log("\u{1F5B1}\uFE0F Event listeners de acciones agregados");\n      }\n\n      // Agregar event listeners de doble-click a las filas de la tabla\n      function agregarEventListenersDobleClick() {\n        document.querySelectorAll(".cancha-row").forEach((row) => {\n          row.addEventListener("dblclick", (e) => {\n            const canchaId = e.currentTarget.dataset.canchaId;\n            console.log("\u{1F5B1}\uFE0F Doble-click en cancha:", canchaId);\n            hacerZoomEnMapaDashboard(canchaId);\n          });\n        });\n        console.log("\u2705 Event listeners de doble-click agregados");\n      }\n\n      // Enviar mensaje al iframe del mapa para hacer zoom a una cancha\n      function hacerZoomEnMapaDashboard(canchaId) {\n        const mapContainer = document.getElementById("dashboard-map-container");\n        const iframe = mapContainer?.querySelector("iframe");\n\n        if (!iframe || !iframe.contentWindow) {\n          console.log("\u26A0\uFE0F Iframe del mapa no disponible");\n          return;\n        }\n\n        // Enviar mensaje al iframe\n        iframe.contentWindow.postMessage(\n          {\n            type: "zoom-to-cancha",\n            canchaId: canchaId,\n          },\n          "*",\n        );\n\n        console.log("\u{1F4E4} Mensaje de zoom enviado al mapa:", canchaId);\n      }\n\n      // Manejar acciones de botones\n      async function manejarAccion(e) {\n        if (cargando) return;\n\n        const accion = e.target.dataset.accion;\n        const canchaId = parseInt(e.target.dataset.canchaId);\n\n        // Manejar apertura de modales de RECEPCI\xD3N (solo lectura + bot\xF3n Comenzar)\n        if (accion === "recepcionar-besalco") {\n          abrirModalRecepcionBesalco(canchaId);\n          return;\n        } else if (accion === "recepcionar-linkapsis") {\n          abrirModalRecepcionLinkapsis(canchaId);\n          return;\n        } else if (accion === "recepcionar-llayllay") {\n          abrirModalRecepcionLlayLlay(canchaId);\n          return;\n        }\n\n        // Manejar apertura de modales de VALIDACI\xD3N (formulario completo)\n        else if (accion === "validar-besalco") {\n          abrirModalBesalco(canchaId);\n          return;\n        } else if (accion === "validar-linkapsis") {\n          abrirModalLinkapsis(canchaId);\n          return;\n        } else if (accion === "validar-llayllay") {\n          abrirModalLlayLlay(canchaId);\n          return;\n        }\n\n        // Otros modales\n        else if (accion === "abrir-modal-cierre") {\n          abrirModalCierre(canchaId);\n          return;\n        } else if (accion === "abrir-modal-borrar") {\n          abrirModalBorrar(canchaId);\n          return;\n        } else if (accion === "exportar-pdf") {\n          await exportarPDF(canchaId);\n          return;\n        }\n\n        // Confirmar acci\xF3n de cierre\n        if (accion === "cerrar") {\n          if (!confirm("\xBFConfirmas el cierre de esta cancha?")) {\n            return;\n          }\n        }\n\n        // Pedir observaciones para rechazos (acciones directas legacy)\n        let observaciones = null;\n        if (accion.includes("rechazar")) {\n          const empresaNombre =\n            accion === "rechazar-besalco"\n              ? "Besalco"\n              : accion === "rechazar-linkapsis"\n                ? "Linkapsis"\n                : "LlayLlay";\n          observaciones = prompt(\n            \\`Observaciones del rechazo por \\${empresaNombre}:\\`,\n          );\n          if (observaciones === null) return; // Usuario cancel\xF3\n        }\n\n        try {\n          cargando = true;\n          const textoOriginal = e.target.textContent;\n          e.target.disabled = true;\n          e.target.textContent = "Procesando...";\n\n          const response = await fetch(\\`/api/canchas/\\${canchaId}/action\\`, {\n            method: "POST",\n            headers: {\n              "Content-Type": "application/json",\n            },\n            body: JSON.stringify({ accion, observaciones }),\n          });\n\n          if (!response.ok) {\n            const error = await response.json();\n            throw new Error(error.message || "Error al ejecutar acci\xF3n");\n          }\n\n          await cargarCanchas();\n          mostrarMensaje("Acci\xF3n realizada exitosamente", "success");\n        } catch (error) {\n          console.error("Error en acci\xF3n:", error);\n          mostrarMensaje("Error: " + error.message, "error");\n        } finally {\n          cargando = false;\n        }\n      }\n\n      // Mostrar mensajes\n      function mostrarMensaje(mensaje, tipo) {\n        const div = document.createElement("div");\n        div.className = tipo;\n        div.innerHTML = \\`<strong>\\${tipo === "success" ? "\xC9xito:" : "Error:"}</strong> \\${mensaje}\\`;\n\n        mensajeContainer.appendChild(div);\n\n        setTimeout(() => {\n          div.remove();\n        }, 5000);\n      }\n\n      // === FUNCIONES DE MODALES DE VALIDACI\xD3N ===\n      let canchaIdActual = null;\n\n      // Funci\xF3n para cargar historial de observaciones de una cancha\n      async function cargarHistorialObservaciones(\n        canchaId,\n        historialElementId,\n      ) {\n        try {\n          const response = await fetch(\\`/api/canchas/\\${canchaId}/validaciones\\`);\n          if (!response.ok) {\n            throw new Error("Error al cargar historial");\n          }\n\n          const validaciones = await response.json();\n          const historialElement = document.getElementById(historialElementId);\n          const content = historialElement.querySelector(".historial-content");\n\n          if (validaciones.length === 0) {\n            content.innerHTML =\n              \'<p style="color: #666; font-style: italic; text-align: center; padding: 2rem;">No hay observaciones previas</p>\';\n          } else {\n            content.innerHTML = \\`\n              <div class="historial-timeline">\n                \\${validaciones\n                  .map((val, index) => {\n                    let medicionesHtml = "";\n\n                    if (val.mediciones) {\n                      if (val.mediciones.espesores) {\n                        // Mediciones de Linkapsis (formato anterior)\n                        medicionesHtml = \\`\n                        <div class="medicion-linea">\n                          <span class="medicion-label">\u{1F4CF} Medici\xF3n de Espesor:</span> <strong>\\${val.mediciones.espesores.join(", ")} \\${val.mediciones.unidad || "metros"}</strong>\n                          \\${val.mediciones.promedio ? \\`<br><span style="font-size: 0.95rem; color: #666; margin-left: 1.5rem;">\u{1F4CA} Promedio: <strong>\\${val.mediciones.promedio} \\${val.mediciones.unidad || "metros"}</strong></span>\\` : ""}\n                        </div>\\`;\n                      } else if (val.mediciones.espesor) {\n                        // Nueva medici\xF3n de Linkapsis\n                        medicionesHtml = \\`\n                        <div class="medicion-linea">\n                          <span class="medicion-label">\u{1F4CF} Medici\xF3n de Espesor:</span> <strong>\\${val.mediciones.espesor} \\${val.mediciones.unidad || "metros"}</strong>\n                        </div>\\`;\n                      } else if (val.mediciones.densidad) {\n                        // Mediciones de LlayLlay\n                        medicionesHtml = \\`\n                        <div class="medicion-linea">\n                          <span class="medicion-label">\u2696\uFE0F Medici\xF3n de Densidad:</span> <strong>\\${val.mediciones.densidad} \\${val.mediciones.unidad || "g/cm\xB3"}</strong>\n                        </div>\\`;\n                      }\n                    }\n\n                    const empresaNombre =\n                      val.empresa_validadora?.nombre || "Empresa desconocida";\n                    const empresaClass = empresaNombre\n                      .toLowerCase()\n                      .replace(/\\\\s+/g, "");\n\n                    // Generar separador solo si no es la \xFAltima entrada\n                    const separador =\n                      index < validaciones.length - 1\n                        ? \\`\n                    <div class="separador-empresas">\n                      \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n                    </div>\\`\n                        : "";\n\n                    return \\`\n                    <div class="historial-entry empresa-\\${empresaClass}">\n                      <div class="empresa-nombre">\u{1F3E2} \\${empresaNombre}</div>\n                      <div class="fecha-linea">\n                        <span class="fecha-label">\u{1F4C5} Fecha:</span> \\${new Date(\n                          val.created_at,\n                        ).toLocaleDateString("es-ES", {\n                          weekday: "short",\n                          year: "numeric",\n                          month: "short",\n                          day: "numeric",\n                          hour: "2-digit",\n                          minute: "2-digit",\n                        })}\n                      </div>\n                      <div class="observacion-linea">\n                        <span class="observacion-label">\u{1F4AC} Observaciones:</span> "\\${val.observaciones || "Sin observaciones espec\xEDficas"}"\n                      </div>\n                      \\${medicionesHtml}\n                    </div>\\${separador}\\`;\n                  })\n                  .join("")}\n              </div>\n            \\`;\n          }\n        } catch (error) {\n          console.error("Error al cargar historial:", error);\n          const historialElement = document.getElementById(historialElementId);\n          const content = historialElement.querySelector(".historial-content");\n          content.innerHTML =\n            \'<p style="color: #e74c3c;">Error al cargar historial</p>\';\n        }\n      }\n\n      function abrirModalBesalco(canchaId) {\n        canchaIdActual = canchaId;\n        const modal = document.getElementById("validacion-besalco-modal");\n        const form = document.getElementById("form-validacion-besalco");\n\n        // Limpiar formulario\n        form.reset();\n\n        // Cargar historial de observaciones\n        cargarHistorialObservaciones(canchaId, "historial-besalco");\n\n        // Mostrar modal\n        modal.classList.add("show");\n      }\n\n      function abrirModalLinkapsis(canchaId) {\n        canchaIdActual = canchaId;\n        const modal = document.getElementById("validacion-linkapsis-modal");\n        const form = document.getElementById("form-validacion-linkapsis");\n\n        // Limpiar formulario b\xE1sico\n        form.reset();\n\n        // Limpiar checkboxes espec\xEDficamente\n        document.getElementById("trabajo-corte").checked = false;\n        document.getElementById("trabajo-relleno").checked = false;\n\n        // Verificar si ya existen coordenadas previas de Linkapsis\n        verificarCoordenadasExistentes(canchaId);\n\n        // Cargar historial de observaciones (incluye observaciones de Besalco)\n        cargarHistorialObservaciones(canchaId, "historial-linkapsis");\n\n        // Mostrar modal\n        modal.classList.add("show");\n      }\n\n      async function verificarCoordenadasExistentes(canchaId) {\n        try {\n          const response = await fetch(\\`/api/canchas/\\${canchaId}/validaciones\\`);\n          const validaciones = await response.json();\n\n          console.log("Validaciones obtenidas:", validaciones);\n\n          // Buscar validaciones de Linkapsis (empresa_validadora_id = 3) que tengan coordenadas\n          if (validaciones && validaciones.length > 0) {\n            const validacionLinkapsis = validaciones.find(\n              (v) =>\n                v.empresa_validadora_id === 3 &&\n                v.mediciones &&\n                v.mediciones.coordenadas,\n            );\n\n            if (\n              validacionLinkapsis &&\n              validacionLinkapsis.mediciones &&\n              validacionLinkapsis.mediciones.coordenadas\n            ) {\n              const coordenadas = validacionLinkapsis.mediciones.coordenadas;\n              console.log("Coordenadas existentes encontradas:", coordenadas);\n              console.log(\n                "Validaci\xF3n Linkapsis completa:",\n                validacionLinkapsis,\n              );\n\n              // Pre-llenar los campos con coordenadas existentes\n              const coordMap = {\n                "p1-norte": coordenadas.p1?.norte || "",\n                "p1-este": coordenadas.p1?.este || "",\n                "p1-cota": coordenadas.p1?.cota || "",\n                "p2-norte": coordenadas.p2?.norte || "",\n                "p2-este": coordenadas.p2?.este || "",\n                "p2-cota": coordenadas.p2?.cota || "",\n                "p3-norte": coordenadas.p3?.norte || "",\n                "p3-este": coordenadas.p3?.este || "",\n                "p3-cota": coordenadas.p3?.cota || "",\n                "p4-norte": coordenadas.p4?.norte || "",\n                "p4-este": coordenadas.p4?.este || "",\n                "p4-cota": coordenadas.p4?.cota || "",\n              };\n\n              console.log("Mapa de coordenadas para llenar:", coordMap);\n\n              // Llenar los campos si tienen valores\n              Object.keys(coordMap).forEach((id) => {\n                const input = document.getElementById(id);\n                if (input && coordMap[id]) {\n                  console.log(\n                    \\`Llenando campo \\${id} con valor: \\${coordMap[id]}\\`,\n                  );\n                  input.value = coordMap[id];\n                } else if (input) {\n                  console.log(\n                    \\`Campo \\${id} encontrado pero sin valor para llenar\\`,\n                  );\n                } else {\n                  console.log(\\`Campo \\${id} NO encontrado en el DOM\\`);\n                }\n              });\n\n              // Mantener espesor y checkboxes vac\xEDos para nueva evaluaci\xF3n\n              const espesorInput = document.getElementById("espesor-linkapsis");\n              if (espesorInput) {\n                espesorInput.value = "";\n              }\n\n              // Mantener checkboxes de tipo de trabajo sin marcar para nueva evaluaci\xF3n\n              document.getElementById("trabajo-corte").checked = false;\n              document.getElementById("trabajo-relleno").checked = false;\n            } else {\n              console.log(\n                "No se encontraron validaciones previas de Linkapsis con coordenadas",\n              );\n              console.log("Validaciones disponibles:", validaciones);\n              // No hay coordenadas previas, limpiar todos los campos\n              const coordInputs = [\n                "p1-norte",\n                "p1-este",\n                "p1-cota",\n                "p2-norte",\n                "p2-este",\n                "p2-cota",\n                "p3-norte",\n                "p3-este",\n                "p3-cota",\n                "p4-norte",\n                "p4-este",\n                "p4-cota",\n              ];\n\n              coordInputs.forEach((id) => {\n                const input = document.getElementById(id);\n                if (input) input.value = "";\n              });\n            }\n          }\n        } catch (error) {\n          console.error("Error al verificar coordenadas existentes:", error);\n          // En caso de error, limpiar campos por seguridad\n          const coordInputs = [\n            "p1-norte",\n            "p1-este",\n            "p1-cota",\n            "p2-norte",\n            "p2-este",\n            "p2-cota",\n            "p3-norte",\n            "p3-este",\n            "p3-cota",\n            "p4-norte",\n            "p4-este",\n            "p4-cota",\n          ];\n\n          coordInputs.forEach((id) => {\n            const input = document.getElementById(id);\n            if (input) input.value = "";\n          });\n        }\n      }\n\n      function abrirModalLlayLlay(canchaId) {\n        canchaIdActual = canchaId;\n        const modal = document.getElementById("validacion-llayllay-modal");\n        const form = document.getElementById("form-validacion-llayllay");\n\n        // Limpiar formulario\n        form.reset();\n\n        // Cargar historial de observaciones (incluye Besalco y Linkapsis)\n        cargarHistorialObservaciones(canchaId, "historial-llayllay");\n\n        // Mostrar modal\n        modal.classList.add("show");\n      }\n\n      // ============ MODALES DE RECEPCI\xD3N (solo lectura + bot\xF3n Comenzar) ============\n\n      function abrirModalRecepcionBesalco(canchaId) {\n        canchaIdActual = canchaId;\n        const modal = document.getElementById("recepcion-besalco-modal");\n\n        // Cargar historial de observaciones\n        cargarHistorialObservaciones(canchaId, "historial-recepcion-besalco");\n\n        // Mostrar modal\n        modal.classList.add("show");\n      }\n\n      function abrirModalRecepcionLinkapsis(canchaId) {\n        canchaIdActual = canchaId;\n        const modal = document.getElementById("recepcion-linkapsis-modal");\n\n        // Cargar historial de observaciones\n        cargarHistorialObservaciones(canchaId, "historial-recepcion-linkapsis");\n\n        // Mostrar modal\n        modal.classList.add("show");\n      }\n\n      function abrirModalRecepcionLlayLlay(canchaId) {\n        canchaIdActual = canchaId;\n        const modal = document.getElementById("recepcion-llayllay-modal");\n\n        // Cargar historial de observaciones\n        cargarHistorialObservaciones(canchaId, "historial-recepcion-llayllay");\n\n        // Mostrar modal\n        modal.classList.add("show");\n      }\n\n      // ============ MODALES DE CIERRE Y BORRADO ============\n\n      function abrirModalCierre(canchaId) {\n        canchaIdActual = canchaId;\n        const modal = document.getElementById("cerrar-cancha-modal");\n\n        // Cargar historial completo para revisi\xF3n final\n        cargarHistorialObservaciones(canchaId, "historial-cierre");\n\n        // Mostrar modal\n        modal.classList.add("show");\n      }\n\n      function abrirModalBorrar(canchaId) {\n        canchaIdActual = canchaId;\n        const modal = document.getElementById("borrar-cancha-modal");\n        const inputConfirmacion = document.getElementById(\n          "confirmacion-borrado",\n        );\n        const btnConfirmar = document.getElementById("confirmar-borrado");\n\n        // Limpiar input y deshabilitar bot\xF3n\n        inputConfirmacion.value = "";\n        btnConfirmar.disabled = true;\n\n        // Cargar historial que se eliminar\xE1\n        cargarHistorialObservaciones(canchaId, "historial-borrado");\n\n        // Mostrar modal\n        modal.classList.add("show");\n      }\n\n      // Funci\xF3n para exportar PDF\n      async function exportarPDF(canchaId) {\n        try {\n          cargando = true;\n          mostrarMensaje("Generando PDF...", "info");\n\n          // Abrir la URL de descarga directamente en una nueva ventana\n          const url = \\`/api/canchas/\\${canchaId}/download-pdf\\`;\n          window.open(url, "_blank");\n\n          mostrarMensaje("PDF generado correctamente", "success");\n        } catch (error) {\n          console.error("Error al exportar PDF:", error);\n          mostrarMensaje("Error al generar PDF: " + error.message, "error");\n        } finally {\n          cargando = false;\n        }\n      }\n\n      function cerrarTodosLosModales() {\n        document.querySelectorAll(".modal").forEach((modal) => {\n          modal.classList.remove("show");\n        });\n        canchaIdActual = null;\n      }\n\n      // Cerrar modal al hacer click fuera\n      window.addEventListener("click", (e) => {\n        if (e.target.classList.contains("modal")) {\n          cerrarTodosLosModales();\n        }\n      });\n\n      // Event listeners para botones de cerrar y cancelar\n      // === SISTEMA DE SELECCI\xD3N M\xDALTIPLE ===\n      let selectedCanchas = new Set();\n\n      function initializeSelectionSystem() {\n        const selectAllCheckbox = document.getElementById(\n          "select-all-checkbox",\n        );\n        const bulkActionsBar = document.getElementById("bulk-actions-bar");\n        const btnBulkDelete = document.getElementById("btn-bulk-delete");\n        const btnBulkTimeline = document.getElementById("btn-bulk-timeline");\n        const btnClearSelection = document.getElementById(\n          "btn-clear-selection",\n        );\n\n        // Seleccionar/Deseleccionar todas\n        if (selectAllCheckbox) {\n          selectAllCheckbox.addEventListener("change", (e) => {\n            const checkboxes = document.querySelectorAll(".cancha-checkbox");\n            checkboxes.forEach((checkbox) => {\n              checkbox.checked = e.target.checked;\n              const canchaId = checkbox.dataset.canchaId;\n              if (e.target.checked) {\n                selectedCanchas.add(canchaId);\n                checkbox.closest("tr").classList.add("selected");\n              } else {\n                selectedCanchas.delete(canchaId);\n                checkbox.closest("tr").classList.remove("selected");\n              }\n            });\n            updateBulkActionsBar();\n          });\n        }\n\n        // Limpiar selecci\xF3n\n        if (btnClearSelection) {\n          btnClearSelection.addEventListener("click", clearSelection);\n        }\n\n        // Borrar canchas seleccionadas\n        if (btnBulkDelete) {\n          btnBulkDelete.addEventListener("click", handleBulkDelete);\n        }\n\n        // Ver timeline de canchas seleccionadas\n        if (btnBulkTimeline) {\n          btnBulkTimeline.addEventListener("click", openTimelineModal);\n        }\n      }\n\n      // Manejar click en checkbox individual (se agrega despu\xE9s de renderizar)\n      function attachCheckboxListeners() {\n        document.querySelectorAll(".cancha-checkbox").forEach((checkbox) => {\n          checkbox.addEventListener("change", (e) => {\n            const canchaId = e.target.dataset.canchaId;\n            const row = e.target.closest("tr");\n\n            if (e.target.checked) {\n              selectedCanchas.add(canchaId);\n              row.classList.add("selected");\n            } else {\n              selectedCanchas.delete(canchaId);\n              row.classList.remove("selected");\n              document.getElementById("select-all-checkbox").checked = false;\n            }\n\n            updateBulkActionsBar();\n          });\n        });\n\n        // Prevenir que el click en checkbox dispare el evento de la fila\n        document.querySelectorAll(".cancha-checkbox").forEach((checkbox) => {\n          checkbox.addEventListener("click", (e) => {\n            e.stopPropagation();\n          });\n        });\n      }\n\n      function updateBulkActionsBar() {\n        const bulkActionsBar = document.getElementById("bulk-actions-bar");\n        const selectedCount = document.getElementById("selected-count");\n        const btnBulkDelete = document.getElementById("btn-bulk-delete");\n        const count = selectedCanchas.size;\n\n        if (count > 0) {\n          bulkActionsBar.classList.remove("hidden");\n          selectedCount.textContent = \\`\\${count} cancha\\${count > 1 ? "s" : ""} seleccionada\\${count > 1 ? "s" : ""}\\`;\n\n          // Mostrar bot\xF3n de borrar solo si es AngloAmerican\n          if (empresaLogueada && empresaLogueada.nombre === "AngloAmerican") {\n            btnBulkDelete.classList.remove("hidden");\n          } else {\n            btnBulkDelete.classList.add("hidden");\n          }\n        } else {\n          bulkActionsBar.classList.add("hidden");\n        }\n      }\n\n      function clearSelection() {\n        selectedCanchas.clear();\n        document.querySelectorAll(".cancha-checkbox").forEach((checkbox) => {\n          checkbox.checked = false;\n          checkbox.closest("tr").classList.remove("selected");\n        });\n        document.getElementById("select-all-checkbox").checked = false;\n        updateBulkActionsBar();\n      }\n\n      async function handleBulkDelete() {\n        if (selectedCanchas.size === 0) return;\n\n        const canchaIds = Array.from(selectedCanchas);\n\n        // Si es solo una cancha, usar el modal normal\n        if (canchaIds.length === 1) {\n          abrirModalBorrar(canchaIds[0]);\n          return;\n        }\n\n        // Si son m\xFAltiples canchas, abrir modal adaptado para borrado masivo\n        abrirModalBorradoMasivo(canchaIds);\n      }\n\n      function abrirModalBorradoMasivo(canchaIds) {\n        const modal = document.getElementById("borrar-cancha-modal");\n        const inputConfirmacion = document.getElementById(\n          "confirmacion-borrado",\n        );\n        const btnConfirmar = document.getElementById("confirmar-borrado");\n        const historialDiv = document.getElementById("historial-borrado");\n\n        // Limpiar input y deshabilitar bot\xF3n\n        inputConfirmacion.value = "";\n        btnConfirmar.disabled = true;\n\n        // Mostrar lista de canchas que se borrar\xE1n\n        const canchaNames = canchaIds.map((id) => {\n          const checkbox = document.querySelector(\n            \\`.cancha-checkbox[data-cancha-id="\\${id}"]\\`,\n          );\n          return checkbox ? checkbox.dataset.canchaNombre : \\`ID \\${id}\\`;\n        });\n\n        historialDiv.innerHTML = \\`\n          <h4>\u26A0\uFE0F Se eliminar\xE1n \\${canchaIds.length} canchas:</h4>\n          <div class="historial-content" style="max-height: 200px; overflow-y: auto;">\n            <ul style="margin: 0; padding-left: 1.5rem;">\n              \\${canchaNames.map((name) => \\`<li><strong>\\${name}</strong></li>\\`).join("")}\n            </ul>\n            <p style="margin-top: 1rem; color: #e74c3c; font-weight: 600;">\n              Se eliminar\xE1n todas las validaciones y observaciones asociadas a estas canchas.\n            </p>\n          </div>\n        \\`;\n\n        // Guardar los IDs para el borrado\n        modal.dataset.bulkDeleteIds = JSON.stringify(canchaIds);\n        modal.dataset.isBulkDelete = "true";\n\n        // Mostrar modal\n        modal.classList.add("show");\n      }\n\n      document.addEventListener("DOMContentLoaded", () => {\n        // === SISTEMA DE SELECCI\xD3N M\xDALTIPLE ===\n        initializeSelectionSystem();\n\n        // Botones de cerrar (X)\n        document.querySelectorAll(".close-btn").forEach((btn) => {\n          btn.addEventListener("click", cerrarTodosLosModales);\n        });\n\n        // Botones de cancelar\n        document.querySelectorAll(".btn-cancel").forEach((btn) => {\n          btn.addEventListener("click", cerrarTodosLosModales);\n        });\n\n        // Formularios de validaci\xF3n\n        configurarFormulariosValidacion();\n      });\n\n      function configurarFormulariosValidacion() {\n        // Formulario Besalco\n        const formBesalco = document.getElementById("form-validacion-besalco");\n        if (formBesalco) {\n          formBesalco.addEventListener("submit", procesarValidacionBesalco);\n\n          const btnRechazar = formBesalco.querySelector(".btn-rechazar");\n          if (btnRechazar) {\n            btnRechazar.addEventListener("click", procesarRechazoBesalco);\n          }\n        }\n\n        // Botones de "Comenzar Trabajo" en modales de recepci\xF3n\n        const btnComenzarBesalco = document.getElementById(\n          "btn-comenzar-besalco",\n        );\n        if (btnComenzarBesalco) {\n          btnComenzarBesalco.addEventListener("click", () =>\n            comenzarTrabajo("Besalco"),\n          );\n        }\n\n        const btnComenzarLinkapsis = document.getElementById(\n          "btn-comenzar-linkapsis",\n        );\n        if (btnComenzarLinkapsis) {\n          btnComenzarLinkapsis.addEventListener("click", () =>\n            comenzarTrabajo("Linkapsis"),\n          );\n        }\n\n        const btnComenzarLlayLlay = document.getElementById(\n          "btn-comenzar-llayllay",\n        );\n        if (btnComenzarLlayLlay) {\n          btnComenzarLlayLlay.addEventListener("click", () =>\n            comenzarTrabajo("LlayLlay"),\n          );\n        }\n\n        // Formulario Linkapsis\n        const formLinkapsis = document.getElementById(\n          "form-validacion-linkapsis",\n        );\n        if (formLinkapsis) {\n          formLinkapsis.addEventListener("submit", procesarValidacionLinkapsis);\n\n          const btnRechazar = formLinkapsis.querySelector(".btn-rechazar");\n          if (btnRechazar) {\n            btnRechazar.addEventListener("click", procesarRechazoLinkapsis);\n          }\n        }\n\n        // Formulario LlayLlay\n        const formLlayLlay = document.getElementById(\n          "form-validacion-llayllay",\n        );\n        if (formLlayLlay) {\n          formLlayLlay.addEventListener("submit", procesarValidacionLlayLlay);\n\n          const btnRechazar = formLlayLlay.querySelector(".btn-rechazar");\n          if (btnRechazar) {\n            btnRechazar.addEventListener("click", procesarRechazoLlayLlay);\n          }\n        }\n\n        // Bot\xF3n de cierre definitivo\n        const btnConfirmarCierre = document.getElementById("confirmar-cierre");\n        if (btnConfirmarCierre) {\n          btnConfirmarCierre.addEventListener("click", async () => {\n            if (\n              confirm(\n                "\xBFEst\xE1s seguro de que deseas cerrar esta cancha definitivamente?",\n              )\n            ) {\n              await ejecutarAccion("cerrar_cancha", canchaIdActual, null);\n              cerrarTodosLosModales();\n            }\n          });\n        }\n\n        // Input de confirmaci\xF3n de borrado\n        const inputConfirmacion = document.getElementById(\n          "confirmacion-borrado",\n        );\n        const btnConfirmarBorrado =\n          document.getElementById("confirmar-borrado");\n\n        if (inputConfirmacion && btnConfirmarBorrado) {\n          inputConfirmacion.addEventListener("input", () => {\n            btnConfirmarBorrado.disabled =\n              inputConfirmacion.value.trim() !== "borrar-cancha";\n          });\n\n          btnConfirmarBorrado.addEventListener("click", async () => {\n            const modal = document.getElementById("borrar-cancha-modal");\n            const isBulkDelete = modal.dataset.isBulkDelete === "true";\n\n            if (isBulkDelete) {\n              // Borrado masivo\n              const canchaIds = JSON.parse(modal.dataset.bulkDeleteIds || "[]");\n              await ejecutarBorradoMasivo(canchaIds);\n            } else {\n              // Borrado individual\n              await ejecutarAccion("borrar_cancha", canchaIdActual, null);\n            }\n\n            // Limpiar dataset y cerrar modal\n            delete modal.dataset.isBulkDelete;\n            delete modal.dataset.bulkDeleteIds;\n            cerrarTodosLosModales();\n          });\n        }\n      }\n\n      // === FUNCIONES DE PROCESAMIENTO DE VALIDACIONES ===\n\n      // Funci\xF3n para cambiar estado de "En Espera" a "En Proceso"\n      async function comenzarTrabajo(empresa) {\n        try {\n          if (!canchaIdActual) {\n            mostrarMensaje("No hay cancha seleccionada", "error");\n            return;\n          }\n\n          console.log(\n            \\`Comenzando trabajo para \\${empresa} en cancha \\${canchaIdActual}\\`,\n          );\n\n          // Cambiar estado de En Espera (7) o Rechazada, en Espera (8) \u2192 En Proceso (3)\n          const response = await fetch(\n            \\`/api/canchas/\\${canchaIdActual}/accion\\`,\n            {\n              method: "POST",\n              headers: { "Content-Type": "application/json" },\n              body: JSON.stringify({\n                accion: "tomar_trabajo",\n                empresa: empresa,\n              }),\n            },\n          );\n\n          if (!response.ok) {\n            const errorData = await response.json();\n            throw new Error(errorData.error || "Error al comenzar trabajo");\n          }\n\n          const result = await response.json();\n          console.log("Trabajo iniciado:", result);\n\n          mostrarMensaje(\\`\u2705 Trabajo iniciado para \\${empresa}\\`, "success");\n          cerrarTodosLosModales();\n\n          // Recargar canchas para actualizar la tabla\n          await cargarCanchas();\n        } catch (error) {\n          console.error("Error al comenzar trabajo:", error);\n          mostrarMensaje(\\`Error: \\${error.message}\\`, "error");\n        }\n      }\n\n      async function procesarValidacionBesalco(e) {\n        e.preventDefault();\n\n        const observaciones = document\n          .getElementById("besalco-observaciones")\n          .value.trim();\n        if (!observaciones) {\n          mostrarMensaje("Por favor ingresa observaciones", "error");\n          return;\n        }\n\n        await ejecutarAccion(\n          "finalizar_besalco",\n          canchaIdActual,\n          observaciones,\n        );\n      }\n\n      async function procesarRechazoBesalco(e) {\n        e.preventDefault();\n\n        const observaciones = document\n          .getElementById("besalco-observaciones")\n          .value.trim();\n        if (!observaciones) {\n          mostrarMensaje(\n            "Por favor ingresa observaciones del rechazo",\n            "error",\n          );\n          return;\n        }\n\n        await ejecutarAccion("rechazar_besalco", canchaIdActual, observaciones);\n      }\n\n      async function procesarValidacionLinkapsis(e) {\n        e.preventDefault();\n\n        const observaciones = document\n          .getElementById("linkapsis-observaciones")\n          .value.trim();\n        const espesor = parseFloat(\n          document.getElementById("linkapsis-espesor").value,\n        );\n\n        if (!observaciones || !espesor) {\n          mostrarMensaje(\n            "Por favor completa las observaciones y la medici\xF3n de espesor",\n            "error",\n          );\n          return;\n        }\n\n        // Verificar si es revalidaci\xF3n\n        const isRevalidacion = await esRevalidacion(\n          canchaIdActual,\n          "Linkapsis",\n        );\n\n        // Recopilar tipo de trabajo\n        const tipoTrabajo = [];\n        if (document.getElementById("trabajo-corte").checked) {\n          tipoTrabajo.push("corte");\n        }\n        if (document.getElementById("trabajo-relleno").checked) {\n          tipoTrabajo.push("relleno");\n        }\n\n        // Recopilar coordenadas de los 4 puntos\n        const coordenadas = {\n          p1: {\n            norte:\n              parseFloat(document.getElementById("p1-norte").value) || null,\n            este: parseFloat(document.getElementById("p1-este").value) || null,\n            cota: parseFloat(document.getElementById("p1-cota").value) || null,\n          },\n          p2: {\n            norte:\n              parseFloat(document.getElementById("p2-norte").value) || null,\n            este: parseFloat(document.getElementById("p2-este").value) || null,\n            cota: parseFloat(document.getElementById("p2-cota").value) || null,\n          },\n          p3: {\n            norte:\n              parseFloat(document.getElementById("p3-norte").value) || null,\n            este: parseFloat(document.getElementById("p3-este").value) || null,\n            cota: parseFloat(document.getElementById("p3-cota").value) || null,\n          },\n          p4: {\n            norte:\n              parseFloat(document.getElementById("p4-norte").value) || null,\n            este: parseFloat(document.getElementById("p4-este").value) || null,\n            cota: parseFloat(document.getElementById("p4-cota").value) || null,\n          },\n        };\n\n        const mediciones = {\n          espesor: espesor,\n          unidad: "metros",\n          tipoTrabajo: tipoTrabajo,\n          coordenadas: coordenadas,\n          isRevalidacion: isRevalidacion,\n        };\n\n        await ejecutarAccion(\n          "validar_linkapsis",\n          canchaIdActual,\n          observaciones,\n          mediciones,\n        );\n      }\n\n      async function procesarRechazoLinkapsis(e) {\n        e.preventDefault();\n\n        const observaciones = document\n          .getElementById("linkapsis-observaciones")\n          .value.trim();\n        const espesor = parseFloat(\n          document.getElementById("linkapsis-espesor").value,\n        );\n\n        if (!observaciones) {\n          mostrarMensaje(\n            "Por favor ingresa observaciones del rechazo",\n            "error",\n          );\n          return;\n        }\n\n        // Incluir mediciones aunque sea rechazo\n        let mediciones = null;\n        if (espesor) {\n          // Recopilar tipo de trabajo si est\xE1n marcados\n          const tipoTrabajo = [];\n          if (document.getElementById("trabajo-corte").checked) {\n            tipoTrabajo.push("corte");\n          }\n          if (document.getElementById("trabajo-relleno").checked) {\n            tipoTrabajo.push("relleno");\n          }\n\n          // Recopilar coordenadas si est\xE1n disponibles\n          const coordenadas = {\n            p1: {\n              norte:\n                parseFloat(document.getElementById("p1-norte").value) || null,\n              este:\n                parseFloat(document.getElementById("p1-este").value) || null,\n              cota:\n                parseFloat(document.getElementById("p1-cota").value) || null,\n            },\n            p2: {\n              norte:\n                parseFloat(document.getElementById("p2-norte").value) || null,\n              este:\n                parseFloat(document.getElementById("p2-este").value) || null,\n              cota:\n                parseFloat(document.getElementById("p2-cota").value) || null,\n            },\n            p3: {\n              norte:\n                parseFloat(document.getElementById("p3-norte").value) || null,\n              este:\n                parseFloat(document.getElementById("p3-este").value) || null,\n              cota:\n                parseFloat(document.getElementById("p3-cota").value) || null,\n            },\n            p4: {\n              norte:\n                parseFloat(document.getElementById("p4-norte").value) || null,\n              este:\n                parseFloat(document.getElementById("p4-este").value) || null,\n              cota:\n                parseFloat(document.getElementById("p4-cota").value) || null,\n            },\n          };\n\n          mediciones = {\n            espesor: espesor,\n            unidad: "metros",\n            tipoTrabajo: tipoTrabajo,\n            coordenadas: coordenadas,\n          };\n        }\n\n        await ejecutarAccion(\n          "rechazar_linkapsis",\n          canchaIdActual,\n          observaciones,\n          mediciones,\n        );\n      }\n\n      async function procesarValidacionLlayLlay(e) {\n        e.preventDefault();\n\n        const observaciones = document\n          .getElementById("llayllay-observaciones")\n          .value.trim();\n        const densidad = parseFloat(\n          document.getElementById("llayllay-densidad").value,\n        );\n\n        if (!observaciones || !densidad) {\n          mostrarMensaje(\n            "Por favor completa observaciones y densidad",\n            "error",\n          );\n          return;\n        }\n\n        // Verificar si es revalidaci\xF3n\n        const isRevalidacion = await esRevalidacion(canchaIdActual, "LlayLlay");\n\n        const mediciones = {\n          densidad: densidad,\n          unidad: "g/cm\xB3",\n          isRevalidacion: isRevalidacion,\n        };\n\n        await ejecutarAccion(\n          "validar_llay_llay",\n          canchaIdActual,\n          observaciones,\n          mediciones,\n        );\n      }\n\n      async function procesarRechazoLlayLlay(e) {\n        e.preventDefault();\n\n        const observaciones = document\n          .getElementById("llayllay-observaciones")\n          .value.trim();\n        const densidad = parseFloat(\n          document.getElementById("llayllay-densidad").value,\n        );\n\n        if (!observaciones) {\n          mostrarMensaje(\n            "Por favor ingresa observaciones del rechazo",\n            "error",\n          );\n          return;\n        }\n\n        // Incluir mediciones aunque sea rechazo\n        let mediciones = null;\n        if (densidad) {\n          mediciones = {\n            densidad: densidad,\n            unidad: "g/cm\xB3",\n          };\n        }\n\n        await ejecutarAccion(\n          "rechazar_llay_llay",\n          canchaIdActual,\n          observaciones,\n          mediciones,\n        );\n      }\n\n      // Funci\xF3n auxiliar para determinar si es revalidaci\xF3n\n      async function esRevalidacion(canchaId, empresa) {\n        try {\n          const response = await fetch(\\`/api/canchas/\\${canchaId}\\`);\n          if (!response.ok) return false;\n\n          const data = await response.json();\n          const cancha = data.cancha;\n\n          // Buscar validaciones previas de la misma empresa\n          const validacionesPrevias =\n            cancha.validaciones?.filter(\n              (v) => v.empresa === empresa && v.estado === "VALIDADO",\n            ) || [];\n\n          return validacionesPrevias.length > 0;\n        } catch (error) {\n          console.error("Error al verificar revalidaci\xF3n:", error);\n          return false;\n        }\n      }\n\n      // Funci\xF3n unificada para ejecutar acciones\n      async function ejecutarAccion(\n        accion,\n        canchaId,\n        observaciones,\n        mediciones = null,\n      ) {\n        try {\n          cargando = true;\n\n          const payload = {\n            accion: accion,\n            observaciones: observaciones,\n            usuario: usuarioLogueado, // Incluir informaci\xF3n del usuario actual\n          };\n\n          if (mediciones) {\n            payload.mediciones = mediciones;\n          }\n\n          const response = await fetch(\\`/api/canchas/\\${canchaId}/accion\\`, {\n            method: "POST",\n            headers: {\n              "Content-Type": "application/json",\n            },\n            body: JSON.stringify(payload),\n          });\n\n          if (!response.ok) {\n            throw new Error("Error en la respuesta del servidor");\n          }\n\n          const resultado = await response.json();\n\n          cerrarTodosLosModales();\n          mostrarMensaje(\\`Acci\xF3n completada exitosamente\\`, "success");\n\n          // Recargar canchas para mostrar cambios\n          await cargarCanchas();\n        } catch (error) {\n          console.error("Error al ejecutar acci\xF3n:", error);\n          mostrarMensaje("Error al procesar la acci\xF3n", "error");\n        } finally {\n          cargando = false;\n        }\n      }\n\n      // Funci\xF3n para ejecutar borrado masivo de canchas\n      async function ejecutarBorradoMasivo(canchaIds) {\n        try {\n          cargando = true;\n          let eliminadas = 0;\n          let errores = 0;\n\n          for (const canchaId of canchaIds) {\n            try {\n              // Usar el endpoint de acci\xF3n con borrar_cancha\n              const response = await fetch(\\`/api/canchas/\\${canchaId}/accion\\`, {\n                method: "POST",\n                headers: {\n                  "Content-Type": "application/json",\n                },\n                body: JSON.stringify({\n                  accion: "borrar_cancha",\n                }),\n              });\n\n              if (response.ok) {\n                eliminadas++;\n              } else {\n                errores++;\n                console.error(\\`Error al borrar cancha \\${canchaId}\\`);\n              }\n            } catch (error) {\n              errores++;\n              console.error(\\`Error al borrar cancha \\${canchaId}:\\`, error);\n            }\n          }\n\n          // Limpiar selecci\xF3n\n          clearSelection();\n\n          // Mostrar resultado\n          if (eliminadas > 0) {\n            mostrarMensaje(\n              \\`\u2705 \\${eliminadas} cancha\\${eliminadas > 1 ? "s eliminadas" : " eliminada"} correctamente\\${errores > 0 ? \\`. \\${errores} error\\${errores > 1 ? "es" : ""}\\` : ""}\\`,\n              errores > 0 ? "warning" : "success",\n            );\n          } else {\n            mostrarMensaje("\u274C No se pudo eliminar ninguna cancha", "error");\n          }\n\n          // Recargar canchas\n          await cargarCanchas();\n        } catch (error) {\n          console.error("Error en borrado masivo:", error);\n          mostrarMensaje("Error al borrar las canchas seleccionadas", "error");\n        } finally {\n          cargando = false;\n        }\n      }\n\n      // ========== FUNCIONES DEL TIMELINE ==========\n\n      // Generar color aleatorio vibrante para cada cancha\n      // Generar colores muy distintos entre s\xED usando una paleta predefinida\n      function generateDistinctColors(count) {\n        // Paleta de colores vibrantes y muy diferentes\n        const distinctColors = [\n          "#ef4444", // Rojo vibrante\n          "#3b82f6", // Azul brillante\n          "#10b981", // Verde esmeralda\n          "#f59e0b", // Naranja dorado\n          "#8b5cf6", // P\xFArpura\n          "#ec4899", // Rosa fuerte\n          "#06b6d4", // Cyan\n          "#84cc16", // Lima\n          "#f97316", // Naranja intenso\n          "#6366f1", // \xCDndigo\n          "#14b8a6", // Turquesa\n          "#eab308", // Amarillo\n          "#a855f7", // Violeta\n          "#22c55e", // Verde brillante\n          "#f43f5e", // Rosa rojo\n          "#0ea5e9", // Azul cielo\n        ];\n\n        // Si hay m\xE1s canchas que colores, generar colores adicionales con HSL espaciados\n        if (count > distinctColors.length) {\n          const step = 360 / count;\n          return Array.from({ length: count }, (_, i) => {\n            const hue = Math.floor(i * step);\n            return \\`hsl(\\${hue}, 75%, 55%)\\`;\n          });\n        }\n\n        // Mezclar los colores para que no sigan un patr\xF3n predecible\n        const shuffled = [...distinctColors].sort(() => Math.random() - 0.5);\n        return shuffled.slice(0, count);\n      }\n\n      // Abrir modal de timeline\n      async function openTimelineModal() {\n        if (selectedCanchas.size === 0) {\n          mostrarMensaje(\n            "Selecciona al menos una cancha para ver el timeline",\n            "warning",\n          );\n          return;\n        }\n\n        const modal = document.getElementById("timeline-modal");\n        const legendContainer = document.getElementById("timeline-legend");\n        const eventsContainer = document.getElementById("timeline-events");\n        const modalTitle = modal.querySelector("h3"); // Get title element\n\n        modal.style.display = "flex";\n\n        try {\n          cargando = true;\n\n          // Obtener transiciones de todas las canchas seleccionadas\n          const canchaIds = Array.from(selectedCanchas);\n          const timelineData = await fetchTimelineData(canchaIds);\n\n          // === SMART TITLE LOGIC ===\n          if (timelineData.length > 1) {\n            modalTitle.innerHTML = \\`\n              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>\n              </svg>\n              Timeline Comparativo\n            \\`;\n          } else if (timelineData.length === 1) {\n            modalTitle.innerHTML = \\`\n              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>\n              </svg>\n              Timeline de Transiciones\n            \\`;\n          } else {\n            modalTitle.innerHTML = \\`\n              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>\n              </svg>\n              Timeline\n            \\`;\n          }\n\n          // Generar colores distintos para cada cancha\n          const colors = generateDistinctColors(timelineData.length);\n          const canchaColors = {};\n          timelineData.forEach((data, index) => {\n            canchaColors[data.canchaId] = colors[index];\n          });\n\n          // Renderizar leyenda\n          renderLegend(timelineData, canchaColors, legendContainer);\n\n          // Renderizar timeline\n          renderTimeline(timelineData, canchaColors, eventsContainer);\n\n          // Inicializar checkboxes DESPU\xC9S de renderizar todo\n          if (timelineData.length >= 2) {\n            initializeTimelineCheckboxes();\n          }\n        } catch (error) {\n          console.error("Error cargando timeline:", error);\n          mostrarMensaje("Error al cargar el timeline", "error");\n        } finally {\n          cargando = false;\n        }\n      }\n\n      // Obtener datos de transiciones para m\xFAltiples canchas\n      async function fetchTimelineData(canchaIds) {\n        const promises = canchaIds.map(async (id) => {\n          try {\n            const response = await fetch(\\`/api/canchas/\\${id}/timeline\\`);\n            if (!response.ok) throw new Error("Error al obtener timeline");\n\n            const data = await response.json();\n            const cancha = todasLasCanchas.find((c) => c.id == id);\n\n            return {\n              canchaId: id,\n              canchaName: cancha?.nombre || \\`Cancha \\${id}\\`,\n              transiciones: data.transiciones || [],\n            };\n          } catch (error) {\n            console.error(\\`Error obteniendo timeline de cancha \\${id}:\\`, error);\n            return {\n              canchaId: id,\n              canchaName: \\`Cancha \\${id}\\`,\n              transiciones: [],\n            };\n          }\n        });\n\n        return await Promise.all(promises);\n      }\n\n      // Renderizar leyenda de canchas\n      function renderLegend(timelineData, canchaColors, container) {\n        if (!timelineData || timelineData.length === 0) {\n          container.innerHTML = "";\n          return;\n        }\n\n        const title =\n          timelineData.length === 1\n            ? "Cancha en Timeline"\n            : \\`Canchas en Timeline (\\${timelineData.length})\\`;\n\n        // Mostrar checkboxes solo si hay 2 o m\xE1s canchas\n        const showCheckboxes = timelineData.length >= 2;\n\n        container.innerHTML =\n          \\`<div class="timeline-legend-container">\n            <div class="timeline-legend-title">\n              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <circle cx="12" cy="12" r="10"></circle>\n                <path d="M12 6v6l4 2"></path>\n              </svg>\n              \\${title}\n            </div>\n            <div class="timeline-legend-items">\\` +\n          timelineData\n            .map((data) => {\n              const color = canchaColors[data.canchaId];\n              const displayName = data.canchaName.replace(/_/g, " ");\n              const checkboxHtml = showCheckboxes\n                ? \\`<input type="checkbox" \n                         class="timeline-legend-checkbox" \n                         data-cancha-id="\\${data.canchaId}" \n                         checked \n                         title="Mostrar/ocultar eventos de esta cancha">\\`\n                : "";\n\n              return \\`\n              <div class="timeline-legend-item \\${showCheckboxes ? "with-checkbox" : ""}" \n                   style="color: \\${color};" \n                   data-cancha-id="\\${data.canchaId}">\n                \\${checkboxHtml}\n                <span class="timeline-legend-dot" style="background-color: \\${color};"></span>\n                <span class="timeline-legend-name">\\${displayName}</span>\n              </div>\n            \\`;\n            })\n            .join("") +\n          \\`</div></div>\\`;\n      }\n\n      // Inicializar event listeners de checkboxes del timeline\n      function initializeTimelineCheckboxes() {\n        console.log("\u{1F527} Inicializando checkboxes del timeline...");\n\n        const checkboxes = document.querySelectorAll(\n          ".timeline-legend-checkbox",\n        );\n        console.log(\\`\u{1F4CA} Encontrados \\${checkboxes.length} checkboxes\\`);\n\n        checkboxes.forEach((checkbox, index) => {\n          const canchaId = checkbox.dataset.canchaId;\n          console.log(\n            \\`\u2705 Configurando checkbox \\${index} para cancha ID: \\${canchaId}\\`,\n          );\n\n          checkbox.addEventListener("change", (e) => {\n            const isVisible = e.target.checked;\n            console.log(\n              \\`\u{1F504} Toggle cancha \\${canchaId}: \\${isVisible ? "MOSTRAR" : "OCULTAR"}\\`,\n            );\n            toggleCanchaVisibility(canchaId, isVisible);\n          });\n        });\n      }\n\n      // Toggle visibilidad de eventos de una cancha espec\xEDfica\n      function toggleCanchaVisibility(canchaId, isVisible) {\n        console.log(\n          \\`\u{1F3AF} toggleCanchaVisibility llamado: cancha=\\${canchaId}, visible=\\${isVisible}\\`,\n        );\n\n        const events = document.querySelectorAll(\n          \\`.timeline-event[data-cancha-id="\\${canchaId}"]\\`,\n        );\n        const legendItem = document.querySelector(\n          \\`.timeline-legend-item[data-cancha-id="\\${canchaId}"]\\`,\n        );\n\n        console.log(\n          \\`\u{1F4CD} Encontrados \\${events.length} eventos para cancha \\${canchaId}\\`,\n        );\n        console.log(\\`\u{1F4CD} Legend item encontrado:\\`, legendItem ? "S\xCD" : "NO");\n\n        events.forEach((event) => {\n          if (isVisible) {\n            event.classList.remove("hidden");\n          } else {\n            event.classList.add("hidden");\n          }\n        });\n\n        // Actualizar estilo del item de leyenda\n        if (legendItem) {\n          if (isVisible) {\n            legendItem.classList.remove("dimmed");\n          } else {\n            legendItem.classList.add("dimmed");\n          }\n        }\n\n        console.log(\\`\u2705 Toggle completado para cancha \\${canchaId}\\`);\n      }\n\n      // Renderizar timeline visual\n      function renderTimeline(timelineData, canchaColors, container) {\n        container.innerHTML = "";\n        // Obtener todas las fechas para calcular el rango\n        let allDates = [];\n        let allTransitions = [];\n\n        timelineData.forEach((data) => {\n          data.transiciones.forEach((t) => {\n            allDates.push(new Date(t.fecha_transicion));\n            allTransitions.push({\n              ...t,\n              canchaId: data.canchaId,\n              canchaName: data.canchaName,\n              color: canchaColors[data.canchaId],\n            });\n          });\n        });\n\n        if (allDates.length === 0) {\n          container.innerHTML =\n            \'<p style="text-align: center; padding: 2rem; color: #666;">No hay transiciones para mostrar</p>\';\n          return;\n        }\n\n        // Ordenar transiciones por fecha\n        allTransitions.sort(\n          (a, b) => new Date(a.fecha_transicion) - new Date(b.fecha_transicion),\n        );\n\n        const minDate = new Date(Math.min(...allDates));\n        const maxDate = new Date(Math.max(...allDates));\n        const timeRange = maxDate - minDate || 86400000; // M\xEDnimo 1 d\xEDa\n\n        // Usar el ancho real del contenedor y calcular m\xE1rgenes en porcentaje\n        const totalWidth = container.parentElement.offsetWidth;\n        const marginLeftPercent = 0.02; // 2% a la izquierda\n        const marginRightPercent = 0.05; // 5% a la derecha (m\xE1s espacio para la flecha)\n        const marginLeft = totalWidth * marginLeftPercent;\n        const marginRight = totalWidth * marginRightPercent;\n        const containerWidth = totalWidth - marginLeft - marginRight; // Ancho \xFAtil sin m\xE1rgenes\n        const containerHeight = container.parentElement.offsetHeight;\n        const startX = marginLeft; // Comenzar despu\xE9s del margen izquierdo\n        const centerY = containerHeight / 2;\n\n        // Agrupar eventos por posici\xF3n X para evitar superposici\xF3n\n        const eventsByPosition = {};\n\n        allTransitions.forEach((transicion) => {\n          const eventDate = new Date(transicion.fecha_transicion);\n          const xPosition =\n            startX + ((eventDate - minDate) / timeRange) * containerWidth;\n          const xKey = Math.round(xPosition / 5) * 5; // Agrupar por cada 5px\n\n          if (!eventsByPosition[xKey]) {\n            eventsByPosition[xKey] = [];\n          }\n          eventsByPosition[xKey].push({ transicion, xPosition });\n        });\n\n        // Renderizar cada evento\n        Object.values(eventsByPosition).forEach((events) => {\n          events.forEach((eventData, stackIndex) => {\n            const { transicion, xPosition } = eventData;\n            const eventDate = new Date(transicion.fecha_transicion);\n\n            // Alternar eventos arriba y abajo de la l\xEDnea central\n            const isTop = stackIndex % 2 === 0;\n            const offsetMultiplier = Math.floor(stackIndex / 2) + 1;\n            const baseOffset = 80;\n            const yOffset = baseOffset * offsetMultiplier;\n            const yPosition = isTop ? centerY - yOffset : centerY + yOffset;\n\n            // Crear marcador de evento\n            const eventDiv = document.createElement("div");\n            eventDiv.className = "timeline-event";\n            eventDiv.setAttribute("data-cancha-id", transicion.canchaId);\n            eventDiv.style.position = "absolute";\n            eventDiv.style.left = \\`\\${xPosition}px\\`;\n            eventDiv.style.top = \\`\\${centerY}px\\`;\n            eventDiv.style.width = "0px";\n            eventDiv.style.height = "0px";\n            eventDiv.style.color = transicion.color;\n\n            // L\xEDnea perpendicular desde el eje hasta el punto\n            const line = document.createElement("div");\n            line.className = "timeline-line";\n            line.style.position = "absolute";\n            line.style.backgroundColor = transicion.color;\n            line.style.width = "4px";\n            line.style.left = "50%";\n            line.style.transform = "translateX(-50%)";\n\n            if (isTop) {\n              line.style.height = \\`\\${yOffset}px\\`;\n              line.style.bottom = "0px";\n            } else {\n              line.style.height = \\`\\${yOffset}px\\`;\n              line.style.top = "0px";\n            }\n\n            // Mapeo de nombres amigables para timeline\n            const NOMBRES_ACCIONES_TIMELINE = {\n              // AngloAmerican - Bot\xF3n "CREAR CANCHA"\n              crear_cancha: "Creaci\xF3n de Cancha",\n              crear_cancha_con_poligono: "Creaci\xF3n de Cancha",\n              \n              // AngloAmerican - Bot\xF3n "ENVIAR A BESALCO"\n              enviar_besalco: "Env\xEDo a Besalco",\n              \n              // AngloAmerican - Bot\xF3n "CERRAR CANCHA"\n              cerrar_cancha: "Cierre de Cancha",\n\n              // Besalco - Bot\xF3n "RECEPCIONAR TRABAJO"\n              recepcionar_besalco: "Trabajo recepcionado por Besalco",\n              \n              // Besalco - Bot\xF3n "GESTIONAR" (finalizar y enviar a Linkapsis)\n              finalizar_besalco: "Trabajo finalizado por Besalco",\n              \n              // Besalco - Bot\xF3n "RECHAZAR"\n              rechazar_besalco: "Trabajo rechazado por Besalco",\n\n              // Linkapsis - Bot\xF3n "RECEPCIONAR TRABAJO"\n              recepcionar_linkapsis: "Trabajo recepcionado por Linkapsis",\n              \n              // Linkapsis - Bot\xF3n "GESTIONAR" (validar espesores y enviar a LlayLlay)\n              validar_linkapsis: "Espesores validados por Linkapsis",\n              \n              // Linkapsis - Bot\xF3n "RECHAZAR"\n              rechazar_linkapsis: "Espesores rechazados por Linkapsis",\n\n              // LlayLlay - Bot\xF3n "RECEPCIONAR TRABAJO"\n              recepcionar_llay_llay: "Trabajo recepcionado por LlayLlay",\n              \n              // LlayLlay - Bot\xF3n "GESTIONAR" (validar densidad y enviar a AA)\n              validar_llay_llay: "Densidad validada por LlayLlay",\n              \n              // LlayLlay - Bot\xF3n "RECHAZAR"\n              rechazar_llay_llay: "Densidad rechazada por LlayLlay",\n\n              // Gen\xE9rico - Cualquier bot\xF3n "RECHAZAR"\n              rechazar_cancha: "Cancha rechazada",\n              \n              // Tomar trabajo (si se usa)\n              tomar_trabajo: "Trabajo tomado",\n            };\n\n            const accionRaw = transicion.accion || "Sin acci\xF3n";\n            let accionTexto =\n              NOMBRES_ACCIONES_TIMELINE[accionRaw] ||\n              // Fallback: capitalizar si no est\xE1 en el mapeo\n              accionRaw\n                .replace(/_/g, " ")\n                .replace(/\\\\b\\\\w/g, (l) => l.toUpperCase());\n\n            // Para \'tomar_trabajo\', agregar el nombre de la empresa din\xE1micamente\n            if (accionRaw === "tomar_trabajo" && transicion.empresa_nueva) {\n              accionTexto = \\`Trabajo tomado por \\${transicion.empresa_nueva}\\`;\n            }\n\n            // Mapeo de iniciales de empresas para mostrar en los puntos\n            const INICIALES_EMPRESAS = {\n              AngloAmerican: "AA",\n              Besalco: "BS",\n              Linkapsis: "LK",\n              LlayLlay: "LL",\n            };\n\n            // Colores espec\xEDficos para cada empresa\n            const COLORES_EMPRESAS = {\n              AA: "#3b82f6", // Azul\n              BS: "#06b6d4", // Celeste/Cyan\n              LK: "#f97316", // Naranja\n              LL: "#ef4444", // Rojo\n            };\n\n            // Obtener iniciales de la empresa (usar empresa_nueva como prioridad)\n            const empresaNombre =\n              transicion.empresa_nueva || transicion.empresa_anterior || "";\n            const inicialesEmpresa = INICIALES_EMPRESAS[empresaNombre] || "";\n\n            // Punto en el eje\n            const dot = document.createElement("div");\n            dot.className = "timeline-dot";\n            // Fondo blanco con borde de color de la cancha\n            dot.style.backgroundColor = "#ffffff";\n            dot.style.borderColor = transicion.color;\n            dot.title = \\`\\${transicion.canchaName}\\\\n\\${accionTexto}\\\\n\\${eventDate.toLocaleDateString("es-CL")}\\`;\n\n            // Agregar iniciales de la empresa dentro del punto\n            if (inicialesEmpresa) {\n              dot.textContent = inicialesEmpresa;\n              const colorInicial =\n                COLORES_EMPRESAS[inicialesEmpresa] || "#334155";\n              dot.style.color = colorInicial;\n              dot.style.display = "flex";\n              dot.style.alignItems = "center";\n              dot.style.justifyContent = "center";\n              dot.style.fontSize = "10px";\n              dot.style.fontWeight = "900";\n              dot.style.letterSpacing = "-0.5px";\n            }\n\n            // Etiqueta de la acci\xF3n\n            const label = document.createElement("div");\n            label.className = "timeline-label";\n\n            if (timelineData.length > 1) {\n              // Si hay m\xFAltiples canchas, mostrar nombre corto\n              const nombreCorto =\n                transicion.canchaName.length > 20\n                  ? transicion.canchaName.substring(0, 17) + "..."\n                  : transicion.canchaName;\n              label.innerHTML = \\`<strong style="color: \\${transicion.color};">\\${nombreCorto}</strong><br/>\\${accionTexto}\\`;\n            } else {\n              label.textContent = accionTexto;\n            }\n\n            if (isTop) {\n              label.style.bottom = \\`\\${yOffset + 15}px\\`;\n            } else {\n              label.style.top = \\`\\${yOffset + 15}px\\`;\n            }\n\n            // Etiqueta de FECHA (Nueva implementaci\xF3n)\n            const dateLabel = document.createElement("div");\n            dateLabel.className = "timeline-event-date";\n            dateLabel.textContent = eventDate.toLocaleDateString("es-CL", {\n              day: "2-digit",\n              month: "short",\n            });\n\n            // A\xF1adir elementos al contenedor del evento\n            eventDiv.appendChild(line);\n            eventDiv.appendChild(dot);\n            eventDiv.appendChild(label);\n            eventDiv.appendChild(dateLabel);\n\n            container.appendChild(eventDiv);\n          });\n        });\n\n        // Renderizar marcadores de fecha en el eje\n        renderDateMarkers(\n          minDate,\n          maxDate,\n          containerWidth,\n          startX,\n          centerY,\n          container,\n        );\n      }\n\n      // Funci\xF3n para renderizar marcadores de fecha en el eje del timeline\n      function renderDateMarkers(\n        minDate,\n        maxDate,\n        containerWidth,\n        startX,\n        centerY,\n        container,\n      ) {\n        const rangoTotal = maxDate - minDate;\n        const diasTotales = rangoTotal / (1000 * 60 * 60 * 24);\n\n        // Calcular intervalo \xF3ptimo seg\xFAn el rango de fechas\n        let intervalo;\n        if (diasTotales <= 15)\n          intervalo = 2; // 2 d\xEDas\n        else if (diasTotales <= 30)\n          intervalo = 3; // 3 d\xEDas\n        else intervalo = 5; // 5 d\xEDas\n\n        // Generar marcadores\n        let currentDate = new Date(minDate);\n\n        while (currentDate <= maxDate) {\n          const xPosition =\n            startX + ((currentDate - minDate) / rangoTotal) * containerWidth;\n\n          const marker = document.createElement("div");\n          marker.className = "timeline-date-marker";\n          marker.style.left = \\`\\${xPosition}px\\`;\n          marker.style.top = \\`\\${centerY - 70}px\\`; // Posicionar arriba del eje\n\n          const label = document.createElement("div");\n          label.className = "timeline-date-marker-label";\n          label.textContent = currentDate.toLocaleDateString("es-CL", {\n            day: "numeric",\n            month: "short",\n          });\n\n          const line = document.createElement("div");\n          line.className = "timeline-date-marker-line";\n\n          // Agregar primero la etiqueta, luego la l\xEDnea (para que la l\xEDnea vaya hacia abajo)\n          marker.appendChild(label);\n          marker.appendChild(line);\n          container.appendChild(marker);\n\n          // Avanzar al siguiente marcador\n          currentDate.setDate(currentDate.getDate() + intervalo);\n        }\n      }\n\n      // Cerrar modal de timeline\n      const timelineCloseBtn = document.getElementById("timeline-close-btn");\n      if (timelineCloseBtn) {\n        timelineCloseBtn.addEventListener("click", () => {\n          const modal = document.getElementById("timeline-modal");\n          modal.style.display = "none";\n        });\n      }\n\n      // Funciones para el Modal del Mapa\n      function abrirMapaModal(canchaId, canchaName) {\n        console.log("\u{1F680} abrirMapaModal llamado con:", { canchaId, canchaName });\n\n        const modal = document.getElementById("mapModal");\n        const mapContainer = document.getElementById("mapContainer");\n        const canchaIdSpan = document.getElementById("mapCanchaId");\n        const closeBtn = document.getElementById("mapCloseBtn");\n\n        // Extraer el muro del nombre de la cancha (primera parte antes del primer _)\n        const muro = canchaName ? canchaName.split("_")[0] : null;\n        console.log(\n          \\`\u{1F5FA}\uFE0F Abriendo mapa para cancha \\${canchaId} (\\${canchaName}) - Muro detectado: \\${muro}\\`,\n        );\n\n        // Mostrar ID y nombre de la cancha en el t\xEDtulo\n        canchaIdSpan.textContent = \\`\\${canchaId} (\\${canchaName || "Sin nombre"})\\`;\n\n        // Agregar event listener al bot\xF3n de cerrar\n        closeBtn.addEventListener("click", cerrarMapaModal);\n\n        // Mostrar el modal\n        modal.classList.add("show");\n\n        // Agregar evento para cerrar con Escape\n        document.addEventListener("keydown", handleEscapeKey);\n\n        // Mostrar indicador de carga\n        mapContainer.innerHTML =\n          \'<div class="map-loading">Cargando mapa...</div>\';\n\n        // Cargar el mapa en un iframe con el filtro de muro y cancha ID\n        setTimeout(() => {\n          const iframe = document.createElement("iframe");\n          // Pasar el muro y canchaId como par\xE1metros en la URL\n          let mapUrl = "/mapbox-window";\n          const params = new URLSearchParams();\n\n          if (muro) {\n            params.set("muro", muro);\n          }\n          if (canchaId) {\n            params.set("canchaId", canchaId);\n          }\n\n          if (params.toString()) {\n            mapUrl += "?" + params.toString();\n          }\n\n          console.log("\u{1F310} URL del mapa:", mapUrl);\n          iframe.src = mapUrl;\n          iframe.style.width = "100%";\n          iframe.style.height = "100%";\n          iframe.style.border = "none";\n          iframe.style.borderRadius = "0 0 16px 16px";\n\n          mapContainer.innerHTML = "";\n          mapContainer.appendChild(iframe);\n        }, 300);\n      }\n\n      function cerrarMapaModal() {\n        const modal = document.getElementById("mapModal");\n        const mapContainer = document.getElementById("mapContainer");\n        const closeBtn = document.getElementById("mapCloseBtn");\n\n        modal.classList.remove("show");\n\n        // Remover event listeners\n        document.removeEventListener("keydown", handleEscapeKey);\n        closeBtn.removeEventListener("click", cerrarMapaModal);\n\n        // Limpiar el contenido del mapa\n        setTimeout(() => {\n          mapContainer.innerHTML = "";\n        }, 300);\n      }\n\n      function handleEscapeKey(e) {\n        if (e.key === "Escape") {\n          cerrarMapaModal();\n        }\n      }\n\n      // Cerrar modal al hacer clic fuera del contenido\n      document.addEventListener("click", function (e) {\n        const modal = document.getElementById("mapModal");\n        if (e.target === modal) {\n          cerrarMapaModal();\n        }\n\n        const createModal = document.getElementById("createCanchaModal");\n        if (e.target === createModal) {\n          cerrarModalCrearCancha();\n        }\n      });\n\n      // =====================================================\n      // FUNCIONES PARA CREAR CANCHA CON POL\xCDGONO\n      // =====================================================\n\n      // Variable global para almacenar las coordenadas del pol\xEDgono dibujado\n      let poligonoCoordinadas = null;\n\n      // Funci\xF3n para abrir el modal de crear cancha\n      function abrirModalCrearCancha() {\n        console.log("\u{1F3D7}\uFE0F Abriendo modal de crear cancha...");\n        const modal = document.getElementById("createCanchaModal");\n        const closeBtn = document.getElementById("createCanchaCloseBtn");\n\n        // Resetear formulario\n        document.getElementById("muro-select").value = "";\n        document.getElementById("sector-select").value = "";\n        document.getElementById("nombre-detalle-input").value = "";\n        document.getElementById("open-drawing-btn").disabled = true;\n        document.getElementById("create-cancha-btn").disabled = true;\n        document.getElementById("drawing-status").innerHTML = "";\n        document.getElementById("drawingMapContainer").style.display = "none";\n        poligonoCoordinadas = null;\n\n        // Inicializar estado del selector de sector\n        const sectorSelect = document.getElementById("sector-select");\n        sectorSelect.disabled = true;\n        sectorSelect.innerHTML =\n          \'<option value="">Selecciona un muro primero</option>\';\n\n        // Agregar event listeners\n        closeBtn.addEventListener("click", cerrarModalCrearCancha);\n        document\n          .getElementById("open-drawing-btn")\n          .addEventListener("click", abrirMapaDibujo);\n        document\n          .getElementById("create-cancha-btn")\n          .addEventListener("click", crearCanchaConPoligono);\n\n        // Agregar listeners para validar formulario\n        document\n          .getElementById("muro-select")\n          .addEventListener("change", validarFormularioCreacion);\n        document\n          .getElementById("sector-select")\n          .addEventListener("change", validarFormularioCreacion);\n        document\n          .getElementById("nombre-detalle-input")\n          .addEventListener("input", validarFormularioCreacion);\n\n        modal.classList.add("show");\n\n        // Agregar evento para cerrar con Escape\n        document.addEventListener("keydown", handleEscapeKeyCrear);\n      }\n\n      // Funci\xF3n para cerrar el modal de crear cancha\n      function cerrarModalCrearCancha() {\n        console.log("\u274C Cerrando modal de crear cancha...");\n        const modal = document.getElementById("createCanchaModal");\n        const closeBtn = document.getElementById("createCanchaCloseBtn");\n\n        modal.classList.remove("show");\n\n        // Remover event listeners\n        document.removeEventListener("keydown", handleEscapeKeyCrear);\n        window.removeEventListener("message", handleDrawingMessage);\n        closeBtn.removeEventListener("click", cerrarModalCrearCancha);\n        document\n          .getElementById("open-drawing-btn")\n          .removeEventListener("click", abrirMapaDibujo);\n        document\n          .getElementById("create-cancha-btn")\n          .removeEventListener("click", crearCanchaConPoligono);\n        document\n          .getElementById("muro-select")\n          .removeEventListener("change", validarFormularioCreacion);\n        document\n          .getElementById("sector-select")\n          .removeEventListener("change", validarFormularioCreacion);\n        document\n          .getElementById("nombre-detalle-input")\n          .removeEventListener("input", validarFormularioCreacion);\n\n        // Limpiar el contenido del mapa de dibujo\n        setTimeout(() => {\n          document.getElementById("drawingMapContainer").innerHTML = "";\n        }, 300);\n      }\n\n      // Funci\xF3n para validar el formulario y habilitar botones\n      function validarFormularioCreacion() {\n        const muro = document.getElementById("muro-select").value;\n        const sector = document.getElementById("sector-select").value;\n        const nombreDetalle = document\n          .getElementById("nombre-detalle-input")\n          .value.trim();\n\n        // Solo actualizar opciones de sector si el muro cambi\xF3\n        const sectorSelect = document.getElementById("sector-select");\n        if (sectorSelect.dataset.ultimoMuro !== muro) {\n          actualizarOpcionesSector(muro);\n          sectorSelect.dataset.ultimoMuro = muro;\n        }\n\n        const formularioCompleto = muro && sector && nombreDetalle;\n        document.getElementById("open-drawing-btn").disabled =\n          !formularioCompleto;\n\n        // Solo habilitar crear cancha si tambi\xE9n hay pol\xEDgono dibujado\n        const puedeCrear = formularioCompleto && poligonoCoordinadas;\n        document.getElementById("create-cancha-btn").disabled = !puedeCrear;\n\n        console.log("\u{1F50D} Validaci\xF3n formulario:", {\n          muro,\n          sector,\n          nombreDetalle,\n          formularioCompleto,\n          puedeCrear,\n        });\n      }\n\n      // Funci\xF3n para actualizar las opciones del selector de sector\n      function actualizarOpcionesSector(muro) {\n        const sectorSelect = document.getElementById("sector-select");\n\n        if (!muro) {\n          sectorSelect.disabled = true;\n          sectorSelect.innerHTML =\n            \'<option value="">Selecciona un muro primero</option>\';\n          return;\n        }\n\n        // Guardar la selecci\xF3n actual antes de regenerar\n        const seleccionActual = sectorSelect.value;\n\n        sectorSelect.disabled = false;\n\n        // Determinar el rango de sectores seg\xFAn el muro\n        let maxSector = 3; // Por defecto para MO y ME\n        if (muro === "MP") {\n          maxSector = 7;\n        }\n\n        // Generar opciones din\xE1micamente\n        let opciones = \'<option value="">Selecciona un sector</option>\';\n        for (let i = 1; i <= maxSector; i++) {\n          opciones += \\`<option value="S\\${i}">S\\${i}</option>\\`;\n        }\n\n        sectorSelect.innerHTML = opciones;\n\n        // Restaurar la selecci\xF3n anterior si es v\xE1lida\n        if (seleccionActual && seleccionActual.match(/^S[1-9]$/)) {\n          const numeroSector = parseInt(seleccionActual.substring(1));\n          if (numeroSector <= maxSector) {\n            sectorSelect.value = seleccionActual;\n          }\n        }\n\n        console.log(\n          \\`\u{1F4CD} Muro \\${muro} seleccionado - Sectores disponibles: S1 a S\\${maxSector}\\`,\n        );\n      }\n\n      // Funci\xF3n para abrir el mapa de dibujo\n      function abrirMapaDibujo() {\n        console.log("\u{1F5FA}\uFE0F Abriendo mapa de dibujo...");\n        const muro = document.getElementById("muro-select").value;\n        const drawingContainer = document.getElementById("drawingMapContainer");\n        const statusDiv = document.getElementById("drawing-status");\n\n        // Mostrar status de carga\n        statusDiv.innerHTML = "\u{1F504} Cargando mapa de dibujo...";\n        statusDiv.className = "drawing-status info";\n\n        // Mostrar el contenedor del mapa\n        drawingContainer.style.display = "block";\n\n        // Crear iframe con el mapa de dibujo\n        setTimeout(() => {\n          const iframe = document.createElement("iframe");\n          iframe.src = \\`/mapbox-window?muro=\\${encodeURIComponent(muro)}&drawing=true\\`;\n          iframe.style.width = "100%";\n          iframe.style.height = "100%";\n          iframe.style.border = "none";\n\n          // Limpiar listener anterior si existe\n          window.removeEventListener("message", handleDrawingMessage);\n\n          // Agregar listener para mensajes del iframe\n          window.addEventListener("message", handleDrawingMessage);\n\n          drawingContainer.innerHTML = "";\n          drawingContainer.appendChild(iframe);\n\n          statusDiv.innerHTML = "\u{1F3A8} Herramientas de dibujo activas";\n          statusDiv.className = "drawing-status info";\n        }, 300);\n      }\n\n      // Funci\xF3n para manejar mensajes del iframe de dibujo\n      function handleDrawingMessage(event) {\n        if (event.data.type === "polygon-drawn") {\n          poligonoCoordinadas = event.data.coordinates;\n          console.log("\u2705 Pol\xEDgono recibido del iframe:", poligonoCoordinadas);\n\n          const statusDiv = document.getElementById("drawing-status");\n          statusDiv.innerHTML = \\`\u2705 \xA1\xC1rea dibujada correctamente! (\\${poligonoCoordinadas.length} puntos) Ahora puedes crear la cancha.\\`;\n          statusDiv.className = "drawing-status success";\n\n          // Validar formulario nuevamente para habilitar el bot\xF3n de crear\n          validarFormularioCreacion();\n        } else if (event.data.type === "polygon-deleted") {\n          poligonoCoordinadas = null;\n          console.log("\u{1F5D1}\uFE0F Pol\xEDgono eliminado del iframe");\n\n          const statusDiv = document.getElementById("drawing-status");\n          statusDiv.innerHTML = "\u{1F3A8} Dibuja un nuevo \xE1rea de trabajo en el mapa";\n          statusDiv.className = "drawing-status info";\n\n          // Validar formulario nuevamente para deshabilitar el bot\xF3n de crear\n          validarFormularioCreacion();\n        }\n      }\n\n      // Funci\xF3n para crear la cancha con pol\xEDgono\n      async function crearCanchaConPoligono() {\n        console.log("\u{1F680} Creando cancha con pol\xEDgono...");\n\n        const muro = document.getElementById("muro-select").value;\n        const sector = document.getElementById("sector-select").value;\n        const nombreDetalle = document\n          .getElementById("nombre-detalle-input")\n          .value.trim();\n\n        if (!muro || !sector || !nombreDetalle || !poligonoCoordinadas) {\n          alert(\n            "Por favor completa todos los campos y dibuja el \xE1rea en el mapa",\n          );\n          return;\n        }\n\n        try {\n          // Deshabilitar bot\xF3n mientras se crea\n          document.getElementById("create-cancha-btn").disabled = true;\n          document.getElementById("create-cancha-btn").textContent =\n            "Creando...";\n\n          const response = await fetch("/api/canchas", {\n            method: "POST",\n            headers: {\n              "Content-Type": "application/json",\n            },\n            body: JSON.stringify({\n              muro,\n              sector,\n              nombreDetalle,\n              poligonoCoordinadas,\n            }),\n          });\n\n          if (!response.ok) {\n            throw new Error("Error al crear la cancha");\n          }\n\n          const nuevaCancha = await response.json();\n          console.log("\u2705 Cancha creada exitosamente:", nuevaCancha);\n\n          // Cerrar modal\n          cerrarModalCrearCancha();\n\n          // Recargar la lista de canchas\n          await cargarCanchas();\n\n          // Mostrar mensaje de \xE9xito\n          mostrarMensaje(\n            \\`Cancha \\${nuevaCancha.nombre} creada exitosamente con \xE1rea dibujada\\`,\n            "success",\n          );\n        } catch (error) {\n          console.error("\u274C Error al crear cancha:", error);\n          alert("Error al crear la cancha: " + error.message);\n        } finally {\n          // Restaurar bot\xF3n\n          document.getElementById("create-cancha-btn").disabled = false;\n          document.getElementById("create-cancha-btn").textContent =\n            "Crear Cancha";\n        }\n      }\n\n      // Manejar tecla Escape para cerrar modal de crear cancha\n      function handleEscapeKeyCrear(e) {\n        if (e.key === "Escape") {\n          cerrarModalCrearCancha();\n        }\n      }\n\n      // Inicializar la aplicaci\xF3n\n      inicializar();\n    <\/script> <!-- Modal para Crear Cancha (solo AngloAmerican) --> <div id="createCanchaModal" class="map-modal" data-astro-cid-j7pv25f6> <div class="map-modal-content create-cancha-modal-content" data-astro-cid-j7pv25f6> <div class="map-modal-header" data-astro-cid-j7pv25f6> <h3 class="map-modal-title" data-astro-cid-j7pv25f6>Crear Nueva Cancha</h3> <button id="createCanchaCloseBtn" class="map-close-btn" data-astro-cid-j7pv25f6>&times;</button> </div> <div class="create-cancha-container" data-astro-cid-j7pv25f6> <!-- Panel izquierdo: Formulario --> <div class="create-cancha-form" data-astro-cid-j7pv25f6> <h4 class="form-section-title" data-astro-cid-j7pv25f6>\u{1F4CB} Datos de la Cancha</h4> <div class="form-group" data-astro-cid-j7pv25f6> <label for="muro-select" data-astro-cid-j7pv25f6>Muro:</label> <select id="muro-select" required data-astro-cid-j7pv25f6> <option value="" data-astro-cid-j7pv25f6>Seleccionar Muro</option> <option value="MP" data-astro-cid-j7pv25f6>MP</option> <option value="ME" data-astro-cid-j7pv25f6>ME</option> <option value="MO" data-astro-cid-j7pv25f6>MO</option> </select> </div> <div class="form-group" data-astro-cid-j7pv25f6> <label for="sector-select" data-astro-cid-j7pv25f6>Sector:</label> <select id="sector-select" disabled required data-astro-cid-j7pv25f6> <option value="" data-astro-cid-j7pv25f6>Selecciona un muro primero</option> </select> </div> <div class="form-group" data-astro-cid-j7pv25f6> <label for="nombre-detalle-input" data-astro-cid-j7pv25f6>Nombre Detalle:</label> <input type="text" id="nombre-detalle-input" placeholder="ej: TEST1" required data-astro-cid-j7pv25f6> </div> <div class="form-actions" data-astro-cid-j7pv25f6> <button id="open-drawing-btn" class="btn-primary" disabled data-astro-cid-j7pv25f6>\u{1F5FA}\uFE0F Dibujar \xC1rea en Mapa</button> <button id="create-cancha-btn" class="btn-success" disabled data-astro-cid-j7pv25f6>\u2705 Crear Cancha</button> </div> <div id="drawing-status" class="drawing-status" data-astro-cid-j7pv25f6></div> </div> <!-- Panel derecho: Mapa --> <div class="create-cancha-map-panel" data-astro-cid-j7pv25f6> <div class="map-panel-header" data-astro-cid-j7pv25f6> <h4 class="map-panel-title" data-astro-cid-j7pv25f6>\u{1F5FA}\uFE0F \xC1rea de Trabajo</h4> <p class="map-panel-subtitle" data-astro-cid-j7pv25f6>\nDibuja el pol\xEDgono que define el \xE1rea de la cancha\n</p> </div> <div id="drawingMapContainer" class="drawing-map-container" data-astro-cid-j7pv25f6> <!-- El mapa de dibujo se cargar\xE1 aqu\xED --> </div> </div> </div> </div> </div> <!-- Modal para el Mapa --> <div id="mapModal" class="map-modal" data-astro-cid-j7pv25f6> <div class="map-modal-content" data-astro-cid-j7pv25f6> <div class="map-modal-header" data-astro-cid-j7pv25f6> <h3 class="map-modal-title" data-astro-cid-j7pv25f6>\nVisor de Mapa - Cancha <span id="mapCanchaId" data-astro-cid-j7pv25f6></span> </h3> <button id="mapCloseBtn" class="map-close-btn" data-astro-cid-j7pv25f6>&times;</button> </div> <div id="mapContainer" class="map-container" data-astro-cid-j7pv25f6> <!-- El mapa se cargar\xE1 aqu\xED din\xE1micamente --> </div> </div> </div> ', " "])), renderComponent($$result, "AuthGuard", $$AuthGuard, { "data-astro-cid-j7pv25f6": true }), renderScript($$result, "E:/TITO/1 Astro/canchas-anglo2/src/pages/index.astro?astro&type=script&index=0&lang.ts"), renderScript($$result, "E:/TITO/1 Astro/canchas-anglo2/src/pages/index.astro?astro&type=script&index=1&lang.ts"), maybeRenderHead(), renderScript($$result, "E:/TITO/1 Astro/canchas-anglo2/src/pages/index.astro?astro&type=script&index=2&lang.ts"));
}, "E:/TITO/1 Astro/canchas-anglo2/src/pages/index.astro", void 0);

const $$file = "E:/TITO/1 Astro/canchas-anglo2/src/pages/index.astro";
const $$url = "";

const _page = /*#__PURE__*/Object.freeze(/*#__PURE__*/Object.defineProperty({
  __proto__: null,
  default: $$Index,
  file: $$file,
  url: $$url
}, Symbol.toStringTag, { value: 'Module' }));

const page = () => _page;

export { page };
